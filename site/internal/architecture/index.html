
<!doctype html>
<html lang="en" class="no-js">
  <head>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">




        <link rel="prev" href="../../user/troubleshooting/">


        <link rel="next" href="../testing/TEST_SERVER/">





      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">



        <title>Architecture - Meraki Home Assistant Integration</title>



      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">












        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>



    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>





  </head>


    <body dir="ltr">


    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">


        <a href="#architecture-overview-for-meraki-ha" class="md-skip">
          Skip to content
        </a>

    </div>
    <div data-md-component="announce">

    </div>






<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Meraki Home Assistant Integration" class="md-header__button md-logo" aria-label="Meraki Home Assistant Integration" data-md-component="logo">


  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">

      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Meraki Home Assistant Integration
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">

              Architecture

          </span>
        </div>
      </div>
    </div>


      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>





        <label class="md-header__button md-icon" for="__search">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">

        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>

    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>



  </nav>

</header>

    <div class="md-container" data-md-component="container">






      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">



              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Meraki Home Assistant Integration" class="md-nav__button md-logo" aria-label="Meraki Home Assistant Integration" data-md-component="logo">


  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Meraki Home Assistant Integration
  </label>

  <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">



  <span class="md-ellipsis">


    Home



  </span>



      </a>
    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >


          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">



  <span class="md-ellipsis">


    User Guide



  </span>



            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>


    User Guide


          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../../user/setup/" class="md-nav__link">



  <span class="md-ellipsis">


    Setup



  </span>



      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../user/entities/" class="md-nav__link">



  <span class="md-ellipsis">


    Entities



  </span>



      </a>
    </li>










    <li class="md-nav__item">
      <a href="../../user/troubleshooting/" class="md-nav__link">



  <span class="md-ellipsis">


    Troubleshooting



  </span>



      </a>
    </li>




          </ul>
        </nav>

    </li>
















    <li class="md-nav__item md-nav__item--active md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>


          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">



  <span class="md-ellipsis">


    Developer Guide



  </span>



            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>


    Developer Guide


          </label>
          <ul class="md-nav__list" data-md-scrollfix>









    <li class="md-nav__item md-nav__item--active">

      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">





        <label class="md-nav__link md-nav__link--active" for="__toc">



  <span class="md-ellipsis">


    Architecture



  </span>



          <span class="md-nav__icon md-icon"></span>
        </label>

      <a href="./" class="md-nav__link md-nav__link--active">



  <span class="md-ellipsis">


    Architecture



  </span>



      </a>



<nav class="md-nav md-nav--secondary" aria-label="Table of contents">






    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>

        <li class="md-nav__item">
  <a href="#1-executive-summary" class="md-nav__link">
    <span class="md-ellipsis">

        1. Executive Summary

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#2-core-components" class="md-nav__link">
    <span class="md-ellipsis">

        2. Core Components

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#3-error-handling-and-resiliency" class="md-nav__link">
    <span class="md-ellipsis">

        3. Error Handling and Resiliency

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#4-webhook-implementation-status" class="md-nav__link">
    <span class="md-ellipsis">

        4. Webhook Implementation Status

    </span>
  </a>

</li>

    </ul>

</nav>

    </li>










    <li class="md-nav__item">
      <a href="../testing/TEST_SERVER/" class="md-nav__link">



  <span class="md-ellipsis">


    Testing



  </span>



      </a>
    </li>




          </ul>
        </nav>

    </li>



  </ul>
</nav>
                  </div>
                </div>
              </div>



              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">






    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>

        <li class="md-nav__item">
  <a href="#1-executive-summary" class="md-nav__link">
    <span class="md-ellipsis">

        1. Executive Summary

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#2-core-components" class="md-nav__link">
    <span class="md-ellipsis">

        2. Core Components

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#3-error-handling-and-resiliency" class="md-nav__link">
    <span class="md-ellipsis">

        3. Error Handling and Resiliency

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#4-webhook-implementation-status" class="md-nav__link">
    <span class="md-ellipsis">

        4. Webhook Implementation Status

    </span>
  </a>

</li>

    </ul>

</nav>
                  </div>
                </div>
              </div>



            <div class="md-content" data-md-component="content">

              <article class="md-content__inner md-typeset">





<h1 id="architecture-overview-for-meraki-ha">Architecture Overview for <code>meraki-ha</code></h1>
<h2 id="1-executive-summary">1. Executive Summary</h2>
<p>This document provides an overview of the architecture for the <code>meraki-ha</code> custom component. The integration is designed for performance and scalability, with a focus on efficient data fetching, centralized state management, and modular design.</p>
<p>The key architectural pillars are:</p>
<ul>
<li><strong>Centralized Data Fetching:</strong> A single data coordinator (<code>MerakiDataCoordinator</code>) is responsible for all API communication, eliminating redundant API calls and ensuring data consistency.</li>
<li><strong>Optimized API Usage:</strong> The API client (<code>MerakiAPIClient</code>) leverages concurrent API calls using <code>asyncio.gather</code> to reduce latency and improve responsiveness.</li>
<li><strong>Efficient State Management:</strong> The <code>MerakiDataCoordinator</code> creates lookup tables for devices, networks, and SSIDs after each data fetch. This provides entities with fast, O(1) access to their data, avoiding slow, iterative lookups.</li>
<li><strong>Modular Design:</strong> The codebase is broken down into smaller, more focused modules. The API client uses a facade pattern, delegating calls to endpoint-specific handlers. Utility functions and sensor setup logic have also been modularized.</li>
</ul>
<h2 id="2-core-components">2. Core Components</h2>
<p>**2.1. <code>MerakiDataCoordinator</code></p>
<p>The heart of the integration is the <code>MerakiDataCoordinator</code>, located in <code>custom_components/meraki_ha/core/coordinators/meraki_data_coordinator.py</code>.</p>
<ul>
<li><strong>Responsibilities:</strong></li>
<li>Manages a single, periodic refresh of all data from the Meraki API via the <code>MerakiAPIClient</code>.</li>
<li>Holds the complete state of the integration in its <code>data</code> attribute.</li>
<li>After fetching data, it creates several lookup tables for efficient data retrieval by entities:<ul>
<li><code>devices_by_serial</code>: A dictionary mapping device serial numbers to device data.</li>
<li><code>networks_by_id</code>: A dictionary mapping network IDs to network data.</li>
<li><code>ssids_by_network_and_number</code>: A dictionary mapping a <code>(network_id, ssid_number)</code> tuple to SSID data.</li>
</ul>
</li>
<li><strong>Entity Interaction:</strong> Entities in Home Assistant are subclasses of <code>CoordinatorEntity</code> and are linked to the <code>MerakiDataCoordinator</code>. They should not fetch their own data. Instead, they access the coordinator's <code>data</code> or use the efficient <code>get_device()</code>, <code>get_network()</code>, and <code>get_ssid()</code> methods to retrieve their state. When the coordinator updates its data, it notifies all listening entities, which then update their state via their <code>_handle_coordinator_update()</code> method.</li>
</ul>
<p>**2.2. <code>MerakiAPIClient</code></p>
<p>The <code>MerakiAPIClient</code>, located in <code>custom_components/meraki_ha/core/api/client.py</code>, is responsible for all communication with the Meraki Dashboard API.</p>
<ul>
<li><strong>Design:</strong> It acts as a facade, providing a single entry point for fetching all data (<code>get_all_data</code>). It delegates the actual API calls to smaller, endpoint-specific handler classes located in <code>custom_components/meraki_ha/core/api/endpoints/</code>.</li>
<li><strong>Concurrency:</strong> The client uses <code>asyncio.gather</code> and a semaphore to fetch data from multiple API endpoints concurrently, significantly reducing the total time spent waiting for I/O. This makes the integration feel much more responsive, especially during startup.</li>
</ul>
<p>**2.3. Entity and Sensor Setup</p>
<ul>
<li><strong><code>setup_helpers.py</code>:</strong> The logic for creating all sensor entities is centralized in <code>custom_components/meraki_ha/sensor/setup_helpers.py</code>. This file was refactored from a single large function into several smaller, more manageable helper functions, each responsible for a specific category of sensor (e.g., <code>_setup_device_sensors</code>, <code>_setup_network_sensors</code>).</li>
<li><strong><code>sensor_registry.py</code>:</strong> To ensure type safety and avoid <code>mypy</code> errors, the integration uses a sensor registry (<code>custom_components/meraki_ha/sensor_registry.py</code>). This registry explicitly defines which sensor classes should be created for each Meraki device type and what their constructor arguments are. This avoids the need for dynamic, untyped introspection.</li>
</ul>
<h2 id="3-error-handling-and-resiliency">3. Error Handling and Resiliency</h2>
<p>The integration is designed to be resilient to transient API errors and network issues, providing a stable user experience.</p>
<p>**3.1. Stale Data on Failure</p>
<p>If the <code>MerakiDataCoordinator</code> fails to fetch an update from the Meraki API, it does not immediately mark all entities as unavailable. Instead, it checks the timestamp of the last successful update. If the last successful data is within a configurable threshold (defaulting to 30 minutes), the coordinator will log a warning but continue to provide the existing "stale" data to all entities. This makes the integration resilient to brief network or API outages, preventing the user's dashboard from going blank due to a temporary glitch. This feature can be configured in the integration's options.</p>
<p>**3.2. Partial Data Merging</p>
<p>The <code>MerakiAPIClient</code> fetches data from multiple endpoints concurrently. If one of these sub-requests fails, the integration does not discard all the data from the successful requests. Instead, it will use the data from the last successful coordinator run for the specific slice of data that failed. For example, if fetching VLAN information fails but device statuses succeed, the VLAN sensors will continue to show their previous state, while the device status sensors will show the latest information. This prevents a single, non-critical API failure from causing an entire category of sensors to become unavailable.</p>
<p>**3.3. Persistent Caching</p>
<p>To improve startup times for Home Assistant, the integration uses a persistent disk cache (<code>diskcache</code>). The results of the <code>get_all_data</code> API call are cached on disk with a short TTL (2 minutes). When Home Assistant restarts, the integration can load the cached data almost instantly, making entities available right away while a fresh API call is made in the background.</p>
<h2 id="4-webhook-implementation-status">4. Webhook Implementation Status</h2>
<p>The integration now has a functional webhook implementation for real-time updates. The system can register a webhook with the Meraki API and handle incoming alerts. Currently, it processes alerts for "APs went down" and "Client connectivity changed" to provide near real-time status updates for device and client entities. The framework is in place to easily add handlers for more alert types in the future.</p>













              </article>
            </div>


<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>

      </main>

        <footer class="md-footer">

  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">


    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>

</div>

    </div>
  </div>
</footer>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>





      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>


      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>


  </body>
</html>