
<!doctype html>
<html lang="en" class="no-js">
  <head>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">









      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">



        <title>Design Document - Meraki Home Assistant Integration</title>



      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">












        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>



    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>





  </head>


    <body dir="ltr">


    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">


        <a href="#design-document" class="md-skip">
          Skip to content
        </a>

    </div>
    <div data-md-component="announce">

    </div>






<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Meraki Home Assistant Integration" class="md-header__button md-logo" aria-label="Meraki Home Assistant Integration" data-md-component="logo">


  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">

      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Meraki Home Assistant Integration
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">

              Design Document

          </span>
        </div>
      </div>
    </div>


      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>





        <label class="md-header__button md-icon" for="__search">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">

        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>

    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>



  </nav>

</header>

    <div class="md-container" data-md-component="container">






      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">



              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Meraki Home Assistant Integration" class="md-nav__button md-logo" aria-label="Meraki Home Assistant Integration" data-md-component="logo">


  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Meraki Home Assistant Integration
  </label>

  <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href=".." class="md-nav__link">



  <span class="md-ellipsis">


    Home



  </span>



      </a>
    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >


          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">



  <span class="md-ellipsis">


    User Guide



  </span>



            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>


    User Guide


          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../user/setup/" class="md-nav__link">



  <span class="md-ellipsis">


    Setup



  </span>



      </a>
    </li>










    <li class="md-nav__item">
      <a href="../user/entities/" class="md-nav__link">



  <span class="md-ellipsis">


    Entities



  </span>



      </a>
    </li>










    <li class="md-nav__item">
      <a href="../user/troubleshooting/" class="md-nav__link">



  <span class="md-ellipsis">


    Troubleshooting



  </span>



      </a>
    </li>




          </ul>
        </nav>

    </li>














    <li class="md-nav__item md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >


          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">



  <span class="md-ellipsis">


    Developer Guide



  </span>



            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>


    Developer Guide


          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../internal/architecture/" class="md-nav__link">



  <span class="md-ellipsis">


    Architecture



  </span>



      </a>
    </li>










    <li class="md-nav__item">
      <a href="../internal/testing/TEST_SERVER/" class="md-nav__link">



  <span class="md-ellipsis">


    Testing



  </span>



      </a>
    </li>




          </ul>
        </nav>

    </li>



  </ul>
</nav>
                  </div>
                </div>
              </div>



              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">






    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>

        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">

        Overview

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">

        Architecture

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">

        Error Handling

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#data-flow" class="md-nav__link">
    <span class="md-ellipsis">

        Data Flow

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#coordinators" class="md-nav__link">
    <span class="md-ellipsis">

        Coordinators

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#platforms" class="md-nav__link">
    <span class="md-ellipsis">

        Platforms

    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#code-duplication-and-refactoring-opportunities" class="md-nav__link">
    <span class="md-ellipsis">

        Code Duplication and Refactoring Opportunities

    </span>
  </a>

</li>

    </ul>

</nav>
                  </div>
                </div>
              </div>



            <div class="md-content" data-md-component="content">

              <article class="md-content__inner md-typeset">





<h1 id="design-document">Design Document</h1>
<p>This document outlines the design of the Meraki Home Assistant integration.</p>
<h2 id="overview">Overview</h2>
<p>The Meraki Home Assistant integration allows users to monitor and control their Meraki networks and devices within Home Assistant. The integration is built around a central data update coordinator that fetches data from the Meraki API and distributes it to the various platforms (e.g., sensor, switch, device_tracker).</p>
<h2 id="architecture">Architecture</h2>
<p>The integration is divided into the following components:</p>
<ul>
<li><strong><code>__init__.py</code></strong>: The main entry point for the integration. It sets up the coordinators and platforms.</li>
<li><strong><code>core</code></strong>: A directory containing the core components of the integration, including the API client, coordinators, and entities.</li>
<li><strong><code>api</code></strong>: A wrapper around the Meraki Dashboard API that provides a simplified interface for making API calls. This is implemented in the <code>core/api/client.py</code> file.</li>
<li><strong><code>coordinators</code></strong>: The data update coordinators that fetch data from the Meraki API and manage the state of the integration. These are implemented in the <code>core/coordinators</code> directory.</li>
<li><strong><code>entities</code></strong>: The base classes for the entities in the integration. These are implemented in the <code>core/entities</code> directory.</li>
<li><strong><code>platforms</code></strong>: The platform-specific implementations of the entities, such as sensors, switches, and device trackers.</li>
<li><strong><code>const.py</code></strong>: A file that contains all of the constants used in the integration.</li>
<li><strong><code>AGENTS.md</code></strong>: A file that contains guidelines for agents working on the codebase.</li>
</ul>
<h2 id="error-handling">Error Handling</h2>
<p>The integration uses a centralized error handling strategy to ensure that all errors are handled consistently and that user-friendly error messages are displayed. The <code>@handle_meraki_errors</code> decorator is used to wrap all API calls and to handle any errors that may occur. The decorator logs the errors and raises a more specific exception from the <code>core.errors</code> module. This allows the calling code to handle different types of errors in a more granular way.</p>
<h2 id="data-flow">Data Flow</h2>
<p>The integration uses a hybrid data retrieval strategy that combines polling with webhooks.</p>
<ul>
<li><strong>Polling:</strong> The <code>MerakiDataUpdateCoordinator</code> fetches data from the Meraki API at a regular interval. This is used to get the initial state of the integration and to periodically refresh the data.</li>
<li><strong>Webhooks:</strong> The integration also uses webhooks to receive real-time updates from the Meraki API. This is used to get real-time updates for things like device status and client connectivity.</li>
</ul>
<p>The data flow for the integration is as follows:</p>
<ol>
<li>The <code>MerakiDeviceCoordinator</code> and <code>MerakiNetworkCoordinator</code> fetch data from the Meraki API at a regular interval.</li>
<li>Each coordinator stores its data in its own <code>data</code> attribute.</li>
<li>The platforms (e.g., sensor, switch, device_tracker) access the data from the appropriate coordinator and update their state accordingly.</li>
<li>The integration also receives real-time updates from the Meraki API via webhooks.</li>
<li>The <code>async_handle_webhook</code> function processes the data from the webhook and updates the state of the integration accordingly.</li>
</ol>
<h2 id="coordinators">Coordinators</h2>
<p>The integration uses two coordinators, which are located in the <code>core/coordinators</code> directory:</p>
<ul>
<li><strong><code>MerakiDeviceCoordinator</code></strong>: This coordinator is responsible for fetching data for all physical Meraki devices in the organization. It fetches base device data, and then enhances it with device-specific data like port statuses for switches, uplink information for appliances, and sensor readings for MT sensors. For cameras, it fetches the video settings and the video link for all cameras.</li>
<li><strong><code>MerakiNetworkCoordinator</code></strong>: This coordinator fetches data for all networks, clients, and SSIDs in the organization. It also filters out disabled SSIDs.</li>
</ul>
<h2 id="platforms">Platforms</h2>
<p>The integration provides the following platforms:</p>
<ul>
<li><strong><code>sensor</code></strong>: The sensor platform provides sensors for monitoring the following:</li>
<li>The status of Meraki devices (e.g., online, offline).</li>
<li>The number of clients connected to each routing (MX/GX), wireless (MR/GR), and switch (MS) device.</li>
<li>The number of clients connected to each SSID.</li>
<li>The status of the WAN connection for MX devices.</li>
<li>Data usage for MX appliances.</li>
<li>PoE usage for MS switches.</li>
<li>Port counts (in use/available) for MS switches.</li>
<li>The radio settings for MR devices.</li>
<li>The status of the SSIDs.</li>
<li>The splash page, auth mode, encryption mode, WPA encryption mode, IP assignment mode, band selection, per-client bandwidth limits, per-SSID bandwidth limits, and visibility of the SSIDs.</li>
<li>Environmental readings (temperature, humidity, water detection) for MT sensors.</li>
<li><strong><code>switch</code></strong>: The switch platform provides switches for controlling the following:</li>
<li>The state of the SSIDs (e.g., enabled, disabled).</li>
<li>The broadcast state of the SSIDs.</li>
<li>The state of the camera sense feature for MV cameras.</li>
<li>The state of the audio detection feature for MV cameras.</li>
<li>The state of the RTSP server for MV cameras.</li>
<li><strong><code>device_tracker</code></strong>: The device tracker platform provides device trackers for monitoring the presence of clients on the network.</li>
<li><strong><code>text</code></strong>: The text platform provides text entities for displaying the following:</li>
<li>The name of the SSIDs.</li>
<li>The status of the SSIDs.</li>
</ul>
<h2 id="code-duplication-and-refactoring-opportunities">Code Duplication and Refactoring Opportunities</h2>
<p>**Device Sensor Base Class</p>
<p>The device sensor platforms in <code>custom_components/meraki_ha/sensor/device</code> have a lot of duplicated code. A base class could be created to handle the following:</p>
<ul>
<li><strong><code>__init__</code> method:</strong> The base class could handle the common initialization logic, such as setting the unique ID, name, and icon.</li>
<li><strong><code>device_info</code> property:</strong> The base class could provide a default implementation of the <code>device_info</code> property.</li>
<li><strong><code>_handle_coordinator_update</code> method:</strong> The base class could provide a default implementation of the <code>_handle_coordinator_update</code> method.</li>
<li><strong><code>available</code> property:</strong> The base class could provide a default implementation of the <code>available</code> property.</li>
<li><strong><code>_get_current_device_data</code> method:</strong> The base class could provide a helper method to get the current device data from the coordinator.</li>
</ul>
<p>By creating a base class, we can significantly reduce the amount of duplicated code and make the sensor platforms easier to maintain.</p>













              </article>
            </div>


<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>

      </main>

        <footer class="md-footer">

  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">


    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>

</div>

    </div>
  </div>
</footer>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>





      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>


      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>


  </body>
</html>