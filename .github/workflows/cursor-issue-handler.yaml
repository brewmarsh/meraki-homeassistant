# Cursor Issue Handler
# Triggers when an issue is labeled for Cursor to work on directly
# This bypasses Jules and goes straight to Cursor for the task

name: Cursor Issue Handler

on:
  issues:
    types: [labeled]

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: cursor-issue-${{ github.event.issue.number }}
  cancel-in-progress: true # Cancel duplicate runs

env:
  PYTHON_VERSION: '3.13.2'

jobs:
  # Check if this is a Cursor task
  check-cursor-task:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'cursor-work'
    outputs:
      should_process: ${{ steps.check.outputs.should_process }}
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
    steps:
      - name: Check if issue should be processed
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Check if already in progress
          LABELS=$(gh issue view "$ISSUE_NUM" --repo ${{ github.repository }} --json labels -q '.labels[].name')

          if echo "$LABELS" | grep -q "in-progress"; then
            echo "Issue already in progress, skipping"
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check for existing PR
          EXISTING_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --search "in:body Closes #$ISSUE_NUM OR in:body Fixes #$ISSUE_NUM OR in:body Resolves #$ISSUE_NUM" \
            --json number \
            --jq '.[0].number // empty' 2>/dev/null || echo "")

          if [[ -n "$EXISTING_PR" ]]; then
            echo "PR #$EXISTING_PR already exists for issue #$ISSUE_NUM, skipping"
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_process=true" >> "$GITHUB_OUTPUT"

  # Launch Cursor agent for the task
  launch-cursor:
    needs: check-cursor-task
    if: needs.check-cursor-task.outputs.should_process == 'true'
    runs-on: ubuntu-latest
    # Inherits permissions from workflow level
    steps:
      - name: Update issue labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --remove-label "status: todo" \
            --add-label "in-progress" 2>/dev/null || true

      - name: Comment on issue - Starting
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "## üñ±Ô∏è Cursor Agent Starting

          Cursor is now analyzing this task and will begin working on it.

          **Issue:** #${{ github.event.issue.number }}
          **Title:** ${{ github.event.issue.title }}

          ---
          *Cursor will create a PR when the work is complete.*"

      - name: Launch Cursor agent
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(gh issue view "$ISSUE_NUM" --repo "${{ github.repository }}" --json body -q '.body' || echo "")

          # Build the prompt for Cursor
          PROMPT="You are a coding agent for a Home Assistant integration.

          Task: ${ISSUE_TITLE}
          Issue: #${ISSUE_NUM}

          ${ISSUE_BODY}

          Steps:
          1. Read issue #${ISSUE_NUM} comments for any prior context
          2. Read AGENTS.md for project patterns
          3. Implement the task following existing code patterns
          4. Run ./run_checks.sh - must pass
          5. Update issue: gh issue comment ${ISSUE_NUM} --body 'Done: <what> | Files: <list>'
          6. Create PR with: Fixes #${ISSUE_NUM}

          Constraints: Follow existing code style. All tests must pass."

          # Call Cursor API
          BRANCH_NAME="cursor/${ISSUE_NUM}-task"
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          RESPONSE=$(curl -sS -X POST "https://api.cursor.com/v0/agents" \
            -u "${CURSOR_API_KEY}:" \
            -H "Content-Type: application/json" \
            -d "{
              \"source\": {
                \"repository\": \"https://github.com/${{ github.repository }}\",
                \"ref\": \"beta\"
              },
              \"prompt\": {
                \"text\": ${ESCAPED_PROMPT}
              },
              \"target\": {
                \"branchName\": \"$BRANCH_NAME\",
                \"autoCreatePr\": true
              }
            }")

          echo "Cursor API Response: $RESPONSE"

          # Check for errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "Error launching Cursor agent"
            exit 1
          fi

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [[ -n "$AGENT_ID" ]]; then
            echo "Cursor agent launched with ID: $AGENT_ID"
          fi

      - name: Comment on issue - Agent launched
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "## ‚úÖ Cursor Agent Launched

          Cursor is now working on this issue. A PR will be created when complete.

          **Next Steps:**
          1. Cursor will analyze the codebase
          2. Implement the requested changes
          3. Run quality checks
          4. Create a PR targeting beta

          ---
          *You will be notified when the PR is ready for review.*"

  # Handle errors
  handle-error:
    needs: [check-cursor-task, launch-cursor]
    if: failure()
    runs-on: ubuntu-latest
    # Inherits permissions from workflow level
    steps:
      - name: Comment on issue - Error
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "## ‚ö†Ô∏è Cursor Agent Error

          There was an error launching the Cursor agent for this issue.

          **Possible reasons:**
          - API key configuration issue
          - Rate limiting
          - Temporary service unavailability

          Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          ---
          *You may need to manually trigger the workflow or assign to Jules instead.*"

          # Remove in-progress label on failure
          gh issue edit ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --remove-label "in-progress" \
            --add-label "status: todo" 2>/dev/null || true
