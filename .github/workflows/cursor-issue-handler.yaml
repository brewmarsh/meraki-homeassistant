# Cursor Issue Handler
# Triggers when an issue is labeled for Cursor to work on directly
# This bypasses Jules and goes straight to Cursor for the task

name: Cursor Issue Handler

on:
  issues:
    types: [labeled]

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings â†’ Actions â†’ General â†’ Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: cursor-issue-${{ github.event.issue.number }}
  cancel-in-progress: true # Cancel duplicate runs

env:
  PYTHON_VERSION: '3.13.2'

jobs:
  # Check if this is a Cursor task
  check-cursor-task:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'cursor-work'
    outputs:
      should_process: ${{ steps.check.outputs.should_process }}
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
    steps:
      - name: Check if issue should be processed
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Check if already in progress
          LABELS=$(gh issue view "$ISSUE_NUM" --repo ${{ github.repository }} --json labels -q '.labels[].name')

          if echo "$LABELS" | grep -q "in-progress"; then
            echo "Issue already in progress, skipping"
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check for existing PR
          EXISTING_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --search "in:body Closes #$ISSUE_NUM OR in:body Fixes #$ISSUE_NUM OR in:body Resolves #$ISSUE_NUM" \
            --json number \
            --jq '.[0].number // empty' 2>/dev/null || echo "")

          if [[ -n "$EXISTING_PR" ]]; then
            echo "PR #$EXISTING_PR already exists for issue #$ISSUE_NUM, skipping"
            echo "should_process=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_process=true" >> "$GITHUB_OUTPUT"

  # Launch Cursor agent for the task
  launch-cursor:
    needs: check-cursor-task
    if: needs.check-cursor-task.outputs.should_process == 'true'
    runs-on: ubuntu-latest
    # Inherits permissions from workflow level
    steps:
      - name: Update issue labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --remove-label "status: todo" \
            --add-label "in-progress" 2>/dev/null || true

      - name: Comment on issue - Starting
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "## ğŸ–±ï¸ Cursor Agent Starting

          Cursor is now analyzing this task and will begin working on it.

          **Issue:** #${{ github.event.issue.number }}
          **Title:** ${{ github.event.issue.title }}

          ---
          *Cursor will create a PR when the work is complete.*"

      - name: Launch Cursor agent
        id: launch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(gh issue view "$ISSUE_NUM" --repo "${{ github.repository }}" --json body -q '.body' || echo "")

          # Pass the PAT to Cursor so it can authenticate with GitHub
          GH_PAT_VALUE="${GH_PAT:-}"

          # Build a comprehensive prompt for Cursor with explicit completion checklist
          PROMPT="You are a coding agent for a Home Assistant integration (Cisco Meraki).

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TASK: ${ISSUE_TITLE}
          ISSUE: #${ISSUE_NUM}
          REPO: ${{ github.repository }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          GITHUB AUTHENTICATION:
          If you need to run gh commands (issue comments, PR operations, etc.)
          and get permission errors, set this environment variable first:
          export GH_TOKEN='${GH_PAT_VALUE}'

          Then retry the command. This token has write access to the repository.

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          REQUIREMENTS:
          ${ISSUE_BODY}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          MANDATORY STEPS (Complete ALL before finishing):
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          â–¡ STEP 1: UNDERSTAND THE CODEBASE
            - Read AGENTS.md for project patterns and conventions
            - Read issue #${ISSUE_NUM} comments for any prior context
            - Identify relevant files to modify

          â–¡ STEP 2: IMPLEMENT THE SOLUTION
            - Follow existing code patterns exactly
            - Use the correct logger: MerakiLoggers (see AGENTS.md section 3.2)
            - Add type hints to all functions
            - Use async/await for I/O operations
            - Do NOT add unrelated changes or refactoring

          â–¡ STEP 3: ADD/UPDATE TESTS
            - Add unit tests for any new functionality
            - Ensure bug fixes have regression tests
            - Tests go in tests/ directory mirroring source structure

          â–¡ STEP 4: VERIFY QUALITY (REQUIRED)
            Run: ./run_checks.sh
            This MUST pass with no errors. If it fails:
            - Fix the errors
            - Run again until it passes
            - Do NOT proceed until all checks pass

          â–¡ STEP 5: UPDATE THE ISSUE
            Run this command to report what you did:
            gh issue comment ${ISSUE_NUM} --repo ${{ github.repository }} --body \"## âœ… Cursor Implementation Complete

            ### Changes Made
            <list each file changed and what you did>

            ### Tests Added/Updated
            <list test files>

            ### Verification
            - [x] ./run_checks.sh passes
            - [x] All existing tests still pass
            - [x] New tests cover the changes

            ---
            *PR ready for review*\"

          â–¡ STEP 6: CREATE THE PULL REQUEST
            - PR title should be descriptive (e.g., 'feat(sensor): add temperature sensor')
            - PR body MUST include: Closes #${ISSUE_NUM}
            - Target branch: beta

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CRITICAL CONSTRAINTS:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          âŒ DO NOT:
            - Skip running ./run_checks.sh
            - Create PRs with failing tests
            - Add features not requested in the issue
            - Refactor unrelated code
            - Use requirements.txt (use pyproject.toml)
            - Use logging.getLogger(__name__) (use MerakiLoggers)

          âœ… DO:
            - Complete ALL 6 steps above
            - Update the issue with your progress
            - Create a PR that closes the issue
            - Make the PR ready for human review

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          COMPLETION DEFINITION:
          You are DONE when:
          1. Code changes are complete
          2. Tests are added/updated
          3. ./run_checks.sh passes
          4. Issue #${ISSUE_NUM} has your completion comment
          5. PR is created with 'Closes #${ISSUE_NUM}' in body
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Call Cursor API
          BRANCH_NAME="cursor/${ISSUE_NUM}-task"
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          RESPONSE=$(curl -sS -X POST "https://api.cursor.com/v0/agents" \
            -u "${CURSOR_API_KEY}:" \
            -H "Content-Type: application/json" \
            -d "{
              \"source\": {
                \"repository\": \"https://github.com/${{ github.repository }}\",
                \"ref\": \"beta\"
              },
              \"prompt\": {
                \"text\": ${ESCAPED_PROMPT}
              },
              \"target\": {
                \"branchName\": \"$BRANCH_NAME\",
                \"autoCreatePr\": true
              }
            }")

          echo "Cursor API Response: $RESPONSE"

          # Check for errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            echo "Error launching Cursor agent"
            exit 1
          fi

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [[ -n "$AGENT_ID" ]]; then
            echo "Cursor agent launched with ID: $AGENT_ID"
            echo "agent_id=$AGENT_ID" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on issue - Agent launched
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          AGENT_ID="${{ steps.launch.outputs.agent_id }}"

          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "## âœ… Cursor Agent Launched

          Cursor is now working on this issue.

          **Agent:** [\`$AGENT_ID\`](https://cursor.com/agents?id=$AGENT_ID)
          **Branch:** \`cursor/${{ github.event.issue.number }}-task\`

          **The agent will:**
          1. Read AGENTS.md for project patterns
          2. Implement the requested changes
          3. Add/update tests
          4. Run ./run_checks.sh (must pass)
          5. Comment on this issue with completion details
          6. Create a PR targeting beta

          ---
          *[Track agent progress](https://cursor.com/agents?id=$AGENT_ID)*"

  # Handle errors
  handle-error:
    needs: [check-cursor-task, launch-cursor]
    if: failure()
    runs-on: ubuntu-latest
    # Inherits permissions from workflow level
    steps:
      - name: Comment on issue - Error
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --body "## âš ï¸ Cursor Agent Error

          There was an error launching the Cursor agent for this issue.

          **Possible reasons:**
          - API key configuration issue
          - Rate limiting
          - Temporary service unavailability

          Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          ---
          *You may need to manually trigger the workflow or assign to Jules instead.*"

          # Remove in-progress label on failure
          gh issue edit ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --remove-label "in-progress" \
            --add-label "status: todo" 2>/dev/null || true
