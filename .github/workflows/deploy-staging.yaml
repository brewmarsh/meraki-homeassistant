name: Deploy Beta to Staging (Smoke Test)

on:
  push:
    branches:
      - beta

jobs:
  deploy-to-staging:
    runs-on: [self-hosted, meraki-smoketest]

    env:
      DESTINATION_PATH: '/ha_config/custom_components/meraki_ha'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy files to Staging (rsync)
        shell: bash
        env:
          DEPLOY_PATH: ${{ env.DESTINATION_PATH }}
        run: |
          SourceComponentDir="${GITHUB_WORKSPACE}/custom_components/meraki_ha/"
          DestinationPath="${DEPLOY_PATH}"

          echo "Starting Staging Deployment..."
          echo "Source: ${SourceComponentDir}"
          echo "Destination: ${DestinationPath}"

          # Ensure destination exists
          sudo mkdir -p "${DestinationPath}"

          # Sync files
          sudo rsync -rltpD --inplace --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '*.log' \
            --exclude '__pycache__' \
            --exclude '.DS_Store' \
            "${SourceComponentDir}" "${DestinationPath}"

          echo "Deployment to Staging Complete."

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # FIX 1: Install Python 3.13 first so 'uv --system' has a target
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true

      - name: Full Integration Reset (Delete > Restart > Add)
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_STAGING_URL }}
          HA_TOKEN: ${{ secrets.HA_STAGING_TOKEN }}
          MERAKI_API_KEY: ${{ secrets.MERAKI_API_KEY }}
          MERAKI_ORG_ID: ${{ secrets.MERAKI_ORG_ID }}
        run: |
          echo "Installing dependencies..."
          uv pip install --system aiohttp > /dev/null

          echo "Running Reset Script..."
          # Pass secrets implicitly via env vars defined above
          python3 tests/scripts/reset_integration.py

      - name: Audit Logs for Errors
        shell: bash
        run: |
          echo "Waiting for Meraki HA setup to complete..."
          timeout=300 # 5 minutes
          start_time=$(date +%s)
          while true; do
            if grep -q "Setup of domain meraki_ha took" /ha_config/home-assistant.log; then
              echo "Meraki HA setup complete."
              break
            fi
            current_time=$(date +%s)
            if [ $((current_time - start_time)) -gt $timeout ]; then
              echo "::error::Timeout waiting for Meraki HA setup to complete."
              exit 1
            fi
            sleep 5
          done

          echo "Scanning logs for Meraki errors..."
          if grep -i "ERROR" /ha_config/home-assistant.log | grep "custom_components.meraki_ha"; then
            echo "::error::CRITICAL: Found Meraki errors in the log!"
            grep -i "ERROR" /ha_config/home-assistant.log | grep "custom_components.meraki_ha"
            exit 1
          else
            echo "Logs are clean. Smoke test passed."
          fi
