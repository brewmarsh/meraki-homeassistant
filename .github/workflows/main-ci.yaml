name: Main CI

on:
  pull_request:
    branches: ['main']

env:
  PYTHON_VERSION: '3.13.2'
  NODE_VERSION: '20'

jobs:
  # Fast linting checks
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: 'uv.lock'
      - name: Install linters
        run: uv pip install --system ruff bandit
      - name: Run ruff check
        run: ruff check .
      - name: Run ruff format check
        run: ruff format --check .
      - name: Run bandit
        run: bandit -r custom_components/meraki_ha/ -c pyproject.toml

  # Type checking and security audit
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: 'uv.lock'
      - name: Install dependencies
        run: uv sync --all-extras --frozen
      - name: Cache mypy
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('custom_components/**/*.py', 'tests/**/*.py') }}
          restore-keys: |
            mypy-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-
      - name: Run mypy
        run: uv run mypy custom_components/meraki_ha/ tests/
      - name: Run pip-audit
        run: |
          uv run pip-audit \
            --ignore-vuln PYSEC-2020-49 \
            --ignore-vuln PYSEC-2022-42969 \
            --ignore-vuln GHSA-g7vv-2v7x-gj9p \
            --ignore-vuln GHSA-6mq8-rvhq-8wgg \
            --ignore-vuln GHSA-69f9-5gxw-wvc2 \
            --ignore-vuln GHSA-6jhg-hg63-jvvf \
            --ignore-vuln GHSA-g84x-mcqj-x9qq \
            --ignore-vuln GHSA-fh55-r93g-j68g \
            --ignore-vuln GHSA-54jq-c3m8-4m76 \
            --ignore-vuln GHSA-jj3x-wxrx-4x23 \
            --ignore-vuln GHSA-mqqc-3gqh-h2x8

  # Tests with coverage
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: 'uv.lock'
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: custom_components/meraki_ha/www/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('custom_components/meraki_ha/www/package-lock.json') }}
      - name: Install Python dependencies
        run: uv sync --all-extras --frozen
      - name: Install npm dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        working-directory: custom_components/meraki_ha/www
        run: npm ci
      - name: Get Playwright version
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('playwright'))")
          echo "version=$PLAYWRIGHT_VERSION" >> "$GITHUB_OUTPUT"
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: uv run playwright install --with-deps chromium
      - name: Install Playwright deps (cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: uv run playwright install-deps chromium
      - name: Run tests with coverage
        run: uv run pytest --cov=custom_components.meraki_ha --cov-report=xml tests/
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: liptonj/meraki-homeassistant
          files: ./coverage.xml

  # HA manifest validation
  hassfest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Hassfest validation
        uses: 'home-assistant/actions/hassfest@master'

  # Frontend build check
  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: custom_components/meraki_ha/www/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('custom_components/meraki_ha/www/package-lock.json') }}
      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        working-directory: custom_components/meraki_ha/www
        run: npm ci
      - name: Build frontend
        working-directory: custom_components/meraki_ha/www
        run: npm run build
      - name: Check for uncommitted changes
        if: github.event_name == 'pull_request'
        run: |
          if [[ `git status --porcelain` ]]; then
            echo "Frontend assets are out of date. Please run 'npm run build' and commit."
            git status
            exit 1
          fi
      - name: Commit and push frontend changes
        if: github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add custom_components/meraki_ha/www/
          if ! git diff --staged --quiet; then
            git commit -m "build(frontend): update meraki-panel.js [skip ci]"
            git push
          fi

  # Final gate
  ci-success:
    needs: [lint, type-check, test, hassfest, frontend-build]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "âœ… All CI checks passed!"
