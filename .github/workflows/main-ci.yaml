name: Main CI

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/requirements_dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-
      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements_dev.txt
      - name: Archive venv
        run: tar -czf venv.tar.gz .venv
      - name: Upload venv artifact
        uses: actions/upload-artifact@v5
        with:
          name: venv
          path: venv.tar.gz

  ruff:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Download venv artifact
        uses: actions/download-artifact@v7
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run ruff
        run: |
          .venv/bin/python -m ruff check .
          .venv/bin/python -m ruff format --check .

  mypy:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Download venv artifact
        uses: actions/download-artifact@v7
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run mypy
        run: |
          .venv/bin/python -m mypy custom_components/meraki_ha/ tests/

  bandit:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Download venv artifact
        uses: actions/download-artifact@v7
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run bandit
        run: |
          .venv/bin/python -m bandit -r custom_components/meraki_ha/ -c .bandit.yaml

  pip-audit:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Download venv artifact
        uses: actions/download-artifact@v7
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run pip-audit
        run: |
          .venv/bin/python -m pip_audit --ignore-vuln PYSEC-2020-49 --ignore-vuln PYSEC-2022-42969 --ignore-vuln GHSA-g7vv-2v7x-gj9p

  hassfest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Run Hassfest validation
        uses: 'home-assistant/actions/hassfest@master'

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: custom_components/meraki_ha/www
        run: npm ci
      - name: Build frontend
        working-directory: custom_components/meraki_ha/www
        run: npm run build
      - name: Check for uncommitted changes
        if: github.event_name == 'pull_request'
        run: |
          if [[ `git status --porcelain` ]]; then
            echo "Frontend assets are out of date. Please run 'npm run build' in custom_components/meraki_ha/www and commit the changes."
            git status
            git diff
            exit 1
          fi
      - name: Commit and push frontend changes
        if: github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add custom_components/meraki_ha/www/
          if ! git diff --staged --quiet; then
            git commit -m "build(frontend): update meraki-panel.js [skip ci]"
            git push
          else
            echo "No frontend changes to commit."
          fi

  test:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Download venv artifact
        uses: actions/download-artifact@v7
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install npm dependencies
        working-directory: custom_components/meraki_ha/www
        run: npm ci
      - name: Install Playwright browsers
        run: |
          .venv/bin/python -m playwright install --with-deps
      - name: Run tests
        run: |
          .venv/bin/python -m pytest

  final-check:
    needs: [ruff, mypy, bandit, pip-audit, hassfest, frontend-build, test]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "All necessary CI checks passed successfully!"
