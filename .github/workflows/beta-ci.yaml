name: Beta CI

on:
  push:
    branches: ['beta']
  pull_request:
    branches: ['beta']

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python 3.13
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/requirements_dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-
      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements_dev.txt
      - name: Archive venv
        run: tar -czf venv.tar.gz .venv
      - name: Upload venv artifact
        uses: actions/upload-artifact@v5
        with:
          name: venv
          path: venv.tar.gz

  ruff:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run ruff
        run: |
          source .venv/bin/activate
          ruff check .
          ruff format --check .

  mypy:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run mypy
        run: |
          source .venv/bin/activate
          mypy custom_components/meraki_ha/ tests/

  bandit:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run bandit
        run: |
          source .venv/bin/activate
          bandit -r custom_components/meraki_ha/ -c .bandit.yaml

  pip-audit:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run pip-audit
        run: |
          source .venv/bin/activate
          pip-audit --ignore-vuln PYSEC-2020-49 --ignore-vuln PYSEC-2022-42969 --ignore-vuln GHSA-g7vv-2v7x-gj9p

  pytest:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run tests with coverage
        run: |
          source .venv/bin/activate
          pytest --cov=custom_components.meraki_ha --cov-report=xml tests/
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: brewmarsh/meraki-homeassistant
          files: ./coverage.xml

  validate-hacs:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@v5
      - name: HACS validation
        uses: 'hacs/action@main'
        with:
          category: 'integration'

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        working-directory: custom_components/meraki_ha/www
        run: npm ci
      - name: Build frontend
        working-directory: custom_components/meraki_ha/www
        run: npm run build
      - name: Check for uncommitted changes
        run: |
          if [[ `git status --porcelain` ]]; then
            echo "Frontend assets are out of date. Please run 'npm run build' in custom_components/meraki_ha/www and commit the changes."
            git status
            git diff
            exit 1
          fi
