name: Beta CI

on:
  push:
    branches: ['beta']
  pull_request:
    branches: ['beta']

permissions:
  contents: write # Grant write permissions for the GITHUB_TOKEN for auto-commit
  workflows: write # Grant permission to trigger other workflows

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python 3.13
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ./.venv
          key: ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/requirements_dev.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-
      - name: Install dependencies
        run: |
          python -m venv ./.venv
          source ./.venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements_dev.txt
      - name: Archive venv
        run: tar -czf venv.tar.gz ./.venv
      - name: Upload venv artifact
        uses: actions/upload-artifact@v5
        with:
          name: venv
          path: venv.tar.gz

  ruff:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run ruff
        run: |
          source ./.venv/bin/activate
          ruff check .
          ruff format --check .

  mypy:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run mypy
        run: |
          source ./.venv/bin/activate
          mypy custom_components/meraki_ha/ tests/

  bandit:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run bandit
        run: |
          source ./.venv/bin/activate
          bandit -r custom_components/meraki_ha/ -c .bandit.yaml

  pip-audit:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run pip-audit
        run: |
          source ./.venv/bin/activate
          pip-audit --ignore-vuln PYSEC-2020-49 --ignore-vuln PYSEC-2022-42969 --ignore-vuln GHSA-g7vv-2v7x-gj9p

  pytest:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Download venv artifact
        uses: actions/download-artifact@v6
        with:
          name: venv
      - name: Extract venv
        run: tar -xzf venv.tar.gz
      - name: Run tests with coverage
        run: |
          source ./.venv/bin/activate
          pytest --cov=custom_components.meraki_ha --cov-report=xml tests/
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: brewmarsh/meraki-homeassistant
          files: ./coverage.xml

  hassfest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Run Hassfest validation
        uses: 'home-assistant/actions/hassfest@master'

  final-check:
    needs: [ruff, mypy, bandit, pip-audit, pytest, hassfest, frontend-build]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "All necessary CI checks passed successfully!"

  frontend-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Grant write permissions for the GITHUB_TOKEN
    steps:
      - uses: actions/checkout@v6
      - name: Show manifest.json version
        run: cat custom_components/meraki_ha/manifest.json
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install npm dependencies
        working-directory: custom_components/meraki_ha/www
        run: npm install
      - name: Install dos2unix
        run: sudo apt-get update && sudo apt-get install -y dos2unix
      - name: Convert line endings to LF and remove BOM
        working-directory: custom_components/meraki_ha/www
        run: |
          # Remove BOM (Byte Order Mark) if present, then convert to LF
          sed -i '1s/^\xEF\xBB\xBF//' index.html
          dos2unix index.html
          dos2unix meraki-panel.js
      - name: Build frontend
        working-directory: custom_components/meraki_ha/www
        run: npm run build
      - name: Commit and Push Frontend Changes
        working-directory: custom_components/meraki_ha/www
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          if git diff --exit-code --quiet meraki-panel.js package-lock.json; then
            echo "No changes to frontend assets."
          else
            echo "Frontend assets changed, committing and pushing..."
            git add meraki-panel.js package-lock.json
            git commit -m "chore: Auto-update frontend assets"
            git push
          fi
