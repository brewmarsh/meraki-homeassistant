name: Beta CI

run-name: 'CI: ${{ github.event.pull_request.title }} (#${{ github.event.pull_request.number }})'

# Runs on:
# - PRs targeting beta (Jules PRs, human PRs)
# - Cursor review PRs (cursor-review/* branches targeting Jules branches)
# Does NOT run on PRs targeting main (use main-ci.yaml for that)

on:
  pull_request:
    branches-ignore: ['main'] # Run on all PRs except those targeting main

env:
  PYTHON_VERSION: '3.13.2'
  NODE_VERSION: '20'

jobs:
  # Extract issue number and notify start
  setup:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    outputs:
      issue_number: ${{ steps.extract.outputs.issue_number }}
      is_jules_pr: ${{ steps.extract.outputs.is_jules_pr }}
      is_cursor_pr: ${{ steps.extract.outputs.is_cursor_pr }}
    steps:
      - name: Extract linked issue number
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_HEAD: ${{ github.event.pull_request.head.ref }}
        run: |
          # Check if Jules PR (author is jules or google-labs)
          if [[ "$PR_AUTHOR" == *"jules"* ]] || [[ "$PR_AUTHOR" == *"google-labs"* ]]; then
            echo "is_jules_pr=true" >> "$GITHUB_OUTPUT"
            echo "is_cursor_pr=false" >> "$GITHUB_OUTPUT"
          # Check if Cursor PR (branch starts with cursor-review/)
          elif [[ "$PR_HEAD" == cursor-review/* ]]; then
            echo "is_jules_pr=false" >> "$GITHUB_OUTPUT"
            echo "is_cursor_pr=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_jules_pr=false" >> "$GITHUB_OUTPUT"
            echo "is_cursor_pr=false" >> "$GITHUB_OUTPUT"
          fi

          # Extract issue number from PR body
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves) #[0-9]+' | grep -oE '[0-9]+' | head -1)

          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1)
          fi

          # For Cursor PRs, also check the base branch (Jules branch) for issue number
          if [[ -z "$ISSUE_NUM" ]] && [[ "$PR_HEAD" == cursor-review/* ]]; then
            JULES_BRANCH="${{ github.event.pull_request.base.ref }}"
            ISSUE_NUM=$(echo "$JULES_BRANCH" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          fi

          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"
          echo "Found issue: #$ISSUE_NUM"

      - name: Comment on issue - CI started
        if: steps.extract.outputs.issue_number != '' && (steps.extract.outputs.is_jules_pr == 'true' || steps.extract.outputs.is_cursor_pr == 'true')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.extract.outputs.issue_number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚è≥ CI Running

          **PR**: [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})
          **Commit**: \`${{ github.event.pull_request.head.sha }}\`

          **Checks in progress:**
          - üîç Linting (ruff, bandit)
          - üìù Type checking (mypy)
          - üß™ Tests (pytest)
          - üè† Home Assistant validation (hassfest)
          - üé® Frontend build

          ---
          *[View CI run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

  # Fast linting checks
  lint:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: 'uv.lock'
      - name: Install linters
        run: uv pip install --system ruff bandit
      - name: Run ruff check
        run: ruff check .
      - name: Run ruff format check
        run: ruff format --check .
      - name: Run bandit
        run: bandit -r custom_components/meraki_ha/ -c pyproject.toml

  # Type checking and security audit
  type-check:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: 'uv.lock'
      - name: Install dependencies
        run: uv sync --all-extras --frozen
      - name: Cache mypy
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('custom_components/**/*.py', 'tests/**/*.py') }}
          restore-keys: |
            mypy-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-
      - name: Run mypy
        run: uv run mypy custom_components/meraki_ha/ tests/
      - name: Run pip-audit
        run: |
          uv run pip-audit \
            --ignore-vuln PYSEC-2020-49 \
            --ignore-vuln PYSEC-2022-42969 \
            --ignore-vuln GHSA-g7vv-2v7x-gj9p \
            --ignore-vuln GHSA-6mq8-rvhq-8wgg \
            --ignore-vuln GHSA-69f9-5gxw-wvc2 \
            --ignore-vuln GHSA-6jhg-hg63-jvvf \
            --ignore-vuln GHSA-g84x-mcqj-x9qq \
            --ignore-vuln GHSA-fh55-r93g-j68g \
            --ignore-vuln GHSA-54jq-c3m8-4m76 \
            --ignore-vuln GHSA-jj3x-wxrx-4x23 \
            --ignore-vuln GHSA-mqqc-3gqh-h2x8

  # Tests with coverage
  test:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: 'uv.lock'
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: custom_components/meraki_ha/www/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('custom_components/meraki_ha/www/package-lock.json') }}
      - name: Install Python dependencies
        run: uv sync --all-extras --frozen
      - name: Install npm dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        working-directory: custom_components/meraki_ha/www
        run: npm ci
      - name: Get Playwright version
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('playwright'))")
          echo "version=$PLAYWRIGHT_VERSION" >> "$GITHUB_OUTPUT"
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            playwright-${{ runner.os }}-
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: uv run playwright install --with-deps chromium
      - name: Install Playwright deps (cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: uv run playwright install-deps chromium
      - name: Run tests with coverage
        run: uv run pytest --cov=custom_components.meraki_ha --cov-report=xml tests/
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: liptonj/meraki-homeassistant
          files: ./coverage.xml

  # HA manifest validation
  hassfest:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Hassfest validation
        uses: 'home-assistant/actions/hassfest@master'

  # Frontend build check
  frontend-build:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: custom_components/meraki_ha/www/node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('custom_components/meraki_ha/www/package-lock.json') }}
      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        working-directory: custom_components/meraki_ha/www
        run: npm ci
      - name: Build frontend
        working-directory: custom_components/meraki_ha/www
        run: npm run build
      - name: Check for uncommitted changes
        if: github.event_name == 'pull_request'
        run: |
          if [[ `git status --porcelain` ]]; then
            echo "Frontend assets are out of date. Please run 'npm run build' and commit."
            git status
            exit 1
          fi
      - name: Commit and push frontend changes
        if: github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add custom_components/meraki_ha/www/
          if ! git diff --staged --quiet; then
            git commit -m "build(frontend): update meraki-panel.js [skip ci]"
            git push
          fi

  # Final gate - notify success
  ci-success:
    needs: [setup, lint, type-check, test, hassfest, frontend-build]
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: All checks passed
        run: echo "‚úÖ All CI checks passed!"

      - name: Comment on issue - CI passed
        if: needs.setup.outputs.issue_number != '' && (needs.setup.outputs.is_jules_pr == 'true' || needs.setup.outputs.is_cursor_pr == 'true')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ needs.setup.outputs.issue_number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚úÖ CI Passed

          **All quality checks passed!**

          | Check | Status |
          |-------|--------|
          | Linting (ruff, bandit) | ‚úÖ Passed |
          | Type checking (mypy) | ‚úÖ Passed |
          | Tests (pytest) | ‚úÖ Passed |
          | Home Assistant (hassfest) | ‚úÖ Passed |
          | Frontend build | ‚úÖ Passed |

          **Next Step:** ü§ñ Cursor will now review the code for quality and requirements.

          ---
          *[View CI run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

  # Notify on failure
  ci-failure:
    needs: [setup, lint, type-check, test, hassfest, frontend-build]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Determine failed jobs
        id: failed
        run: |
          FAILED_JOBS=""
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS- ‚ùå Linting\n"
          else
            FAILED_JOBS="$FAILED_JOBS- ‚úÖ Linting\n"
          fi
          if [[ "${{ needs.type-check.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS- ‚ùå Type checking\n"
          else
            FAILED_JOBS="$FAILED_JOBS- ‚úÖ Type checking\n"
          fi
          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS- ‚ùå Tests\n"
          else
            FAILED_JOBS="$FAILED_JOBS- ‚úÖ Tests\n"
          fi
          if [[ "${{ needs.hassfest.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS- ‚ùå Hassfest\n"
          else
            FAILED_JOBS="$FAILED_JOBS- ‚úÖ Hassfest\n"
          fi
          if [[ "${{ needs.frontend-build.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS- ‚ùå Frontend build\n"
          else
            FAILED_JOBS="$FAILED_JOBS- ‚úÖ Frontend build\n"
          fi
          echo "jobs<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$FAILED_JOBS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Comment on issue - CI failed
        if: needs.setup.outputs.issue_number != '' && (needs.setup.outputs.is_jules_pr == 'true' || needs.setup.outputs.is_cursor_pr == 'true')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ needs.setup.outputs.issue_number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚ùå CI Failed

          **Some quality checks failed.**

          **Check Results:**
          ${{ steps.failed.outputs.jobs }}

          **Next Step:** ü§ñ Jules Self-Healing CI will attempt to fix the failures automatically.

          ---
          *[View CI logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
