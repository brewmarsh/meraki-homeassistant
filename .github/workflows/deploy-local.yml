name: Deploy via HACS

on:
  push:
    branches:
      - beta
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-via-hacs:
    # Runs on GitHub-hosted cloud runner (no self-hosted needed!)
    runs-on: ubuntu-latest
    # Only run if HA secrets are configured
    if: ${{ vars.ENABLE_HACS_DEPLOY == 'true' }}
    
    steps:
      - name: Wait for release to be available
        run: |
          echo "Waiting 30 seconds for GitHub release to propagate..."
          sleep 30

      - name: Refresh HACS repositories
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
        run: |
          echo "Refreshing HACS repository data..."
          CLEAN_TOKEN=$(echo -n "$HA_TOKEN" | tr -d '\n\r')
          
          # Call hacs.reload to refresh all repositories
          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $CLEAN_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            "$HA_URL/api/services/hacs/reload")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 300 ]]; then
            echo "HACS repositories refreshed successfully."
          else
            echo "Warning: HACS reload returned HTTP $HTTP_CODE (may not be critical)"
          fi
          
          # Wait for HACS to process
          sleep 10

      - name: Trigger HACS update for Meraki integration
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
        run: |
          echo "Triggering update for Meraki HA integration..."
          CLEAN_TOKEN=$(echo -n "$HA_TOKEN" | tr -d '\n\r')
          
          # The update entity ID follows the pattern: update.{integration_name}_update
          # Try common entity ID patterns
          for ENTITY_ID in "update.meraki_ha_update" "update.meraki_homeassistant_update" "update.hacs_meraki_ha"; do
            echo "Trying entity: $ENTITY_ID"
            
            RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer $CLEAN_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"entity_id\": \"$ENTITY_ID\"}" \
              "$HA_URL/api/services/update/install")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 300 ]]; then
              echo "Update triggered successfully for $ENTITY_ID!"
              break
            else
              echo "Entity $ENTITY_ID not found or update failed (HTTP $HTTP_CODE)"
            fi
          done

      - name: Clear Home Assistant Frontend Cache
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
        run: |
          echo "Clearing Home Assistant frontend cache..."
          CLEAN_HA_TOKEN=$(echo -n "$HA_TOKEN" | tr -d '\n\r')
          API_STATUS=$(curl -sS -o /dev/null -w "%{http_code}" -X POST \
              -H "Authorization: Bearer $CLEAN_HA_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{}" \
              "$HA_URL/api/services/frontend/reload_themes")
          if [[ "$API_STATUS" -ne 200 ]]; then
              echo "Warning: Failed to clear frontend cache. HTTP status code: $API_STATUS."
          else
              echo "Home Assistant frontend cache cleared."
          fi
      - name: Restart Home Assistant
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
        run: |
          echo "Attempting to restart Home Assistant..."

          # Sanitize the Home Assistant token to remove any trailing newlines or whitespace.
          CLEAN_HA_TOKEN=$(echo -n "$HA_TOKEN" | tr -d '\n\r')

          # Step 1a: Basic Connectivity Test
          echo "Testing basic connectivity to Home Assistant..."
          API_STATUS=$(curl -sS -o /dev/null -w "%{http_code}" -X GET \
              -H "Authorization: Bearer $CLEAN_HA_TOKEN" \
              -H "Content-Type: application/json" \
              "$HA_URL/api/")

          if [[ "$API_STATUS" -ne 200 ]]; then
              echo "Error: Could not connect to the Home Assistant API. HTTP status code: $API_STATUS."
              echo "Please verify that the HA_URL secret is set correctly and that your Home Assistant instance is running."
              echo "Attempted URL: $HA_URL/api/"
              exit 1
          else
              echo "Connectivity test passed."
          fi

          # Step 1b: Check Configuration
          echo "Checking Home Assistant configuration..."
          BODY_FILE=$(mktemp) # Create a temporary file to store the response body.

          # Make the API call and capture the HTTP status code.
          HTTP_STATUS=$(curl -sS -o "$BODY_FILE" -w "%{http_code}" -X POST \
              -H "Authorization: Bearer $CLEAN_HA_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{}" \
              "$HA_URL/api/config/core/check_config")

          CHECK_RESULT=$(cat "$BODY_FILE")
          rm "$BODY_FILE" # Clean up the temporary file.

          # Check for non-2xx status codes (e.g., 404 Not Found, 401 Unauthorized).
          if [[ "$HTTP_STATUS" -lt 200 || "$HTTP_STATUS" -ge 300 ]]; then
              echo "Error: API call to check config failed with HTTP status code $HTTP_STATUS."
              if [[ "$HTTP_STATUS" -eq 404 ]]; then
                  echo "A 404 error here often means the 'config' integration is not enabled in your Home Assistant's configuration.yaml."
              fi
              echo "Please check that the HA_URL secret is correct and the server is reachable."
              echo "URL: $HA_URL/api/config/core/check_config"
              echo "Response: $CHECK_RESULT"
              exit 1
          fi

          # Verify that the successful response is valid JSON before trying to parse it.
          if ! echo "$CHECK_RESULT" | grep -q '^{'; then
            echo "Error: API response with status $HTTP_STATUS does not appear to be valid JSON."
            echo "Received response:"
            echo "$CHECK_RESULT"
            exit 1
          fi

          ERRORS=$(echo "$CHECK_RESULT" | jq -r '.errors')

          if [ "$ERRORS" != "null" ] && [ "$ERRORS" != "" ]; then
            echo "Config check failed! Errors:"
            echo "$CHECK_RESULT" | jq
            exit 1 # Stop the pipeline
          else
            echo "Config check passed."
          fi

          # Step 1b: Trigger Restart
          echo "Triggering Home Assistant restart..."
          RESTART_RESPONSE_FILE=$(mktemp)
          RESTART_STATUS=$(curl -sS -o "$RESTART_RESPONSE_FILE" -w "%{http_code}" -X POST \
              -H "Authorization: Bearer $CLEAN_HA_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{}" \
              "$HA_URL/api/services/homeassistant/restart")
          RESTART_RESPONSE=$(cat "$RESTART_RESPONSE_FILE")
          rm "$RESTART_RESPONSE_FILE"

          if [[ "$RESTART_STATUS" -lt 200 || "$RESTART_STATUS" -ge 300 ]]; then
              echo "Error: API call to restart failed with HTTP status code $RESTART_STATUS."
              echo "Response: $RESTART_RESPONSE"
              exit 1
          fi

          echo "Home Assistant restart command sent. Waiting for it to come back online..."
          # Add a sleep to allow Home Assistant to restart
          sleep 60 # Wait for 60 seconds. Adjust as needed.
