name: Deploy Latest Code to Local Folder on Linux Runner

on:
  push:
    branches:
      - main
      - beta

jobs:
  deploy-to-linux-folder:
    runs-on: self-hosted

    env:
      DESTINATION_PATH: '/ha_config/custom_components/meraki_ha'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Copy files to destination folder (rsync)
        shell: bash
        env:
          DEPLOY_PATH: ${{ env.DESTINATION_PATH }}
        run: |
          SourceComponentDir="${GITHUB_WORKSPACE}/custom_components/meraki_ha/"
          DestinationPath="${DEPLOY_PATH}"

          echo "Starting deployment..."
          echo "Source path: ${SourceComponentDir}"
          echo "Destination path: ${DestinationPath}"

          sudo mkdir -p "${DestinationPath}"

          # Preserving your specific rsync flags and excludes exactly as they are
          sudo rsync -rltpD --inplace --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '*.log' \
            --exclude 'docker-runner' \
            --exclude 'custom_components' \
            "${SourceComponentDir}" "${DestinationPath}"

          echo "Successfully copied latest code to ${DestinationPath}."

      - name: Restart Home Assistant
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
          # REPLACE with your actual phone entity name from HA
          NOTIFY_SERVICE: 'mobile_app_your_phone_name'
        run: |
          echo "Attempting to restart Home Assistant..."

          # 1. SANITIZE TOKEN (Fixes the 'Missing expected CR' error)
          CLEAN_TOKEN=$(echo "$HA_TOKEN" | tr -d '\r\n ')

          # 2. Check Configuration
          echo "Checking Home Assistant configuration..."
          RAW_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               "$HA_URL/api/config/core/check_config")

          HTTP_STATUS=$(echo "$RAW_RESPONSE" | tail -n1)
          BODY=$(echo "$RAW_RESPONSE" | sed '$d')

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "FAILED: Home Assistant API returned HTTP $HTTP_STATUS"
            echo "Response details: $BODY"
            exit 1
          fi

          ERRORS=$(echo "$BODY" | jq -r '.errors // empty')
          if [ "$ERRORS" != "" ] && [ "$ERRORS" != "null" ]; then
            echo "Config check failed! Errors detected in Home Assistant:"
            echo "$BODY" | jq .
            exit 1
          else
            echo "Config check passed."
          fi

          # 3. Trigger Restart (Hardened for 2026.1 API standards)
          echo "Triggering Home Assistant restart..."
          # Using -d '' and Content-Length: 0 is the most robust way to trigger a parameterless POST service
          RESTART_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               -H "Content-Length: 0" \
               -d '' \
               "$HA_URL/api/services/home_assistant/restart")

          RESTART_STATUS=$(echo "$RESTART_RESPONSE" | tail -n1)

          if [ "$RESTART_STATUS" -ne 200 ]; then
            echo "FAILED to restart! HTTP $RESTART_STATUS"
            echo "Response: $(echo "$RESTART_RESPONSE" | sed '$d')"
            exit 1
          fi

          echo "Home Assistant restart command sent. Sending notification..."

          # 4. Send Success Notification
          curl -s -X POST -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               -d "{\"title\": \"Meraki HA Deployed\", \"message\": \"Configuration check passed and restart initiated successfully.\"}" \
               "$HA_URL/api/services/notify/$NOTIFY_SERVICE"

          echo "Waiting 60s for reboot..."
          sleep 60
