name: Deploy Main to Production (Local)

on:
  push:
    branches:
      - main
      # REMOVED: - beta (Moved to deploy-staging.yaml)

jobs:
  deploy-to-prod:
    # UPDATED: Specific label to avoid picking up the staging runner
    runs-on: [self-hosted, meraki-prod]

    env:
      DESTINATION_PATH: '/ha_config/custom_components/meraki_ha'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy files to Production (rsync)
        shell: bash
        env:
          DEPLOY_PATH: ${{ env.DESTINATION_PATH }}
        run: |
          SourceComponentDir="${GITHUB_WORKSPACE}/custom_components/meraki_ha/"
          DestinationPath="${DEPLOY_PATH}"

          echo "Starting Production Deployment..."
          sudo mkdir -p "${DestinationPath}"

          sudo rsync -rltpD --inplace --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '*.log' \
            --exclude 'docker-runner' \
            --exclude 'custom_components' \
            "${SourceComponentDir}" "${DestinationPath}"

          echo "Production Deployment Complete."

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Restart Production Home Assistant
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
        run: |
          echo "Restarting Production HA..."
          CLEAN_HA_TOKEN=$(echo -n "$HA_TOKEN" | tr -d '\n\r')

          # Check Config
          curl -s -f -X POST \
            -H "Authorization: Bearer $CLEAN_HA_TOKEN" \
            "$HA_URL/api/config/core/check_config" || exit 1

          # Restart
          curl -X POST \
            -H "Authorization: Bearer $CLEAN_HA_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{}' \
            "$HA_URL/api/services/homeassistant/restart"
