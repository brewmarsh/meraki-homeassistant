name: Deploy Latest Code to Local Folder on Linux Runner

# This workflow will run on 'push' events to the specified branches.
on:
  push:
    branches:
      - main
      - beta # Trigger deployment on pushes/merges to the beta branch

jobs:
  deploy-to-linux-folder:
    # This job runs on the self-hosted runner.
    runs-on: self-hosted

    # Define environment variables
    env:
      # This is the path inside your runner container, mapping to the Host OS config.
      DESTINATION_PATH: '/ha_config/custom_components/meraki_ha'

    steps:
      - name: Checkout repository
        # Checks out your repository code into $GITHUB_WORKSPACE.
        uses: actions/checkout@v5

      - name: Copy files to destination folder (rsync)
        # Use 'bash' and 'sudo rsync' to bypass symlink and permission issues.
        shell: bash
        env:
          DEPLOY_PATH: ${{ env.DESTINATION_PATH }}
        run: |
          # The source directory containing ONLY the component files (with trailing slash)
          SourceComponentDir="${GITHUB_WORKSPACE}/custom_components/meraki_ha/"
          DestinationPath="${DEPLOY_PATH}"

          echo "Starting deployment..."
          echo "Source path: ${SourceComponentDir}"
          echo "Destination path: ${DestinationPath}"

          # 1. Create the destination directory if it doesn't exist
          # Use sudo to elevate permissions for file system operations.
          # The -p flag prevents an error if the directory already exists.
          sudo mkdir -p "${DestinationPath}"

          # 2. Copy files using rsync for robustness
          # rsync -ah --delete: 
          #   -a: archive mode (preserves permissions, timestamps, etc.)
          #   -h: human-readable output
          #   --delete: removes files from destination that aren't in source (ensures clean state)

          # CRITICAL: Exclude development files/symlinks to avoid 'Operation not supported' errors.
          sudo rsync -rltpD --inplace --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '*.log' \
            --exclude 'docker-runner' \
            --exclude 'custom_components' \
            "${SourceComponentDir}" "${DestinationPath}"

          echo "Successfully copied latest code to ${DestinationPath}."
          echo "Deployment complete."

      - name: Restart Home Assistant
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
        run: |
          echo "Attempting to restart Home Assistant..."

          # Step 1a: Check Configuration
          echo "Checking Home Assistant configuration..."
          CHECK_RESULT=$(curl -X POST -H "Authorization: Bearer $HA_TOKEN" \
               -H "Content-Type: application/json" \
               "$HA_URL/api/config/core/check_config")

          ERRORS=$(echo "$CHECK_RESULT" | jq -r '.errors')

          if [ "$ERRORS" != "null" ] && [ "$ERRORS" != "" ]; then
            echo "Config check failed! Errors:"
            echo "$CHECK_RESULT" | jq
            exit 1 # Stop the pipeline
          else
            echo "Config check passed."
          fi

          # Step 1b: Trigger Restart
          echo "Triggering Home Assistant restart..."
          curl -X POST -H "Authorization: Bearer $HA_TOKEN" \
               -H "Content-Type: application/json" \
               "$HA_URL/api/services/home_assistant/restart"

          echo "Home Assistant restart command sent. Waiting for it to come back online..."
          # Add a sleep to allow Home Assistant to restart
          sleep 60 # Wait for 60 seconds. Adjust as needed.
