name: Deploy Latest Code to Local Folder on Linux Runner

<<<<<<< HEAD
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
# This workflow will run on 'push' events to the specified branches.
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
# This workflow will run on 'push' events to the specified branches.
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
on:
  push:
    branches:
      - main
<<<<<<< HEAD
<<<<<<< HEAD
      - beta
=======
<<<<<<< HEAD
      - beta

jobs:
  deploy-to-linux-folder:
    runs-on: self-hosted

    env:
=======
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
      - beta # Trigger deployment on pushes/merges to the beta branch
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)

jobs:
  deploy-to-linux-folder:
    runs-on: self-hosted

    env:
<<<<<<< HEAD
=======
      # This is the path inside your runner container, mapping to the Host OS config.
<<<<<<< HEAD
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
      DESTINATION_PATH: '/ha_config/custom_components/meraki_ha'

    steps:
      - name: Checkout repository
<<<<<<< HEAD
<<<<<<< HEAD
        uses: actions/checkout@v5

      - name: Copy files to destination folder (rsync)
=======
<<<<<<< HEAD
        uses: actions/checkout@v5

      - name: Copy files to destination folder (rsync)
=======
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
        # Checks out your repository code into $GITHUB_WORKSPACE.
        uses: actions/checkout@v5

      - name: Copy files to destination folder (rsync)
        # Use 'bash' and 'sudo rsync' to bypass symlink and permission issues.
<<<<<<< HEAD
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
        shell: bash
        env:
          DEPLOY_PATH: ${{ env.DESTINATION_PATH }}
        run: |
<<<<<<< HEAD
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
          # The source directory containing ONLY the component files (with trailing slash)
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
          # The source directory containing ONLY the component files (with trailing slash)
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
          SourceComponentDir="${GITHUB_WORKSPACE}/custom_components/meraki_ha/"
          DestinationPath="${DEPLOY_PATH}"

          echo "Starting deployment..."
<<<<<<< HEAD
<<<<<<< HEAD
          sudo mkdir -p "${DestinationPath}"

          # Preserving your specific rsync flags and excludes
=======
<<<<<<< HEAD
          sudo mkdir -p "${DestinationPath}"

          # Preserving your specific rsync flags and excludes
=======
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
          echo "Source path: ${SourceComponentDir}"
          echo "Destination path: ${DestinationPath}"

          # 1. Create the destination directory if it doesn't exist
          # Use sudo to elevate permissions for file system operations.
          # The -p flag prevents an error if the directory already exists.
          sudo mkdir -p "${DestinationPath}"

          # 2. Copy files using rsync for robustness
          # rsync -ah --delete: 
          #   -a: archive mode (preserves permissions, timestamps, etc.)
          #   -h: human-readable output
          #   --delete: removes files from destination that aren't in source (ensures clean state)

          # CRITICAL: Exclude development files/symlinks to avoid 'Operation not supported' errors.
<<<<<<< HEAD
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
          sudo rsync -rltpD --inplace --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '*.log' \
            --exclude 'docker-runner' \
            --exclude 'custom_components' \
            "${SourceComponentDir}" "${DestinationPath}"

          echo "Successfully copied latest code to ${DestinationPath}."
<<<<<<< HEAD
<<<<<<< HEAD
=======
<<<<<<< HEAD
=======
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
          echo "Deployment complete."

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
<<<<<<< HEAD
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)

      - name: Restart Home Assistant
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
<<<<<<< HEAD
<<<<<<< HEAD
          # REPLACE with your actual phone entity name from HA
          NOTIFY_SERVICE: 'mobile_app_your_phone_name'
=======
<<<<<<< HEAD
          # REPLACE with your actual phone entity name from HA
          NOTIFY_SERVICE: 'mobile_app_your_phone_name'
        run: |
          echo "Attempting to restart Home Assistant..."

          # 1. SANITIZE TOKEN
          CLEAN_TOKEN=$(echo "$HA_TOKEN" | tr -d '\r\n ')

          # 2. Check Configuration
          echo "Checking Home Assistant configuration..."
          RAW_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               "$HA_URL/api/config/core/check_config")

          HTTP_STATUS=$(echo "$RAW_RESPONSE" | tail -n1)
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "FAILED: Home Assistant API returned HTTP $HTTP_STATUS"
            echo "Response details: $(echo "$RAW_RESPONSE" | sed '$d')"
            exit 1
          fi

          echo "Config check passed. Triggering restart..."

          # 3. Trigger Restart with Fallback
          RESTART_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               --data-raw '{}' \
               "$HA_URL/api/services/home_assistant/restart")

          RESTART_STATUS=$(echo "$RESTART_RESPONSE" | tail -n1)

          if [ "$RESTART_STATUS" -ne 200 ]; then
             echo "Standard restart failed (HTTP $RESTART_STATUS). Trying Hassio host reboot..."
             RESTART_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               --data-raw '{}' \
               "$HA_URL/api/services/hassio/host_reboot")
             RESTART_STATUS=$(echo "$RESTART_RESPONSE" | tail -n1)
          fi

          if [ "$RESTART_STATUS" -ne 200 ] && [ "$RESTART_STATUS" -ne 201 ]; then
            echo "FAILED to restart! HTTP $RESTART_STATUS"
            exit 1
          fi

          # 4. Send Success Notification
          curl -s -X POST -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               -d "{\"title\": \"Meraki HA Deployed\", \"message\": \"Deploy finished and restart initiated.\"}" \
               "$HA_URL/api/services/notify/$NOTIFY_SERVICE"

          echo "Home Assistant is rebooting..."

      - name: Post-Deploy Health Audit
=======
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
        run: |
          echo "Attempting to restart Home Assistant..."

          # 1. SANITIZE TOKEN
          CLEAN_TOKEN=$(echo "$HA_TOKEN" | tr -d '\r\n ')

          # 2. Check Configuration
          echo "Checking Home Assistant configuration..."
          RAW_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               "$HA_URL/api/config/core/check_config")

          HTTP_STATUS=$(echo "$RAW_RESPONSE" | tail -n1)
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "FAILED: Home Assistant API returned HTTP $HTTP_STATUS"
            echo "Response details: $(echo "$RAW_RESPONSE" | sed '$d')"
            exit 1
          fi

          echo "Config check passed. Triggering restart..."

          # 3. Trigger Restart with Fallback
          RESTART_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               --data-raw '{}' \
               "$HA_URL/api/services/home_assistant/restart")

          RESTART_STATUS=$(echo "$RESTART_RESPONSE" | tail -n1)

          if [ "$RESTART_STATUS" -ne 200 ]; then
             echo "Standard restart failed (HTTP $RESTART_STATUS). Trying Hassio host reboot..."
             RESTART_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
               -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               --data-raw '{}' \
               "$HA_URL/api/services/hassio/host_reboot")
             RESTART_STATUS=$(echo "$RESTART_RESPONSE" | tail -n1)
          fi

          if [ "$RESTART_STATUS" -ne 200 ] && [ "$RESTART_STATUS" -ne 201 ]; then
            echo "FAILED to restart! HTTP $RESTART_STATUS"
            exit 1
          fi

<<<<<<< HEAD
          # 4. Send Success Notification
          curl -s -X POST -H "Authorization: Bearer $CLEAN_TOKEN" \
               -H "Content-Type: application/json" \
               -d "{\"title\": \"Meraki HA Deployed\", \"message\": \"Deploy finished and restart initiated.\"}" \
               "$HA_URL/api/services/notify/$NOTIFY_SERVICE"

<<<<<<< HEAD
          echo "Home Assistant is rebooting..."

      - name: Post-Deploy Health Audit
=======
      - name: Run Release Health Auditor
<<<<<<< HEAD
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
        shell: bash
        env:
          HA_URL: ${{ secrets.HA_URL }}
          HA_TOKEN: ${{ secrets.HA_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
<<<<<<< HEAD
<<<<<<< HEAD
=======
<<<<<<< HEAD
        run: |
          echo "Waiting 90s for system to stabilize and poll Meraki Dashboard..."
          sleep 120

          # This assumes Jules has built tools/auditor/audit.py per your issue prompt
          if [ -f "tools/auditor/audit.py" ]; then
            python3 tools/auditor/audit.py
          else
            echo "Auditor script not found. Skipping health check."
          fi
=======
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
          GITHUB_REPOSITORY: ${{ github.repository }}
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
        run: |
          echo "Waiting 90s for system to stabilize and poll Meraki Dashboard..."
          sleep 120

<<<<<<< HEAD
          # This assumes Jules has built tools/auditor/audit.py per your issue prompt
          if [ -f "tools/auditor/audit.py" ]; then
            python3 tools/auditor/audit.py
          else
            echo "Auditor script not found. Skipping health check."
          fi
=======
          echo "Home Assistant restart command sent. Waiting for it to come back online..."
          # Add a sleep to allow Home Assistant to restart
          sleep 60 # Wait for 60 seconds. Adjust as needed.
>>>>>>> 498e2557 (fix(config_flow): Remove unused voluptuous import)
=======
          echo "Installing dependencies for the health auditor..."
          pip install aiohttp

          echo "Running the health auditor script..."
          python3 tools/auditor/health_auditor.py
<<<<<<< HEAD
>>>>>>> 500a6a1 (Merge branch 'main' into test/config-flow-errors-4148457084909740722)
>>>>>>> c0de2c1e (fix(config_flow): Resolve CI failures and rebase on beta)
=======
>>>>>>> 2aed98c0 (fix(config_flow): Resolve CI and HACS validation failures)
