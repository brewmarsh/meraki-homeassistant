name: Agent Healer

on:
  workflow_run:
    workflows: ["Validate Code"]
    types: [completed]
  pull_request:
    branches: [beta]

permissions:
  contents: write
  pull-requests: write

jobs:
  heal:
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'pull_request' && github.actor == 'dependabot[bot]')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Jules to Fix CI
        uses: google-labs-code/jules-invoke@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          base_branch: "beta"
          # Using top-level 'github' context variables ensures they work for ALL triggers
          instructions: |
            The CI validation failed for this change. 
            
            **Context:**
            - **Triggering Actor:** ${{ github.actor }}
            - **Event Type:** ${{ github.event_name }}
            
            **Instructions:**
            1. Analyze the logs from the failed 'Validate Code' workflow to identify the root cause.
            2. **If the PR was opened by 'dependabot[bot]'**: Prioritize resolving version conflicts or linting issues introduced by the dependency update.
            3. Apply a fix and commit it directly to the branch associated with this PR.
