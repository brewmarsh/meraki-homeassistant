name: Agent Healer

on:
  workflow_run:
    workflows: ['Validate Code']
    types: [completed]
  pull_request:
    branches: [beta]

permissions:
  contents: write
  pull-requests: write

jobs:
  heal:
    # Only run if the validation failed OR if specifically triggered by you/dependabot
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'pull_request' && (github.actor == 'dependabot[bot]' || github.actor == 'brewmarsh'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Fetch the main branch to compare against
          fetch-depth: 0

      - name: Find changed Python files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            custom_components/meraki_ha/**/*.py

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run py_compile
        id: py_compile
        continue-on-error: true
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          output=$(python3 -m py_compile ${{ steps.changed-files.outputs.all_changed_files }} 2>&1)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run ruff check
        id: ruff_check
        continue-on-error: true
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          output=$(ruff check ${{ steps.changed-files.outputs.all_changed_files }} 2>&1)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Root Cause Analysis
        if: steps.py_compile.outcome == 'failure' || steps.ruff_check.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number || github.event.workflow_run.pull_requests[0].number }}
          body: |
            **Root Cause Analysis**

            Static analysis has identified potential issues in the recent changes.

            ${{ steps.py_compile.outcome == 'failure' && '### `py_compile` Errors' || '' }}
            ${{ steps.py_compile.outcome == 'failure' && '```' || '' }}
            ${{ steps.py_compile.outcome == 'failure' && steps.py_compile.outputs.output || '' }}
            ${{ steps.py_compile.outcome == 'failure' && '```' || '' }}

            ${{ steps.ruff_check.outcome == 'failure' && '### `ruff` Linter Errors' || '' }}
            ${{ steps.ruff_check.outcome == 'failure' && '```' || '' }}
            ${{ steps.ruff_check.outcome == 'failure' && steps.ruff_check.outputs.output || '' }}
            ${{ steps.ruff_check.outcome == 'failure' && '```' || '' }}

            Jules will now attempt to fix these issues.

      - name: Trigger Jules to Fix CI
        if: steps.py_compile.outcome == 'failure' || steps.ruff_check.outcome == 'failure'
        uses: google-labs-code/jules-action@main
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: ${{ github.head_ref || github.event.workflow_run.head_branch || github.ref_name }}
          include_last_commit: true
          include_commit_log: true
          prompt: |
            The CI validation failed for this change. 

            **Context:**
            - **Triggering Actor:** ${{ github.actor }}
            - **Event:** ${{ github.event_name }}
            - **Branch:** ${{ github.head_ref || github.event.workflow_run.head_branch || github.ref_name }}

            **Instructions:**
            1. Analyze the logs from the 'Validate Code' workflow.
            2. Review any linting (Ruff) or test (Pytest) errors.
            3. If this is a Dependabot PR, resolve version conflicts in manifest.json and requirements.txt.
            4. Ensure 'webrtc-models==0.3.0' is present if required by HA Core.
            5. Apply the fix and push directly to the branch.
