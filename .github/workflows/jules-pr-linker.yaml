name: Agent PR Linker

run-name: 'Link PR #${{ github.event.pull_request.number }} to Issue'

# This workflow links AI agent-created PRs back to their source issues
# Handles both Jules and Cursor PRs
# Triggers when any PR is opened and checks if it's from an AI agent

on:
  pull_request:
    types:
      - opened

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings â†’ Actions â†’ General â†’ Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: read
  issues: write
  pull-requests: write

# Prevent duplicate linking for the same PR
concurrency:
  group: agent-pr-linker-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  link-pr-to-issue:
    runs-on: ubuntu-latest
    # Inherits permissions from workflow level
    steps:
      - name: Check if AI Agent PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          BRANCH="${{ github.event.pull_request.head.ref }}"

          echo "PR Author: $PR_AUTHOR"
          echo "Branch: $BRANCH"

          # Detect which agent created this PR
          AGENT_TYPE=""

          # Check for Jules
          if [[ "$PR_AUTHOR" == *"jules"* ]] || [[ "$PR_AUTHOR" == *"google-labs"* ]]; then
            AGENT_TYPE="jules"
            echo "Detected Jules PR by author: $PR_AUTHOR"
          fi

          # Check for Cursor (branch pattern or author)
          if [[ "$BRANCH" == cursor/* ]] || [[ "$BRANCH" == cursor-review/* ]] || [[ "$PR_AUTHOR" == *"cursor"* ]]; then
            AGENT_TYPE="cursor"
            echo "Detected Cursor PR by branch: $BRANCH"
          fi

          # Also check for bot accounts that might be either agent
          if [[ -z "$AGENT_TYPE" ]] && [[ "$PR_AUTHOR" == *"[bot]"* ]]; then
            # Check branch name to determine which agent
            if [[ "$BRANCH" == cursor/* ]]; then
              AGENT_TYPE="cursor"
            else
              AGENT_TYPE="jules"
            fi
            echo "Detected bot PR, determined agent: $AGENT_TYPE"
          fi

          echo "agent_type=$AGENT_TYPE" >> "$GITHUB_OUTPUT"

          if [[ -z "$AGENT_TYPE" ]]; then
            echo "Not an AI agent PR - skipping"
            exit 0
          fi

          # Extract issue number - try multiple methods
          ISSUE_NUM=""

          # Method 1: Look for "Closes #XX" / "Fixes #XX" in body
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves) #[0-9]+' | grep -oE '[0-9]+' | head -1)
            if [[ -n "$ISSUE_NUM" ]]; then
              echo "Found issue from body closing reference: #$ISSUE_NUM"
            fi
          fi

          # Method 2: Look for any "#XX" in body
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1)
            if [[ -n "$ISSUE_NUM" ]]; then
              echo "Found issue from body reference: #$ISSUE_NUM"
            fi
          fi

          # Method 3: Extract from branch name (e.g., "cursor/123-task" or "bugfix/something-59-randomid")
          if [[ -z "$ISSUE_NUM" ]]; then
            # Look for issue number pattern in branch name
            ISSUE_NUM=$(echo "$BRANCH" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
            if [[ -n "$ISSUE_NUM" ]]; then
              echo "Found issue from branch name: #$ISSUE_NUM"
            fi
          fi

          # Method 4: For cursor branches like "cursor/123-task"
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$BRANCH" | sed -E 's/^(cursor|cursor-review)\///' | grep -oE '^[0-9]+' | head -1)
            if [[ -n "$ISSUE_NUM" ]]; then
              echo "Found issue from cursor branch pattern: #$ISSUE_NUM"
            fi
          fi

          # Method 5: Try just numbers in branch name after common prefixes
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$BRANCH" | sed -E 's/^(bugfix|fix|feat|feature)\///' | grep -oE '^[^-]+-[0-9]+' | grep -oE '[0-9]+' | head -1)
            if [[ -n "$ISSUE_NUM" ]]; then
              echo "Found issue from branch prefix pattern: #$ISSUE_NUM"
            fi
          fi

          # Output the branch name for tracking
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

          if [[ -n "$ISSUE_NUM" ]]; then
            echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"
            echo "âœ… Linked to issue: #$ISSUE_NUM"
            echo "   Branch: $BRANCH"
          else
            echo "âš ï¸ No issue reference found"
            echo "issue_number=" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on issue - PR created
        if: steps.check.outputs.agent_type != '' && steps.check.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          AGENT_TYPE="${{ steps.check.outputs.agent_type }}"

          REPO="${{ github.repository }}"
          BRANCH_URL="https://github.com/${REPO}/tree/${BRANCH}"

          # Set agent display name
          if [[ "$AGENT_TYPE" == "cursor" ]]; then
            AGENT_NAME="Cursor"
            AGENT_EMOJI="ðŸ–±ï¸"
          else
            AGENT_NAME="Jules"
            AGENT_EMOJI="ðŸ¤–"
          fi

          gh issue comment "$ISSUE_NUM" \
            --repo "$REPO" \
            --body "## ${AGENT_EMOJI} ${AGENT_NAME} Created a Pull Request

          **PR**: [#${PR_NUM} - ${PR_TITLE}](${PR_URL})
          **Branch**: [\`${BRANCH}\`](${BRANCH_URL})
          **Author**: @${PR_AUTHOR}

          **Next Steps:**
          1. â³ CI is running quality checks
          2. ðŸ” Automated code review
          3. ðŸ“‹ Human review before merge

          ---
          *This PR will automatically close this issue when merged.*"

      - name: Update issue labels
        if: steps.check.outputs.agent_type != '' && steps.check.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"

          # Remove in-progress, add pr-pending
          gh issue edit "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --remove-label "in-progress" \
            --add-label "pr-pending" 2>/dev/null || true

      - name: Add issue reference to PR if missing
        if: steps.check.outputs.agent_type != '' && steps.check.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          PR_NUM="${{ github.event.pull_request.number }}"

          # Get current PR body
          CURRENT_BODY=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json body -q '.body')

          # Check if it already has a proper closing reference
          if ! echo "$CURRENT_BODY" | grep -qiE '^(closes|fixes|resolves) #'; then
            # Append proper closing reference
            NEW_BODY="${CURRENT_BODY}

          ---
          Closes #${ISSUE_NUM}"

            gh pr edit "$PR_NUM" \
              --repo "${{ github.repository }}" \
              --body "$NEW_BODY"

            echo "Added 'Closes #${ISSUE_NUM}' to PR body"
          else
            echo "PR already has proper issue closing reference"
          fi
