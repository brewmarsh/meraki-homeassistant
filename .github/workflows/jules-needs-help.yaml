name: Jules Needs Help Handler

run-name: 'Cursor: Help Jules on PR #${{ github.event.pull_request.number || github.event.client_payload.pr_number }}'

# Triggers when Jules needs Cursor to take over
# Can be triggered by:
# 1. Label 'jules-needs-help' added to PR (by humans only - bot labels don't trigger)
# 2. repository_dispatch from jules-ci-fix.yaml (for bot-to-bot handoff)
#
# NOTE: GitHub Actions using GITHUB_TOKEN don't trigger other workflows via labels.
# That's why we use repository_dispatch for bot handoffs.

on:
  pull_request:
    types: [labeled]

  # Direct trigger from other workflows (bypasses GITHUB_TOKEN limitation)
  repository_dispatch:
    types: [jules-needs-help]

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings â†’ Actions â†’ General â†’ Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: read
  issues: write
  pull-requests: write

# Prevent multiple handlers for same PR
concurrency:
  group: jules-help-${{ github.event.pull_request.number || github.event.client_payload.pr_number }}
  cancel-in-progress: false

jobs:
  handle-help-request:
    runs-on: ubuntu-latest
    # Trigger on:
    # 1. Label event with 'jules-needs-help' label
    # 2. repository_dispatch event
    if: |
      (github.event_name == 'pull_request' && github.event.label.name == 'jules-needs-help') ||
      github.event_name == 'repository_dispatch'
    # Inherits permissions from workflow level
    steps:
      - name: Gather context from Jules
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Handle both pull_request (labeled) and repository_dispatch events
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            # Triggered by repository_dispatch from jules-ci-fix.yaml
            PR_NUM="${{ github.event.client_payload.pr_number }}"
            PR_BRANCH="${{ github.event.client_payload.branch }}"
            ISSUE_NUM="${{ github.event.client_payload.issue_number }}"

            echo "Triggered by repository_dispatch"

            # Get PR details from GitHub
            PR_JSON=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json title,body)
            PR_TITLE=$(echo "$PR_JSON" | jq -r '.title // empty')
            PR_BODY=$(echo "$PR_JSON" | jq -r '.body // empty')
          else
            # Triggered by pull_request labeled event
            PR_NUM="${{ github.event.pull_request.number }}"
            PR_BRANCH="${{ github.event.pull_request.head.ref }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"

            echo "Triggered by label event"

            # Extract issue number from PR body or branch name
            ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves) #[0-9]+' | grep -oE '[0-9]+' | head -1)
            if [[ -z "$ISSUE_NUM" ]]; then
              ISSUE_NUM=$(echo "$PR_BRANCH" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
            fi
          fi

          echo "PR #$PR_NUM: $PR_TITLE"
          echo "Branch: $PR_BRANCH"
          echo "Issue: #$ISSUE_NUM"

          # Get the help request comment from Jules (look for the ğŸ†˜ marker)
          HELP_COMMENT=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | contains("ğŸ†˜ Jules") or contains("Handoff"))] | last | .body // empty')

          if [[ -z "$HELP_COMMENT" ]]; then
            echo "âš ï¸ No help request comment found, using generic context"
            HELP_COMMENT="Jules requested help but did not provide specific context."
          fi

          echo "Found help request comment"

          # Get the original issue body for context
          ISSUE_BODY=""
          if [[ -n "$ISSUE_NUM" ]]; then
            ISSUE_BODY=$(gh issue view "$ISSUE_NUM" --repo "${{ github.repository }}" --json body --jq '.body // empty')
          fi

          # Get list of files changed in the PR
          FILES_CHANGED=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json files \
            --jq '[.files[].path] | join("\n")')

          # Get latest CI error logs if available
          RUN_ID=$(gh run list --repo "${{ github.repository }}" --branch "$PR_BRANCH" \
            --status failure --limit 1 --json databaseId --jq '.[0].databaseId // empty')

          CI_ERRORS=""
          if [[ -n "$RUN_ID" ]]; then
            CI_ERRORS=$(gh run view "$RUN_ID" --repo "${{ github.repository }}" --log-failed 2>/dev/null | tail -200 || echo "")
          fi

          # Save to files for the next step
          echo "$HELP_COMMENT" > /tmp/help_comment.txt
          echo "$ISSUE_BODY" > /tmp/issue_body.txt
          echo "$FILES_CHANGED" > /tmp/files_changed.txt
          echo "$CI_ERRORS" > /tmp/ci_errors.txt

          echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
          echo "pr_branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"
          echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

      - name: Comment on PR - Cursor taking over
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.context.outputs.pr_number }} \
            --repo "${{ github.repository }}" \
            --body "## ğŸ¤ Cursor Taking Over

          I received Jules' help request and am now taking over this task.

          **Branch:** \`${{ steps.context.outputs.pr_branch }}\`
          **Issue:** #${{ steps.context.outputs.issue_number }}

          I'll analyze where Jules got stuck and continue from there.

          ---
          *Cursor handoff initiated*"

      - name: Update labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.context.outputs.pr_number }} \
            --repo "${{ github.repository }}" \
            --remove-label "jules-needs-help" \
            --add-label "cursor-reviewing" 2>/dev/null || true

      - name: Update issue with handoff status
        if: steps.context.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.context.outputs.issue_number }} \
            --repo "${{ github.repository }}" \
            --body "## ğŸ¤ Handoff: Jules â†’ Cursor

          Jules requested help on PR #${{ steps.context.outputs.pr_number }}. Cursor taking over.

          Cursor will provide detailed updates."

      - name: Invoke Cursor to take over
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          PR_BRANCH="${{ steps.context.outputs.pr_branch }}"
          PR_NUM="${{ steps.context.outputs.pr_number }}"
          ISSUE_NUM="${{ steps.context.outputs.issue_number }}"
          GH_PAT_VALUE="${GH_PAT:-}"

          # Read saved context
          HELP_COMMENT=$(cat /tmp/help_comment.txt)
          ISSUE_BODY=$(cat /tmp/issue_body.txt)
          FILES_CHANGED=$(cat /tmp/files_changed.txt)
          CI_ERRORS=$(cat /tmp/ci_errors.txt)

          PROMPT="You are a coding agent for a Home Assistant integration (Cisco Meraki).
          Taking over from Jules who got stuck.

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          HANDOFF FROM JULES
          PR: #$PR_NUM | Issue: #$ISSUE_NUM | Branch: $PR_BRANCH
          REPO: ${{ github.repository }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          GITHUB AUTHENTICATION:
          If you need to run gh commands and get permission errors, run:
          export GH_TOKEN='${GH_PAT_VALUE}'
          Then retry the command.

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          JULES' HELP REQUEST:
          $HELP_COMMENT

          FILES JULES CHANGED:
          $FILES_CHANGED

          CI ERRORS (if any):
          \`\`\`
          $CI_ERRORS
          \`\`\`

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          TAKEOVER STEPS (Complete ALL):
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          â–¡ STEP 1: UNDERSTAND THE FULL CONTEXT
            - Read AGENTS.md for project patterns
            - Read issue #$ISSUE_NUM AND all comments
            - Review Jules' work in the changed files
            - Understand what Jules was trying to do

          â–¡ STEP 2: FIX WHAT BLOCKED JULES
            - Address the specific problem Jules described
            - Use a different approach if Jules' approach wasn't working
            - Follow project patterns exactly

          â–¡ STEP 3: COMPLETE THE ORIGINAL TASK
            - Ensure ALL requirements from issue #$ISSUE_NUM are met
            - Don't just fix the error - finish the whole task
            - Add any missing tests

          â–¡ STEP 4: VERIFY QUALITY
            Run: ./run_checks.sh
            This MUST pass with no errors.

          â–¡ STEP 5: COMMIT YOUR CHANGES
            Commit message: fix(cursor): continue from Jules - <brief description>

          â–¡ STEP 6: UPDATE THE ISSUE
            Run:
            gh issue comment $ISSUE_NUM --repo ${{ github.repository }} --body '## âœ… Cursor Takeover Complete

            ### What Jules Was Stuck On
            <describe the problem>

            ### How I Fixed It
            <explain your solution>

            ### Additional Changes
            <any other work you did to complete the task>

            ### Verification
            - [x] ./run_checks.sh passes
            - [x] All requirements from issue met
            - [x] Tests added/updated

            ---
            *Handoff complete - PR ready for review*'

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONSTRAINTS:
          - Push to $PR_BRANCH (don't create a new PR)
          - Complete the ENTIRE task, not just the blocking issue
          - Don't add unrelated changes
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          RESPONSE=$(curl -sS -X POST "https://api.cursor.com/v0/agents" \
            -u "${CURSOR_API_KEY}:" \
            -H "Content-Type: application/json" \
            -d "{
              \"source\": {
                \"repository\": \"https://github.com/${{ github.repository }}\",
                \"ref\": \"$PR_BRANCH\"
              },
              \"prompt\": {
                \"text\": ${ESCAPED_PROMPT}
              },
              \"target\": {
                \"branchName\": \"$PR_BRANCH\",
                \"autoCreatePr\": false
              }
            }")

          echo "Cursor API Response: $RESPONSE"

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [[ -n "$AGENT_ID" ]]; then
            echo "âœ… Cursor agent launched: $AGENT_ID"

            # Comment with agent link
            gh pr comment "$PR_NUM" \
              --repo "${{ github.repository }}" \
              --body "## âœ… Cursor Agent Launched

            Cursor is now working on completing this task.

            **Agent ID:** \`$AGENT_ID\`

            I'll push fixes directly to this branch. Once CI passes, this PR will be ready for human review.

            ---
            *[View Agent](https://cursor.com/agents?id=$AGENT_ID)*"
          else
            echo "::error::Failed to launch Cursor agent"
            echo "$RESPONSE"
            exit 1
          fi

  # Handle errors
  handle-error:
    needs: handle-help-request
    if: failure()
    runs-on: ubuntu-latest
    # Inherits permissions from workflow level
    steps:
      - name: Comment on PR - Error
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo "${{ github.repository }}" \
            --body "## âš ï¸ Cursor Handoff Error

          There was an error invoking Cursor to take over.

          **Possible reasons:**
          - API key configuration issue
          - Rate limiting
          - Temporary service unavailability

          Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          ---
          *You may need to manually trigger Cursor or request human help.*"

          # Reset labels
          gh pr edit ${{ github.event.pull_request.number }} \
            --repo "${{ github.repository }}" \
            --remove-label "cursor-reviewing" \
            --add-label "needs-human-review" 2>/dev/null || true
