name: Cursor PR Handler

run-name: 'Cursor: Handle ${{ github.event.workflow_run.head_branch }}'

# Handles Cursor review PRs (cursor-review/* branches)
# - If checks pass: Auto-merge into Jules branch
# - If checks fail: Do nothing - Cursor will automatically fix and push again

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

# Prevent multiple handlers on same Cursor branch
concurrency:
  group: cursor-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  handle-cursor-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Check if this is a Cursor PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          CI_CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "Branch: $HEAD_BRANCH"
          echo "CI Result: $CI_CONCLUSION"

          # Only handle cursor-review/* branches
          if [[ "$HEAD_BRANCH" != cursor-review/* ]]; then
            echo "Not a Cursor review branch - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find the PR for this Cursor branch
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number,title,body,baseRefName \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_BASE=$(echo "$PR_JSON" | jq -r '.[0].baseRefName // empty')

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open Cursor PR found - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Cursor PR #$PR_NUMBER targeting Jules branch: $PR_BASE"

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "cursor_branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          echo "jules_branch=$PR_BASE" >> "$GITHUB_OUTPUT"
          echo "ci_conclusion=$CI_CONCLUSION" >> "$GITHUB_OUTPUT"

          # Count fix attempts
          FIX_ATTEMPTS=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | contains("Cursor Fix Attempt"))] | length')
          echo "fix_attempts=$FIX_ATTEMPTS" >> "$GITHUB_OUTPUT"

          # Find the Jules PR (targets beta from jules_branch)
          JULES_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$PR_BASE" \
            --state open \
            --json number \
            --jq '.[0].number // empty')
          echo "jules_pr=$JULES_PR" >> "$GITHUB_OUTPUT"

          # Extract issue number from Jules branch name
          ISSUE_NUM=$(echo "$PR_BASE" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

      # ============ CI PASSED: Auto-merge into Jules branch ============
      - name: Auto-merge Cursor PR
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          JULES_PR="${{ steps.check.outputs.jules_pr }}"
          JULES_BRANCH="${{ steps.check.outputs.jules_branch }}"
          CURSOR_BRANCH="${{ steps.check.outputs.cursor_branch }}"

          echo "✅ Checks passed! Auto-merging Cursor PR #$PR_NUMBER into $JULES_BRANCH"

          # Mark PR as ready (in case it's a draft)
          gh pr ready "$PR_NUMBER" --repo "${{ github.repository }}" 2>/dev/null || true

          # Comment on Cursor PR
          gh pr comment "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "## ✅ Checks Passed - Auto-Merging

          All checks passed! Merging into Jules branch \`$JULES_BRANCH\`.

          ---
          *Auto-merged by Cursor workflow*"

          # Merge the Cursor PR
          gh pr merge "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --squash \
            --delete-branch

          # Comment on Jules PR
          if [[ -n "$JULES_PR" ]]; then
            gh pr comment "$JULES_PR" \
              --repo "${{ github.repository }}" \
              --body "## ✅ Cursor Review Complete

          Cursor's code improvements have been merged into this branch.

          **Cursor Branch**: \`$CURSOR_BRANCH\` → deleted ✅

          This PR is now ready for human review.

          ---
          *Cursor review completed*"

            # Update labels on Jules PR
            gh pr edit "$JULES_PR" \
              --repo "${{ github.repository }}" \
              --remove-label "cursor-reviewing" \
              --add-label "cursor-reviewed" \
              --add-label "ready-for-review" 2>/dev/null || true
          fi

      - name: Update issue - ready for review
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success' && steps.check.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"

          gh issue comment "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --body "## ✅ Ready for Human Review

          Both Jules and Cursor have completed their work.

          **Jules PR**: #${{ steps.check.outputs.jules_pr }}
          **Status**: Ready for human review and merge to beta

          ---
          *Automated update*"

          gh issue edit "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --remove-label "pr-pending" \
            --add-label "ready-for-review" 2>/dev/null || true

      # ============ CI FAILED: Cursor will self-correct ============
      # Cursor agents automatically fix their own failures and push again.
      # We just log for visibility - no action needed.
      - name: Log CI failure (Cursor will self-fix)
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'failure'
        run: |
          echo "⏳ Cursor PR #${{ steps.check.outputs.pr_number }} failed CI"
          echo "Cursor will automatically fix and push again."
          echo "No action needed - waiting for next CI run."
