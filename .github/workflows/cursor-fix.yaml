name: Cursor PR Handler

run-name: 'Cursor: Handle ${{ github.event.workflow_run.head_branch }}'

# Handles Cursor review PRs (cursor-review/* branches)
# - If checks pass: Auto-merge into Jules branch
# - If checks fail: Do nothing - Cursor will automatically fix and push again

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings â†’ Actions â†’ General â†’ Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: write
  issues: write
  pull-requests: write

# Prevent multiple handlers on same Cursor branch
concurrency:
  group: cursor-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  handle-cursor-pr:
    runs-on: ubuntu-latest
    # This workflow handles:
    # 1. cursor-review/* branches (Cursor's own review PRs)
    # 2. PRs with cursor-reviewing label (handoffs from Jules)
    # We can't filter by label at job level, so we check inside the step
    # Inherits permissions from workflow level
    steps:
      - name: Check if this is a Cursor PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          CI_CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "Branch: $HEAD_BRANCH"
          echo "CI Result: $CI_CONCLUSION"

          # Find PR for this branch
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number,title,body,baseRefName,labels \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_BASE=$(echo "$PR_JSON" | jq -r '.[0].baseRefName // empty')
          PR_LABELS=$(echo "$PR_JSON" | jq -r '[.[0].labels[].name] | join(" ")' 2>/dev/null || echo "")

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "PR #$PR_NUMBER, Labels: $PR_LABELS"

          # Handle if: cursor-review/* branch OR has cursor-reviewing label
          IS_CURSOR_BRANCH="false"
          IS_CURSOR_LABEL="false"

          if [[ "$HEAD_BRANCH" == cursor-review/* ]]; then
            IS_CURSOR_BRANCH="true"
            echo "This is a Cursor review branch"
          fi

          if echo "$PR_LABELS" | grep -q "cursor-reviewing"; then
            IS_CURSOR_LABEL="true"
            echo "This PR has cursor-reviewing label (handoff from Jules)"
          fi

          if [[ "$IS_CURSOR_BRANCH" == "false" && "$IS_CURSOR_LABEL" == "false" ]]; then
            echo "Not a Cursor-handled PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Cursor handling PR #$PR_NUMBER"

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "cursor_branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          echo "jules_branch=$PR_BASE" >> "$GITHUB_OUTPUT"
          echo "ci_conclusion=$CI_CONCLUSION" >> "$GITHUB_OUTPUT"
          echo "is_cursor_branch=$IS_CURSOR_BRANCH" >> "$GITHUB_OUTPUT"
          echo "is_handoff=$IS_CURSOR_LABEL" >> "$GITHUB_OUTPUT"

          # Count fix attempts (look for both "Cursor Fix" and general fix comments)
          FIX_ATTEMPTS=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | test("Cursor Fix|Cursor has tried|CI Fix Required"))] | length')
          echo "fix_attempts=$FIX_ATTEMPTS" >> "$GITHUB_OUTPUT"

          # Find the Jules PR (targets beta from jules_branch)
          JULES_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$PR_BASE" \
            --state open \
            --json number \
            --jq '.[0].number // empty')
          echo "jules_pr=$JULES_PR" >> "$GITHUB_OUTPUT"

          # Extract issue number from Jules branch name
          ISSUE_NUM=$(echo "$PR_BASE" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

          # Get the last commit details for context
          LAST_COMMIT=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json commits \
            --jq '.commits[-1] | {sha: .oid[0:7], message: .messageHeadline, author: .authors[0].login}' 2>/dev/null || echo "{}")

          COMMIT_SHA=$(echo "$LAST_COMMIT" | jq -r '.sha // empty')
          COMMIT_MSG=$(echo "$LAST_COMMIT" | jq -r '.message // empty')
          COMMIT_AUTHOR=$(echo "$LAST_COMMIT" | jq -r '.author // empty')

          if [[ -n "$COMMIT_SHA" ]]; then
            FILES_CHANGED=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}" \
              --jq '[.files[].filename] | join(", ")' 2>/dev/null || echo "")
          else
            FILES_CHANGED=""
          fi

          echo "commit_sha=$COMMIT_SHA" >> "$GITHUB_OUTPUT"
          echo "commit_msg=$COMMIT_MSG" >> "$GITHUB_OUTPUT"
          echo "commit_author=$COMMIT_AUTHOR" >> "$GITHUB_OUTPUT"
          {
            echo "files_changed<<EOF"
            echo "$FILES_CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # ============ CI PASSED: Handle success ============
      - name: Handle CI success
        id: success
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          JULES_PR="${{ steps.check.outputs.jules_pr }}"
          JULES_BRANCH="${{ steps.check.outputs.jules_branch }}"
          CURSOR_BRANCH="${{ steps.check.outputs.cursor_branch }}"
          IS_CURSOR_BRANCH="${{ steps.check.outputs.is_cursor_branch }}"
          IS_HANDOFF="${{ steps.check.outputs.is_handoff }}"

          echo "âœ… Checks passed!"

          if [[ "$IS_CURSOR_BRANCH" == "true" ]]; then
            # This is a cursor-review/* branch - merge it into Jules branch
            echo "Merging Cursor PR #$PR_NUMBER into $JULES_BRANCH"

            # Mark PR as ready (in case it's a draft)
            gh pr ready "$PR_NUMBER" --repo "${{ github.repository }}" 2>/dev/null || true

            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## âœ… Checks Passed - Auto-Merging

            All checks passed! Merging into Jules branch \`$JULES_BRANCH\`.

            ---
            *Auto-merged by Cursor workflow*"

            # Merge the Cursor PR
            gh pr merge "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --squash \
              --delete-branch

            # Comment on Jules PR and trigger CI
            if [[ -n "$JULES_PR" ]]; then
              gh pr comment "$JULES_PR" \
                --repo "${{ github.repository }}" \
                --body "## âœ… Cursor Review Complete

            Cursor's code improvements have been merged into this branch.

            **Cursor Branch**: \`$CURSOR_BRANCH\` â†’ deleted âœ…

            Triggering final CI run...

            ---
            *Cursor review completed*"

              gh pr edit "$JULES_PR" \
                --repo "${{ github.repository }}" \
                --remove-label "cursor-reviewing" \
                --add-label "cursor-reviewed" \
                --add-label "ready-for-review" 2>/dev/null || true

              # Trigger CI by closing and reopening the PR
              # (GITHUB_TOKEN commits don't trigger workflows, so we need this workaround)
              echo "Triggering CI by close/reopen..."
              gh pr close "$JULES_PR" --repo "${{ github.repository }}" 2>/dev/null || true
              sleep 2
              gh pr reopen "$JULES_PR" --repo "${{ github.repository }}" 2>/dev/null || true
            fi

          elif [[ "$IS_HANDOFF" == "true" ]]; then
            # This is a handoff case - Cursor fixed CI, now needs to do code review
            # We DON'T mark as ready yet - Cursor still needs to review the code quality
            echo "Cursor fixed CI - now launching code review"

            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## âœ… CI Fixed - Starting Code Review

            Cursor has fixed the CI issues. Now performing code quality review.

            ---
            *CI fixed, review starting*"

            # Change label to indicate CI is fixed but review pending
            gh pr edit "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --remove-label "cursor-reviewing" \
              --add-label "cursor-ci-fixed" 2>/dev/null || true

            # Set flag to trigger code review
            echo "needs_code_review=true" >> "$GITHUB_OUTPUT"
            echo "review_pr=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "review_branch=$CURSOR_BRANCH" >> "$GITHUB_OUTPUT"
          fi

      # After fixing CI, Cursor still needs to review the code quality
      - name: Launch Cursor code review after CI fix
        id: code_review
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success' && steps.check.outputs.is_handoff == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          BRANCH="${{ steps.check.outputs.cursor_branch }}"
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          GH_PAT_VALUE="${GH_PAT:-}"

          echo "ğŸ” Launching Cursor code review after CI fix"

          # Get issue body for context
          ISSUE_BODY=""
          if [[ -n "$ISSUE_NUM" ]]; then
            ISSUE_BODY=$(gh issue view "$ISSUE_NUM" --repo "${{ github.repository }}" --json body --jq '.body // ""' 2>/dev/null || echo "")
          fi

          # Launch Cursor for code review (creates cursor-review/* branch)
          CURSOR_REVIEW_BRANCH="cursor-review/${BRANCH}"

          PROMPT="You are a code review agent for a Home Assistant integration (Cisco Meraki).

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CODE REVIEW AFTER CI FIX
          PR: #$PR_NUMBER | Issue: #$ISSUE_NUM | Branch: $BRANCH
          REPO: ${{ github.repository }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          GITHUB AUTHENTICATION:
          If you need to run gh commands and get permission errors, run:
          export GH_TOKEN='${GH_PAT_VALUE}'
          Then retry the command.

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          REQUIREMENTS: ${ISSUE_BODY:-See issue #$ISSUE_NUM}

          CI has been fixed. Now review the implementation quality.

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          REVIEW CHECKLIST:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          â–¡ Read AGENTS.md for project patterns
          â–¡ Read issue #$ISSUE_NUM comments for full context
          â–¡ Verify ALL requirements from issue are implemented
          â–¡ Check code quality (logger usage, type hints, async patterns)
          â–¡ Verify test coverage exists
          â–¡ Run ./run_checks.sh - MUST pass
          â–¡ Comment on issue with review findings:
            gh issue comment $ISSUE_NUM --repo ${{ github.repository }} --body '## ğŸ” Review Complete
            <your findings>
            - [x] Requirements met
            - [x] Code quality verified
            - [x] Tests pass'
          â–¡ Create PR targeting $BRANCH

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONSTRAINTS: Don't add unrelated changes. All tests must pass.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          RESPONSE=$(curl -sS -X POST "https://api.cursor.com/v0/agents" \
            -u "${CURSOR_API_KEY}:" \
            -H "Content-Type: application/json" \
            -d "{
              \"source\": {
                \"repository\": \"https://github.com/${{ github.repository }}\",
                \"ref\": \"$BRANCH\"
              },
              \"prompt\": {
                \"text\": ${ESCAPED_PROMPT}
              },
              \"target\": {
                \"branchName\": \"$CURSOR_REVIEW_BRANCH\",
                \"autoCreatePr\": true
              }
            }")

          echo "Cursor API Response: $RESPONSE"

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [[ -n "$AGENT_ID" ]]; then
            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## ğŸ” Code Review Started

            CI is fixed. Cursor is now reviewing code quality.

            **Agent**: [$AGENT_ID](https://cursor.com/agents?id=$AGENT_ID)
            **Review Branch**: \`$CURSOR_REVIEW_BRANCH\`

            ---
            *Code review in progress*"

            # Update label
            gh pr edit "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --remove-label "cursor-ci-fixed" \
              --add-label "cursor-reviewing" 2>/dev/null || true
          fi

      - name: Update issue - code review started
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success' && steps.check.outputs.issue_number != '' && steps.check.outputs.is_handoff == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"

          gh issue comment "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --body "## ğŸ” Cursor Code Review Started

          CI fixed. Cursor is now reviewing code quality on PR #$PR_NUMBER.

          Cursor will provide detailed findings."

      - name: Update issue - ready for review
        # Only run when review is complete (cursor-review branch merged), not after CI fix handoff
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success' && steps.check.outputs.issue_number != '' && steps.check.outputs.is_handoff != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          JULES_PR="${{ steps.check.outputs.jules_pr }}"
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          DISPLAY_PR="${JULES_PR:-$PR_NUMBER}"

          gh issue comment "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --body "## âœ… Ready for Human Review

          | Status | PR | CI | Review |
          |--------|----|----|--------|
          | âœ… Ready | #$DISPLAY_PR | âœ… Passing | âœ… Cursor reviewed |

          Please review the PR and merge to beta.

          ---
          *See agent comments above for detailed implementation notes.*"

          gh issue edit "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --remove-label "pr-pending" \
            --add-label "ready-for-review" 2>/dev/null || true

      # ============ CI FAILED: Check if escalation or re-invoke needed ============
      - name: Handle CI failure
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          BRANCH="${{ steps.check.outputs.cursor_branch }}"
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          FIX_ATTEMPTS="${{ steps.check.outputs.fix_attempts }}"
          IS_HANDOFF="${{ steps.check.outputs.is_handoff }}"

          echo "â³ PR #$PR_NUMBER failed CI (attempt $FIX_ATTEMPTS, handoff=$IS_HANDOFF)"

          # After 10 Cursor attempts, escalate to human
          if [[ "$FIX_ATTEMPTS" -ge 10 ]]; then
            echo "ğŸš¨ Cursor has tried 10+ times - escalating to human"

            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## ğŸš¨ Escalation to Human Required

            Cursor has attempted 10+ fixes but CI still fails.

            **Manual intervention required.**

            ---
            *Escalated by Cursor workflow*"

            gh pr edit "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --remove-label "cursor-reviewing" \
              --add-label "needs-human-review" 2>/dev/null || true

            if [[ -n "$ISSUE_NUM" ]]; then
              gh issue comment "$ISSUE_NUM" \
                --repo "${{ github.repository }}" \
                --body "## ğŸš¨ Human Intervention Required

            Both AI agents exhausted their attempts (Jules: 3, Cursor: 10+).

            | PR | Branch | CI Logs |
            |----|--------|---------|
            | #$PR_NUMBER | \`$BRANCH\` | [View](https://github.com/${{ github.repository }}/actions) |

            Please review the agent comments above for context on what was tried."

              gh issue edit "$ISSUE_NUM" \
                --repo "${{ github.repository }}" \
                --add-label "needs-human-review" 2>/dev/null || true
            fi

          # Both handoff and cursor-review/* branches need to invoke Cursor
          else
            echo "ğŸ”„ Invoking Cursor to fix (attempt $((FIX_ATTEMPTS + 1)), handoff=$IS_HANDOFF)"

            # Comment on PR
            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## ğŸ”§ Cursor Fix Attempt #$((FIX_ATTEMPTS + 1))

            CI failed. Invoking Cursor to fix.

            ---
            *Cursor workflow*"

            # Get CI error logs for context
            RUN_ID="${{ github.event.workflow_run.id }}"
            CI_ERRORS=""
            if [[ -n "$RUN_ID" ]]; then
              CI_ERRORS=$(gh run view "$RUN_ID" --repo "${{ github.repository }}" --log-failed 2>/dev/null | tail -150 || echo "Could not retrieve error logs")
            fi

            GH_PAT_VALUE="${GH_PAT:-}"

            # Invoke Cursor API with error context
            PROMPT="You are a CI fix agent for a Home Assistant integration (Cisco Meraki).

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            CI FIX TASK
            Branch: $BRANCH | Issue: #$ISSUE_NUM | Attempt: #$((FIX_ATTEMPTS + 1))
            REPO: ${{ github.repository }}
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            GITHUB AUTHENTICATION:
            If you need to run gh commands and get permission errors, run:
            export GH_TOKEN='${GH_PAT_VALUE}'
            Then retry the command.

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            CI ERRORS TO FIX:
            \`\`\`
            ${CI_ERRORS}
            \`\`\`

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            FIX STEPS (Complete ALL):
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            â–¡ STEP 1: UNDERSTAND CONTEXT
              - Read AGENTS.md for project patterns
              - Read issue #$ISSUE_NUM comments for prior fix attempts
              - Run ./run_checks.sh to see current errors

            â–¡ STEP 2: FIX THE ERRORS
              - Fix ONLY the errors shown above
              - Do NOT refactor unrelated code
              - Do NOT add new features

            â–¡ STEP 3: VERIFY THE FIX
              Run: ./run_checks.sh
              This MUST pass with no errors before proceeding.

            â–¡ STEP 4: COMMIT
              Commit message: fix(cursor): resolve CI errors

            â–¡ STEP 5: UPDATE THE ISSUE
              Run:
              gh issue comment $ISSUE_NUM --repo ${{ github.repository }} --body '## ğŸ”§ CI Fix Applied

              ### Errors Fixed
              <list what you fixed>

              ### Root Cause
              <explain why the error occurred>

              ### Verification
              - [x] ./run_checks.sh passes

              ---
              *CI fix attempt #$((FIX_ATTEMPTS + 1))*'

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            CONSTRAINTS:
            - Push to $BRANCH (no new PR)
            - Don't refactor unrelated code
            - Don't add new features
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

            RESPONSE=$(curl -sS -X POST "https://api.cursor.com/v0/agents" \
              -u "${CURSOR_API_KEY}:" \
              -H "Content-Type: application/json" \
              -d "{
                \"source\": {
                  \"repository\": \"https://github.com/${{ github.repository }}\",
                  \"ref\": \"$BRANCH\"
                },
                \"prompt\": {
                  \"text\": ${ESCAPED_PROMPT}
                },
                \"target\": {
                  \"branchName\": \"$BRANCH\",
                  \"autoCreatePr\": false
                }
              }")

            echo "Cursor API Response: $RESPONSE"
            AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

            # Note: Detailed issue updates are now done by Cursor directly during its run
            # Only log brief status if needed for debugging
            if [[ -n "$ISSUE_NUM" ]] && [[ "$FIX_ATTEMPTS" -eq 0 ]]; then
              # Only comment on first attempt to avoid spam
              gh issue comment "$ISSUE_NUM" \
                --repo "${{ github.repository }}" \
                --body "## ğŸ”§ Cursor CI Fix Started

              CI failed on PR #$PR_NUMBER. Cursor is fixing. Agent: [${AGENT_ID:-...}](https://cursor.com/agents?id=$AGENT_ID)

              Cursor will provide detailed updates."
            fi
          fi
