name: Cursor PR Handler

run-name: 'Cursor: Handle ${{ github.event.workflow_run.head_branch }}'

# Handles Cursor PRs that target Jules branches
# - If CI fails: Cursor self-heals
# - If CI passes: Auto-merge into Jules branch

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

jobs:
  handle-cursor-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Get PR details
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          CI_CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "Branch: $HEAD_BRANCH"
          echo "CI: $CI_CONCLUSION"

          # Only handle cursor-review branches
          if [[ "$HEAD_BRANCH" != cursor-review/* ]]; then
            echo "Not a Cursor review branch - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find the PR for this branch
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number,title,body,baseRefName,headRefName \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found for Cursor branch"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_BASE=$(echo "$PR_JSON" | jq -r '.[0].baseRefName // empty')
          PR_HEAD_REF=$(echo "$PR_JSON" | jq -r '.[0].headRefName // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.[0].title // empty')
          PR_BODY=$(echo "$PR_JSON" | jq -r '.[0].body // empty')

          echo "Cursor PR #$PR_NUMBER targeting: $PR_BASE"

          # Count fix attempts (look for cursor fix comments)
          FIX_ATTEMPTS=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | contains("Cursor Fix Attempt"))] | length')

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "base_branch=$PR_BASE" >> "$GITHUB_OUTPUT"
          echo "head_ref=$PR_HEAD_REF" >> "$GITHUB_OUTPUT"
          echo "title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "ci_conclusion=$CI_CONCLUSION" >> "$GITHUB_OUTPUT"
          echo "fix_attempts=$FIX_ATTEMPTS" >> "$GITHUB_OUTPUT"

          # Find the original Jules PR
          JULES_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$PR_BASE" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          echo "jules_pr=$JULES_PR" >> "$GITHUB_OUTPUT"

          # Extract issue number from Jules branch
          ISSUE_NUM=$(echo "$PR_BASE" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

      # ============ CI PASSED: Auto-merge into Jules branch ============
      - name: Auto-merge Cursor PR
        if: steps.pr.outputs.skip != 'true' && steps.pr.outputs.ci_conclusion == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          JULES_PR="${{ steps.pr.outputs.jules_pr }}"
          BASE_BRANCH="${{ steps.pr.outputs.base_branch }}"

          echo "âœ… CI passed! Auto-merging Cursor PR #$PR_NUMBER into $BASE_BRANCH"

          # Enable auto-merge
          gh pr merge "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --squash \
            --auto \
            --delete-branch

          # Comment on Cursor PR
          gh pr comment "$PR_NUMBER" \
            --repo "${{ github.repository }}" \
            --body "## âœ… Auto-Merging

          CI passed! Merging into Jules branch \`$BASE_BRANCH\`.

          ---
          *Auto-merged by Cursor workflow*"

          # Comment on Jules PR
          if [[ -n "$JULES_PR" ]]; then
            gh pr comment "$JULES_PR" \
              --repo "${{ github.repository }}" \
              --body "## âœ… Cursor Review Complete

          Cursor's improvements have been merged into this branch.

          **Next Step:** Human review and merge into beta.

          ---
          *Cursor review completed*"

            # Update labels
            gh pr edit "$JULES_PR" \
              --repo "${{ github.repository }}" \
              --remove-label "cursor-pending" \
              --add-label "cursor-reviewed" 2>/dev/null || true
          fi

      - name: Update issue - ready for review
        if: steps.pr.outputs.skip != 'true' && steps.pr.outputs.ci_conclusion == 'success' && steps.pr.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.pr.outputs.issue_number }}"

          gh issue comment "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --body "## âœ… Ready for Human Review

          Both Jules and Cursor have completed their work. PR is ready for human review.

          ---
          *Automated update*"

          gh issue edit "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --remove-label "pr-pending" \
            --add-label "ready-for-review" 2>/dev/null || true

      # ============ CI FAILED: Cursor self-heals ============
      - name: Check if should escalate
        id: escalate
        if: steps.pr.outputs.skip != 'true' && steps.pr.outputs.ci_conclusion == 'failure'
        run: |
          FIX_ATTEMPTS="${{ steps.pr.outputs.fix_attempts }}"

          if [[ "$FIX_ATTEMPTS" -ge 3 ]]; then
            echo "should_escalate=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_escalate=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Escalate to human
        if: steps.escalate.outputs.should_escalate == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.pr.outputs.number }} \
            --repo "${{ github.repository }}" \
            --body "## ðŸš¨ Escalation Required

          Cursor has attempted 3+ fixes but CI still fails.

          **Manual intervention required.**

          ---
          *Escalated by Cursor workflow*"

          gh pr edit ${{ steps.pr.outputs.number }} --add-label "needs-human-review" 2>/dev/null || true

          if [[ -n "${{ steps.pr.outputs.jules_pr }}" ]]; then
            gh pr comment ${{ steps.pr.outputs.jules_pr }} \
              --repo "${{ github.repository }}" \
              --body "## ðŸš¨ Cursor Review Escalated

            Cursor's review PR needs human attention.

            ---
            *Escalated by Cursor workflow*"

            gh pr edit ${{ steps.pr.outputs.jules_pr }} --add-label "needs-human-review" 2>/dev/null || true
          fi

      - name: Get CI failure details
        id: ci_failure
        if: steps.pr.outputs.skip != 'true' && steps.pr.outputs.ci_conclusion == 'failure' && steps.escalate.outputs.should_escalate != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          REPO="${{ github.repository }}"

          # Get failed job names
          FAILED_JOBS=$(gh run view "$RUN_ID" --repo "$REPO" --json jobs \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")')
          echo "failed_jobs=$FAILED_JOBS" >> "$GITHUB_OUTPUT"

          # Download error logs
          mkdir -p /tmp/logs
          gh run view "$RUN_ID" --repo "$REPO" --log-failed 2>/dev/null | tail -200 > /tmp/logs/ci_errors.txt || true

      - name: Launch Cursor to fix
        id: cursor_fix
        if: steps.pr.outputs.skip != 'true' && steps.pr.outputs.ci_conclusion == 'failure' && steps.escalate.outputs.should_escalate != 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          FIX_NUM=$(( ${{ steps.pr.outputs.fix_attempts }} + 1 ))
          CURSOR_BRANCH="${{ steps.pr.outputs.head_ref }}"

          CI_ERRORS=""
          if [[ -f /tmp/logs/ci_errors.txt ]]; then
            CI_ERRORS=$(cat /tmp/logs/ci_errors.txt | head -100)
          fi

          PROMPT="You are fixing CI failures on your own review branch.

          ## Context
          - Your Branch: $CURSOR_BRANCH
          - Fix Attempt: #$FIX_NUM of 3
          - Failed Jobs: ${{ steps.ci_failure.outputs.failed_jobs }}

          ## CI Error Logs
          ${CI_ERRORS}

          ## Your Task
          1. Read the error logs carefully
          2. Fix the specific errors shown
          3. Run: ruff check --fix . && ruff format . && mypy && pytest
          4. Commit with: fix(cursor): resolve CI errors - attempt $FIX_NUM
          5. PUSH TO SAME BRANCH: $CURSOR_BRANCH

          Focus on the specific errors shown in the logs. Keep fixes minimal."

          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          RESPONSE=$(curl -sS -X POST \
            -u "${CURSOR_API_KEY}:" \
            -H "Content-Type: application/json" \
            -d "{
              \"source\": {
                \"repository\": \"https://github.com/${{ github.repository }}\",
                \"ref\": \"$CURSOR_BRANCH\"
              },
              \"prompt\": { \"text\": ${ESCAPED_PROMPT} },
              \"target\": {
                \"branchName\": \"$CURSOR_BRANCH\",
                \"autoCreatePr\": false
              }
            }" \
            "https://api.cursor.com/v0/agents")

          echo "API Response: $RESPONSE"

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [[ -z "$AGENT_ID" ]]; then
            echo "::error::Failed to launch Cursor agent"
            echo "$RESPONSE"
            exit 1
          fi

          echo "agent_id=$AGENT_ID" >> "$GITHUB_OUTPUT"
          echo "fix_num=$FIX_NUM" >> "$GITHUB_OUTPUT"
          echo "âœ… Launched Cursor fix agent: $AGENT_ID"

      - name: Comment on PR - fix started
        if: steps.cursor_fix.outputs.agent_id != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.pr.outputs.number }} \
            --repo "${{ github.repository }}" \
            --body "## ðŸ”§ Cursor Fix Attempt #${{ steps.cursor_fix.outputs.fix_num }}

          CI failed. Cursor is fixing: ${{ steps.ci_failure.outputs.failed_jobs }}

          **Agent ID**: \`${{ steps.cursor_fix.outputs.agent_id }}\`

          ---
          *[View Agent](https://cursor.com/agents?id=${{ steps.cursor_fix.outputs.agent_id }})*"
