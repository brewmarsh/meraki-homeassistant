name: Cursor PR Handler

run-name: 'Cursor: Handle ${{ github.event.workflow_run.head_branch }}'

# Handles Cursor review PRs (cursor-review/* branches)
# - If checks pass: Auto-merge into Jules branch
# - If checks fail: Do nothing - Cursor will automatically fix and push again

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings â†’ Actions â†’ General â†’ Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: write
  issues: write
  pull-requests: write

# Prevent multiple handlers on same Cursor branch
concurrency:
  group: cursor-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  handle-cursor-pr:
    runs-on: ubuntu-latest
    # This workflow handles:
    # 1. cursor-review/* branches (Cursor's own review PRs)
    # 2. PRs with cursor-reviewing label (handoffs from Jules)
    # We can't filter by label at job level, so we check inside the step
    # Inherits permissions from workflow level
    steps:
      - name: Check if this is a Cursor PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          CI_CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "Branch: $HEAD_BRANCH"
          echo "CI Result: $CI_CONCLUSION"

          # Find PR for this branch
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number,title,body,baseRefName,labels \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_BASE=$(echo "$PR_JSON" | jq -r '.[0].baseRefName // empty')
          PR_LABELS=$(echo "$PR_JSON" | jq -r '[.[0].labels[].name] | join(" ")' 2>/dev/null || echo "")

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "PR #$PR_NUMBER, Labels: $PR_LABELS"

          # Handle if: cursor-review/* branch OR has cursor-reviewing label
          IS_CURSOR_BRANCH="false"
          IS_CURSOR_LABEL="false"

          if [[ "$HEAD_BRANCH" == cursor-review/* ]]; then
            IS_CURSOR_BRANCH="true"
            echo "This is a Cursor review branch"
          fi

          if echo "$PR_LABELS" | grep -q "cursor-reviewing"; then
            IS_CURSOR_LABEL="true"
            echo "This PR has cursor-reviewing label (handoff from Jules)"
          fi

          if [[ "$IS_CURSOR_BRANCH" == "false" && "$IS_CURSOR_LABEL" == "false" ]]; then
            echo "Not a Cursor-handled PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Cursor handling PR #$PR_NUMBER"

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "cursor_branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          echo "jules_branch=$PR_BASE" >> "$GITHUB_OUTPUT"
          echo "ci_conclusion=$CI_CONCLUSION" >> "$GITHUB_OUTPUT"
          echo "is_cursor_branch=$IS_CURSOR_BRANCH" >> "$GITHUB_OUTPUT"
          echo "is_handoff=$IS_CURSOR_LABEL" >> "$GITHUB_OUTPUT"

          # Count fix attempts (look for both "Cursor Fix" and general fix comments)
          FIX_ATTEMPTS=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | test("Cursor Fix|Cursor has tried|CI Fix Required"))] | length')
          echo "fix_attempts=$FIX_ATTEMPTS" >> "$GITHUB_OUTPUT"

          # Find the Jules PR (targets beta from jules_branch)
          JULES_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$PR_BASE" \
            --state open \
            --json number \
            --jq '.[0].number // empty')
          echo "jules_pr=$JULES_PR" >> "$GITHUB_OUTPUT"

          # Extract issue number from Jules branch name
          ISSUE_NUM=$(echo "$PR_BASE" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

      # ============ CI PASSED: Handle success ============
      - name: Handle CI success
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          JULES_PR="${{ steps.check.outputs.jules_pr }}"
          JULES_BRANCH="${{ steps.check.outputs.jules_branch }}"
          CURSOR_BRANCH="${{ steps.check.outputs.cursor_branch }}"
          IS_CURSOR_BRANCH="${{ steps.check.outputs.is_cursor_branch }}"
          IS_HANDOFF="${{ steps.check.outputs.is_handoff }}"

          echo "âœ… Checks passed!"

          if [[ "$IS_CURSOR_BRANCH" == "true" ]]; then
            # This is a cursor-review/* branch - merge it into Jules branch
            echo "Merging Cursor PR #$PR_NUMBER into $JULES_BRANCH"

            # Mark PR as ready (in case it's a draft)
            gh pr ready "$PR_NUMBER" --repo "${{ github.repository }}" 2>/dev/null || true

            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## âœ… Checks Passed - Auto-Merging

            All checks passed! Merging into Jules branch \`$JULES_BRANCH\`.

            ---
            *Auto-merged by Cursor workflow*"

            # Merge the Cursor PR
            gh pr merge "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --squash \
              --delete-branch

            # Comment on Jules PR
            if [[ -n "$JULES_PR" ]]; then
              gh pr comment "$JULES_PR" \
                --repo "${{ github.repository }}" \
                --body "## âœ… Cursor Review Complete

            Cursor's code improvements have been merged into this branch.

            **Cursor Branch**: \`$CURSOR_BRANCH\` â†’ deleted âœ…

            This PR is now ready for human review.

            ---
            *Cursor review completed*"

              gh pr edit "$JULES_PR" \
                --repo "${{ github.repository }}" \
                --remove-label "cursor-reviewing" \
                --add-label "cursor-reviewed" \
                --add-label "ready-for-review" 2>/dev/null || true
            fi

          elif [[ "$IS_HANDOFF" == "true" ]]; then
            # This is a handoff case - Cursor pushed directly to Jules branch
            echo "Cursor fixed the Jules PR directly - marking ready for review"

            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## âœ… Cursor Review Complete

            All checks passed! Cursor has fixed the issues.

            This PR is now ready for human review.

            ---
            *Cursor review completed*"

            gh pr edit "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --remove-label "cursor-reviewing" \
              --add-label "cursor-reviewed" \
              --add-label "ready-for-review" 2>/dev/null || true
          fi

      - name: Update issue - ready for review
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'success' && steps.check.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          JULES_PR="${{ steps.check.outputs.jules_pr }}"

          # Use jules_pr if available (cursor-review branch case), otherwise use pr_number (handoff case)
          DISPLAY_PR="${JULES_PR:-$PR_NUMBER}"

          gh issue comment "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --body "## âœ… Ready for Human Review

          Both Jules and Cursor have completed their work.

          **PR**: #$DISPLAY_PR
          **Status**: Ready for human review and merge to beta

          ---
          *Automated update*"

          gh issue edit "$ISSUE_NUM" \
            --repo "${{ github.repository }}" \
            --remove-label "pr-pending" \
            --add-label "ready-for-review" 2>/dev/null || true

      # ============ CI FAILED: Check if escalation or re-invoke needed ============
      - name: Handle CI failure
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.ci_conclusion == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          PR_NUMBER="${{ steps.check.outputs.pr_number }}"
          BRANCH="${{ steps.check.outputs.cursor_branch }}"
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          FIX_ATTEMPTS="${{ steps.check.outputs.fix_attempts }}"
          IS_HANDOFF="${{ steps.check.outputs.is_handoff }}"

          echo "â³ PR #$PR_NUMBER failed CI (attempt $FIX_ATTEMPTS, handoff=$IS_HANDOFF)"

          # After 10 Cursor attempts, escalate to human
          if [[ "$FIX_ATTEMPTS" -ge 10 ]]; then
            echo "ðŸš¨ Cursor has tried 10+ times - escalating to human"

            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## ðŸš¨ Escalation to Human Required

            Cursor has attempted 10+ fixes but CI still fails.

            **Manual intervention required.**

            ---
            *Escalated by Cursor workflow*"

            gh pr edit "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --remove-label "cursor-reviewing" \
              --add-label "needs-human-review" 2>/dev/null || true

            if [[ -n "$ISSUE_NUM" ]]; then
              gh issue comment "$ISSUE_NUM" \
                --repo "${{ github.repository }}" \
                --body "## ðŸš¨ Escalation to Human

            Cursor couldn't fix CI after 10+ attempts. Manual intervention required.

            **PR**: #$PR_NUMBER

            ---
            *Escalated by automation*"

              gh issue edit "$ISSUE_NUM" \
                --repo "${{ github.repository }}" \
                --add-label "needs-human-review" 2>/dev/null || true
            fi

          # If this is a handoff from Jules, we need to invoke Cursor
          elif [[ "$IS_HANDOFF" == "true" ]]; then
            echo "ðŸ”„ Invoking Cursor to fix (handoff from Jules, attempt $((FIX_ATTEMPTS + 1)))"

            # Comment on PR
            gh pr comment "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --body "## ðŸ”§ Cursor Fix Attempt #$((FIX_ATTEMPTS + 1))

            CI failed. Invoking Cursor to fix.

            ---
            *Cursor workflow*"

            # Invoke Cursor API
            PROMPT="## ðŸ”§ CI Fix Required - Attempt #$((FIX_ATTEMPTS + 1))

            ## MANDATORY FIRST STEPS
            1. READ AGENTS.md - Contains project standards
            2. READ DEVELOPMENT.md - Contains environment setup

            Branch: $BRANCH - Push fixes here, do NOT create new PR.

            ## COMMON ERRORS AND FIXES

            ### 'Undefined name MagicMock' or AsyncMock or patch
            Add to test file: from unittest.mock import MagicMock, AsyncMock, patch

            ### 'ModuleNotFoundError: homeassistant'
            Use fixtures from tests/conftest.py, don't import HA directly

            ## Instructions
            1. Run ./run_checks.sh to see failures
            2. Fix the issues (check imports!)
            3. Commit: fix(cursor): resolve CI errors
            4. Push to branch: $BRANCH"

            ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

            curl -sS -X POST "https://api.cursor.com/v0/agents" \
              -u "${CURSOR_API_KEY}:" \
              -H "Content-Type: application/json" \
              -d "{
                \"source\": {
                  \"repository\": \"https://github.com/${{ github.repository }}\",
                  \"ref\": \"$BRANCH\"
                },
                \"prompt\": {
                  \"text\": ${ESCAPED_PROMPT}
                },
                \"target\": {
                  \"branchName\": \"$BRANCH\",
                  \"autoCreatePr\": false
                }
              }" || echo "Cursor API call completed"

          else
            echo "Cursor will automatically fix and push again."
            echo "No action needed - waiting for next CI run."
          fi
