name: Cursor Code Review

run-name: 'Cursor: Review ${{ github.event.workflow_run.head_branch }}'

# When Beta CI passes on a Jules PR, launch Cursor to review
# Cursor creates a PR targeting the Jules branch for isolated review
# Skips if Cursor is already reviewing

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings â†’ Actions â†’ General â†’ Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: read
  issues: write
  pull-requests: write

# Prevent multiple Cursor reviews on same branch
concurrency:
  group: cursor-review-${{ github.event.workflow_run.head_branch || github.event.inputs.pr_number }}
  cancel-in-progress: false

jobs:
  launch-cursor-review:
    runs-on: ubuntu-latest
    # Only run on CI success AND not a cursor-review branch (those are handled by cursor-fix.yaml)
    if: |
      (github.event.workflow_run.conclusion == 'success' && !startsWith(github.event.workflow_run.head_branch, 'cursor-review/'))
      || github.event_name == 'workflow_dispatch'
    # Inherits permissions from workflow level
    steps:
      - name: Get PR details
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger - get PR by number
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            PR_JSON=$(gh pr view "$PR_NUMBER" \
              --repo "${{ github.repository }}" \
              --json number,title,body,author,headRefName,labels)
          else
            # Automatic trigger - find PR by branch
            HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
            echo "Branch: $HEAD_BRANCH"

            PR_JSON=$(gh pr list \
              --repo "${{ github.repository }}" \
              --head "$HEAD_BRANCH" \
              --state open \
              --json number,title,body,author,headRefName,labels \
              --limit 1 | jq '.[0] // {}')
          fi

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title // empty')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.author.login // empty')
          PR_HEAD_REF=$(echo "$PR_JSON" | jq -r '.headRefName // empty')
          PR_LABELS=$(echo "$PR_JSON" | jq -r '[.labels[].name] | join(" ")' 2>/dev/null || echo "")

          echo "PR #$PR_NUMBER: $PR_TITLE"
          echo "Author: $PR_AUTHOR"
          echo "Branch: $PR_HEAD_REF"
          echo "Labels: $PR_LABELS"

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if already Cursor-reviewed or Cursor is reviewing
          if echo "$PR_LABELS" | grep -qE "(cursor-reviewing|cursor-reviewed)"; then
            echo "â­ï¸ Cursor already processed this PR"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Only review Jules PRs
          if [[ "$PR_AUTHOR" != *"jules"* ]] && [[ "$PR_AUTHOR" != *"google-labs"* ]]; then
            echo "Not a Jules PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if this is a Cursor branch (shouldn't happen, but safety check)
          if [[ "$PR_HEAD_REF" == cursor-review/* ]]; then
            echo "This is already a Cursor branch - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "head_ref=$PR_HEAD_REF" >> "$GITHUB_OUTPUT"

          # Extract issue number
          PR_BODY=$(echo "$PR_JSON" | jq -r '.body // empty')
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves) #[0-9]+' | grep -oE '[0-9]+' | head -1)
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$PR_HEAD_REF" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          fi
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

          # Save issue body for context
          if [[ -n "$ISSUE_NUM" ]]; then
            gh issue view "$ISSUE_NUM" --repo "${{ github.repository }}" --json body --jq '.body // ""' > /tmp/issue_body.txt 2>/dev/null || true
          fi

      - name: Add cursor-reviewing label
        if: steps.pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add label BEFORE launching agent to prevent Jules from re-triggering
          gh pr edit ${{ steps.pr.outputs.number }} \
            --repo "${{ github.repository }}" \
            --add-label "cursor-reviewing" 2>/dev/null || true

      - name: Launch Cursor Agent
        id: cursor
        if: steps.pr.outputs.skip != 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          JULES_BRANCH="${{ steps.pr.outputs.head_ref }}"
          CURSOR_BRANCH="cursor-review/${JULES_BRANCH}"

          ISSUE_BODY=""
          if [[ -f /tmp/issue_body.txt ]]; then
            ISSUE_BODY=$(cat /tmp/issue_body.txt)
          fi

          ISSUE_NUM="${{ steps.pr.outputs.issue_number }}"
          PR_NUM="${{ steps.pr.outputs.number }}"
          GH_PAT_VALUE="${GH_PAT:-}"

          # Comprehensive code review prompt
          PROMPT="You are a code review agent for a Home Assistant integration (Cisco Meraki).

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CODE REVIEW TASK
          PR: #$PR_NUM | Issue: #$ISSUE_NUM
          Source Branch: $JULES_BRANCH
          REPO: ${{ github.repository }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          GITHUB AUTHENTICATION:
          If you need to run gh commands and get permission errors, run:
          export GH_TOKEN='${GH_PAT_VALUE}'
          Then retry the command.

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ORIGINAL REQUIREMENTS:
          ${ISSUE_BODY:-See issue #$ISSUE_NUM for requirements}

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          REVIEW CHECKLIST (Check ALL items):
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          â–¡ STEP 1: UNDERSTAND CONTEXT
            - Read AGENTS.md for project patterns and conventions
            - Read issue #$ISSUE_NUM and all comments for full context
            - Review the changes made in PR #$PR_NUM

          â–¡ STEP 2: VERIFY REQUIREMENTS MET
            - Does the implementation address ALL requirements in issue #$ISSUE_NUM?
            - Are there any missing features or edge cases?
            - If requirements are NOT fully met, implement the missing parts

          â–¡ STEP 3: CHECK CODE QUALITY
            Review for:
            - Correct logger usage (MerakiLoggers, not logging.getLogger)
            - Type hints on all functions
            - Proper async/await patterns
            - Error handling and edge cases
            - Code follows existing patterns in codebase
            - No hardcoded secrets or credentials

          â–¡ STEP 4: CHECK TEST COVERAGE
            - Are there tests for new functionality?
            - Do tests cover edge cases?
            - If tests are missing, ADD THEM

          â–¡ STEP 5: VERIFY QUALITY CHECKS
            Run: ./run_checks.sh
            This MUST pass. Fix any errors found.

          â–¡ STEP 6: UPDATE THE ISSUE
            Run this command:
            gh issue comment $ISSUE_NUM --repo ${{ github.repository }} --body \"## ğŸ” Cursor Code Review Complete

            ### Review Findings
            <list what you reviewed>

            ### Changes Made (if any)
            <list any fixes or improvements you made>

            ### Quality Verification
            - [x] Requirements fully implemented
            - [x] Code follows project patterns
            - [x] Tests exist and pass
            - [x] ./run_checks.sh passes

            ---
            *Ready for human review*\"

          â–¡ STEP 7: CREATE REVIEW PR
            - Create PR targeting $JULES_BRANCH (not beta)
            - Include review findings in PR description

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CRITICAL RULES:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          âŒ DO NOT:
            - Skip any checklist items
            - Add unrelated refactoring
            - Change code style preferences
            - Skip running ./run_checks.sh

          âœ… DO:
            - Fix any issues you find
            - Add missing tests
            - Ensure ALL requirements from issue are met
            - Update the issue with your findings

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          COMPLETION: You are DONE when:
          1. All checklist items are verified
          2. ./run_checks.sh passes
          3. Issue has your review comment
          4. Review PR is created targeting $JULES_BRANCH
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          # API call per https://cursor.com/docs/cloud-agent/api/endpoints#launch-an-agent
          RESPONSE=$(curl -sS --request POST \
            --url "https://api.cursor.com/v0/agents" \
            -u "${CURSOR_API_KEY}:" \
            --header "Content-Type: application/json" \
            --data "{
              \"source\": {
                \"repository\": \"https://github.com/${{ github.repository }}\",
                \"ref\": \"$JULES_BRANCH\"
              },
              \"prompt\": {
                \"text\": ${ESCAPED_PROMPT}
              },
              \"target\": {
                \"branchName\": \"$CURSOR_BRANCH\",
                \"autoCreatePr\": true
              }
            }")

          echo "API Response: $RESPONSE"

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [[ -z "$AGENT_ID" ]]; then
            echo "::error::Failed to launch Cursor agent"
            echo "$RESPONSE"
            exit 1
          fi

          echo "agent_id=$AGENT_ID" >> "$GITHUB_OUTPUT"
          echo "cursor_branch=$CURSOR_BRANCH" >> "$GITHUB_OUTPUT"
          echo "âœ… Launched Cursor agent: $AGENT_ID"

      - name: Comment on Jules PR
        if: steps.pr.outputs.skip != 'true' && steps.cursor.outputs.agent_id != ''
        continue-on-error: true # Don't fail workflow if commenting fails
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.pr.outputs.number }} \
            --repo "${{ github.repository }}" \
            --body "## ğŸ” Cursor Code Review Started

          All CI checks passed! Cursor is now performing an in-depth code review.

          **Review Details:**
          | Field | Value |
          |-------|-------|
          | Agent ID | \`${{ steps.cursor.outputs.agent_id }}\` |
          | Review Branch | \`${{ steps.cursor.outputs.cursor_branch }}\` |
          | Target | This PR's branch |

          **What Cursor Reviews:**
          - âœ… **Requirements Compliance** - Does the implementation fully address the issue?
          - âœ… **Code Quality** - Best practices, error handling, type hints
          - âœ… **Test Coverage** - Are new features properly tested?
          - âœ… **Design Patterns** - Does it follow existing codebase patterns?
          - âœ… **Security** - No hardcoded secrets, proper input validation

          **Process:**
          1. Cursor analyzes the code and makes improvements
          2. Creates a PR targeting this branch
          3. Once Cursor's PR passes CI, it will be merged here
          4. Then this PR is ready for final merge to beta

          ---
          *[View Agent Progress](https://cursor.com/agents?id=${{ steps.cursor.outputs.agent_id }})*"

      - name: Update issue with progress
        if: steps.pr.outputs.skip != 'true' && steps.cursor.outputs.agent_id != '' && steps.pr.outputs.issue_number != ''
        continue-on-error: true # Don't fail workflow if commenting fails
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.pr.outputs.issue_number }} \
            --repo "${{ github.repository }}" \
            --body "## ğŸ” Cursor Code Review Started

          CI passed on PR #${{ steps.pr.outputs.number }}. Cursor is reviewing code quality.

          Agent: [${{ steps.cursor.outputs.agent_id }}](https://cursor.com/agents?id=${{ steps.cursor.outputs.agent_id }})

          Cursor will provide detailed review findings."
