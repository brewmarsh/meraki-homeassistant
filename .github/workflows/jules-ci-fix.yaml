name: Jules CI Self-Heal

run-name: 'Jules: Fix CI on ${{ github.event.workflow_run.head_branch }}'

# When Beta CI fails on a Jules PR, comment @jules with error details
# Jules will automatically see the mention and fix the issues
# Skips if Cursor has taken over (cursor-reviewing label)

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

# Prevent multiple Jules fix agents on same branch
concurrency:
  group: jules-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  jules-self-heal:
    runs-on: ubuntu-latest
    # Only run on CI failures
    if: github.event.workflow_run.conclusion == 'failure'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Check if Jules should fix
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "Branch: $HEAD_BRANCH"

          # Find the PR for this branch
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number,body,author,labels \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.[0].author.login // empty')
          PR_LABELS=$(echo "$PR_JSON" | jq -r '[.[0].labels[].name] | join(" ")' 2>/dev/null || echo "")

          echo "PR #$PR_NUMBER by $PR_AUTHOR"
          echo "Labels: $PR_LABELS"

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if Cursor has taken over
          if echo "$PR_LABELS" | grep -q "cursor-reviewing"; then
            echo "â­ï¸ Cursor is reviewing - Jules should not interfere"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Only fix Jules PRs
          if [[ "$PR_AUTHOR" != *"jules"* ]] && [[ "$PR_AUTHOR" != *"google-labs"* ]]; then
            echo "Not a Jules PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if this is a Cursor PR (cursor-review/* branch)
          if [[ "$HEAD_BRANCH" == cursor-review/* ]]; then
            echo "This is a Cursor PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"

          # Count fix attempts
          FIX_ATTEMPTS=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | contains("Jules Fix Attempt"))] | length')
          echo "fix_attempts=$FIX_ATTEMPTS" >> "$GITHUB_OUTPUT"

          # Extract issue number
          PR_BODY=$(echo "$PR_JSON" | jq -r '.[0].body // empty')
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves) #[0-9]+' | grep -oE '[0-9]+' | head -1)
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$HEAD_BRANCH" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          fi
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

      - name: Check escalation threshold
        id: escalate
        if: steps.check.outputs.skip != 'true'
        run: |
          FIX_ATTEMPTS="${{ steps.check.outputs.fix_attempts }}"

          if [[ "$FIX_ATTEMPTS" -ge 5 ]]; then
            echo "should_escalate=true" >> "$GITHUB_OUTPUT"
            echo "ðŸš¨ 5+ fix attempts - escalating to human"
          else
            echo "should_escalate=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Escalate to human
        if: steps.escalate.outputs.should_escalate == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"

          gh pr comment "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --body "## ðŸš¨ Escalation Required

          Jules has attempted 5+ fixes but CI still fails.

          **Manual intervention required.**

          ---
          *Escalated by Jules workflow*"

          gh pr edit "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --add-label "needs-human-review" 2>/dev/null || true

          if [[ -n "$ISSUE_NUM" ]]; then
            gh issue comment "$ISSUE_NUM" \
              --repo "${{ github.repository }}" \
              --body "## ðŸš¨ Jules Escalated

            Jules couldn't fix CI after 5 attempts. Human intervention required.

            **PR**: #$PR_NUM

            ---
            *Escalated by automation*"

            gh issue edit "$ISSUE_NUM" \
              --repo "${{ github.repository }}" \
              --add-label "needs-human-review" 2>/dev/null || true
          fi

      - name: Get CI failure details
        id: ci_failure
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.should_escalate != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          REPO="${{ github.repository }}"

          # Get failed job names
          FAILED_JOBS=$(gh run view "$RUN_ID" --repo "$REPO" --json jobs \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")')
          echo "failed_jobs=$FAILED_JOBS" >> "$GITHUB_OUTPUT"

          # Download detailed error logs
          mkdir -p /tmp/logs
          gh run view "$RUN_ID" --repo "$REPO" --log-failed 2>/dev/null | tail -300 > /tmp/logs/ci_errors.txt || true

          # Save for the invoke step
          echo "CI Errors captured: $(wc -l < /tmp/logs/ci_errors.txt) lines"

      - name: Read CI error logs
        id: errors
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.should_escalate != 'true'
        run: |
          CI_ERRORS=""
          if [[ -f /tmp/logs/ci_errors.txt ]]; then
            # Get first 100 lines of errors to keep comment manageable
            CI_ERRORS=$(cat /tmp/logs/ci_errors.txt | head -100)
          fi
          # Save to env file for multiline
          echo "CI_ERRORS<<EOF" >> "$GITHUB_ENV"
          echo "$CI_ERRORS" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Comment @jules to request fix
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.should_escalate != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FIX_NUM=$(( ${{ steps.check.outputs.fix_attempts }} + 1 ))
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          BRANCH="${{ steps.check.outputs.branch }}"
          FAILED_JOBS="${{ steps.ci_failure.outputs.failed_jobs }}"

          # Comment with @jules mention - Jules will automatically pick this up
          gh pr comment "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --body "@jules

          ## ðŸ”§ CI Fix Required - Attempt #$FIX_NUM

          The CI pipeline failed. Please fix the issues and push to branch: \`$BRANCH\`

          ### Failed Jobs
          $FAILED_JOBS

          ### Error Logs
          \`\`\`
          ${{ env.CI_ERRORS }}
          \`\`\`

          ### Instructions
          1. Analyze the error logs above
          2. Fix ONLY the specific errors shown
          3. Run \`./run_checks.sh\` to verify all checks pass
          4. Commit with: \`fix(jules): resolve CI errors - attempt #$FIX_NUM\`
          5. Push to branch: \`$BRANCH\`

          ---
          *Jules Fix Attempt #$FIX_NUM - [View CI Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})*"

      - name: Update issue with progress
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.should_escalate != 'true' && steps.check.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FIX_NUM=$(( ${{ steps.check.outputs.fix_attempts }} + 1 ))

          gh issue comment ${{ steps.check.outputs.issue_number }} \
            --repo "${{ github.repository }}" \
            --body "## ðŸ”§ Jules Fix Attempt #$FIX_NUM

          CI failed on PR #${{ steps.check.outputs.pr_number }}.

          **Failed:** ${{ steps.ci_failure.outputs.failed_jobs }}

          @jules has been notified to fix the issues.

          ---
          *Automated progress update*"
