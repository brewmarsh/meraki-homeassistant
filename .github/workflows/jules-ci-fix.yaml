name: Jules CI Self-Heal

run-name: 'Jules: Fix CI on ${{ github.event.workflow_run.head_branch }}'

# When Beta CI fails on a Jules PR, invoke Jules via API to fix the errors
# Jules will analyze the failures and push fixes to the same branch
# Skips if Cursor has taken over (cursor-reviewing label)

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

# Prevent multiple Jules fix agents on same branch
concurrency:
  group: jules-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  jules-self-heal:
    runs-on: ubuntu-latest
    # Only run on CI failures
    if: github.event.workflow_run.conclusion == 'failure'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Check if Jules should fix
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "Branch: $HEAD_BRANCH"

          # Find the PR for this branch
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number,body,author,labels \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.[0].author.login // empty')
          PR_LABELS=$(echo "$PR_JSON" | jq -r '[.[0].labels[].name] | join(" ")' 2>/dev/null || echo "")

          echo "PR #$PR_NUMBER by $PR_AUTHOR"
          echo "Labels: $PR_LABELS"

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if Cursor has taken over
          if echo "$PR_LABELS" | grep -q "cursor-reviewing"; then
            echo "â­ï¸ Cursor is reviewing - Jules should not interfere"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Only fix Jules PRs
          if [[ "$PR_AUTHOR" != *"jules"* ]] && [[ "$PR_AUTHOR" != *"google-labs"* ]]; then
            echo "Not a Jules PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if this is a Cursor PR (cursor-review/* branch)
          if [[ "$HEAD_BRANCH" == cursor-review/* ]]; then
            echo "This is a Cursor PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"

          # Count fix attempts
          FIX_ATTEMPTS=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | contains("Jules Fix Attempt"))] | length')
          echo "fix_attempts=$FIX_ATTEMPTS" >> "$GITHUB_OUTPUT"

          # Extract issue number
          PR_BODY=$(echo "$PR_JSON" | jq -r '.[0].body // empty')
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves) #[0-9]+' | grep -oE '[0-9]+' | head -1)
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$HEAD_BRANCH" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          fi
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

      - name: Check escalation threshold
        id: escalate
        if: steps.check.outputs.skip != 'true'
        run: |
          FIX_ATTEMPTS="${{ steps.check.outputs.fix_attempts }}"

          # Jules only tries 3 times, then hands off to Cursor
          # After handoff, the cursor-reviewing label prevents Jules from running again
          # Human escalation is handled separately by Cursor workflow
          if [[ "$FIX_ATTEMPTS" -ge 3 ]]; then
            echo "should_escalate=false" >> "$GITHUB_OUTPUT"
            echo "handoff_to_cursor=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ”„ 3+ Jules attempts - handing off to Cursor"
          else
            echo "should_escalate=false" >> "$GITHUB_OUTPUT"
            echo "handoff_to_cursor=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Hand off to Cursor
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          BRANCH="${{ steps.check.outputs.branch }}"
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"

          echo "ðŸ”„ Jules couldn't fix after 3 attempts - handing off to Cursor"

          # Comment on PR
          gh pr comment "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --body "## ðŸ”„ Handoff to Cursor

          Jules attempted 3 fixes but CI still fails.
          Handing off to Cursor for a fresh perspective.

          ---
          *Automated handoff*"

          # Add cursor-reviewing label to prevent Jules from trying again
          gh pr edit "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --add-label "cursor-reviewing" 2>/dev/null || true

          # Launch Cursor agent
          PROMPT="## ðŸ”§ CI Fix Required (Handoff from Jules)

          Jules attempted 3 fixes but CI still fails on branch \`$BRANCH\`.
          Please analyze the issues with fresh eyes and fix them.

          ### Instructions
          1. Read DEVELOPMENT.md and AGENTS.md to understand project standards
          2. Checkout branch: $BRANCH
          3. Run ./run_checks.sh to see the current failures
          4. Fix the issues - Jules may have been going in the wrong direction
          5. Commit with: fix(cursor): resolve CI errors after Jules handoff
          6. Push to branch: $BRANCH

          ### Testing Notes
          When running tests, you may see: ModuleNotFoundError: No module named 'homeassistant'
          This is expected. Use fixtures from conftest.py and mock HA imports.

          ### Quality Checks
          Run: ./run_checks.sh
          All checks (ruff, bandit, mypy, pytest) must pass."

          # Call Cursor API
          RESPONSE=$(curl -s -X POST "https://api.cursor.com/v0/agents" \
            -H "Authorization: Bearer $CURSOR_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"prompt\": $(echo "$PROMPT" | jq -Rs .),
              \"source\": {
                \"type\": \"github\",
                \"owner\": \"${{ github.repository_owner }}\",
                \"repo\": \"$(echo '${{ github.repository }}' | cut -d'/' -f2)\",
                \"ref\": \"$BRANCH\"
              },
              \"target\": {
                \"type\": \"github\",
                \"autoCreatePr\": false,
                \"openAsCursorGithubApp\": true
              }
            }")

          echo "Cursor API Response: $RESPONSE"

          if [[ -n "$ISSUE_NUM" ]]; then
            gh issue comment "$ISSUE_NUM" \
              --repo "${{ github.repository }}" \
              --body "## ðŸ”„ Handoff to Cursor

            Jules couldn't fix CI after 3 attempts.
            Cursor has been invoked to try with a fresh perspective.

            **PR**: #$PR_NUM

            ---
            *Automated handoff*"
          fi

      # Note: Human escalation is handled by cursor-fix.yaml after Cursor attempts fail

      - name: Get CI failure details
        id: ci_failure
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          REPO="${{ github.repository }}"

          # Get failed job names
          FAILED_JOBS=$(gh run view "$RUN_ID" --repo "$REPO" --json jobs \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")')
          echo "failed_jobs=$FAILED_JOBS" >> "$GITHUB_OUTPUT"

          # Download detailed error logs
          mkdir -p /tmp/logs
          gh run view "$RUN_ID" --repo "$REPO" --log-failed 2>/dev/null | tail -300 > /tmp/logs/ci_errors.txt || true

          # Save for the invoke step
          echo "CI Errors captured: $(wc -l < /tmp/logs/ci_errors.txt) lines"

      - name: Read CI error logs
        id: errors
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        run: |
          CI_ERRORS=""
          if [[ -f /tmp/logs/ci_errors.txt ]]; then
            # Get first 100 lines of errors to keep comment manageable
            CI_ERRORS=$(cat /tmp/logs/ci_errors.txt | head -100)
          fi
          # Save to output (delimiter approach for multiline)
          {
            echo "ci_errors<<ERRORS_EOF"
            echo "$CI_ERRORS"
            echo "ERRORS_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Invoke Jules to fix CI
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        uses: google-labs-code/jules-action@v1.0.0
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            ## ðŸ”§ CI Fix Required - Attempt #$(( ${{ steps.check.outputs.fix_attempts }} + 1 ))

            The CI pipeline failed on branch `${{ steps.check.outputs.branch }}`.
            Fix the issues and push to the same branch.

            ### Failed Jobs
            ${{ steps.ci_failure.outputs.failed_jobs }}

            ### Error Logs
            ```
            ${{ steps.errors.outputs.ci_errors }}
            ```

            ### Instructions
            1. Read DEVELOPMENT.md and AGENTS.md to understand project standards
            2. Analyze the error logs above
            3. Fix ONLY the specific errors shown - do not refactor unrelated code
            4. Use Python 3.13.2 for all Python code
            5. Run `./run_checks.sh` to verify all checks pass
            6. Commit with: `fix(jules): resolve CI errors`
            7. Push to branch: `${{ steps.check.outputs.branch }}`

            ### Testing Notes
            When running tests, you may see: ModuleNotFoundError: No module named 'homeassistant'
            This is expected. The pytest-homeassistant-custom-component plugin provides HA fixtures.
            Use fixtures from conftest.py and mock direct HA imports.

            ### Quality Checks
            Run: ./run_checks.sh
            This runs ruff, bandit, mypy, and pytest. All must pass.

      - name: Comment on PR about fix attempt
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FIX_NUM=$(( ${{ steps.check.outputs.fix_attempts }} + 1 ))
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          FAILED_JOBS="${{ steps.ci_failure.outputs.failed_jobs }}"

          gh pr comment "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --body "## ðŸ”§ Jules Fix Attempt #$FIX_NUM

          CI failed. Jules has been invoked to fix the issues.

          **Failed Jobs:** $FAILED_JOBS

          ---
          *[View CI Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})*"

      - name: Update issue with progress
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true' && steps.check.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FIX_NUM=$(( ${{ steps.check.outputs.fix_attempts }} + 1 ))

          gh issue comment ${{ steps.check.outputs.issue_number }} \
            --repo "${{ github.repository }}" \
            --body "## ðŸ”§ Jules Fix Attempt #$FIX_NUM

          CI failed on PR #${{ steps.check.outputs.pr_number }}.

          **Failed:** ${{ steps.ci_failure.outputs.failed_jobs }}

          @jules has been notified to fix the issues.

          ---
          *Automated progress update*"
