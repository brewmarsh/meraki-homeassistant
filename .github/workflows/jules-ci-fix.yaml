name: Jules CI Self-Heal

run-name: 'Jules: Fix CI on ${{ github.event.workflow_run.head_branch }}'

# When Beta CI fails on a Jules PR, invoke Jules via API to fix the errors
# Jules will analyze the failures and push fixes to the same branch
# Skips if Cursor has taken over (cursor-reviewing label)

on:
  workflow_run:
    workflows: ['Beta CI']
    types:
      - completed

# IMPORTANT: Repository settings must also allow workflow permissions
# Go to: Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions
# Select: "Read and write permissions"
permissions:
  contents: write
  issues: write
  pull-requests: write

# Prevent multiple Jules fix agents on same branch
concurrency:
  group: jules-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  jules-self-heal:
    runs-on: ubuntu-latest
    # Only run on CI failures
    if: github.event.workflow_run.conclusion == 'failure'
    # Inherits permissions from workflow level
    steps:
      - name: Check if Jules should fix
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"

          echo "Branch: $HEAD_BRANCH"

          # Find the PR for this branch
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "$HEAD_BRANCH" \
            --state open \
            --json number,body,author,labels,baseRefName \
            --limit 1)

          PR_BASE=$(echo "$PR_JSON" | jq -r '.[0].baseRefName // empty')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.[0].author.login // empty')
          PR_LABELS=$(echo "$PR_JSON" | jq -r '[.[0].labels[].name] | join(" ")' 2>/dev/null || echo "")

          # Determine if this is a fix PR (targets another Jules branch) or original PR (targets beta)
          IS_FIX_PR="false"
          if [[ -n "$PR_BASE" ]] && [[ "$PR_BASE" != "beta" ]] && [[ "$PR_BASE" != "main" ]]; then
            # This is a fix PR targeting another branch
            # Only proceed if it's a Jules PR and the target is also a Jules branch
            if [[ "$PR_AUTHOR" == *"jules"* ]] || [[ "$PR_AUTHOR" == *"google-labs"* ]]; then
              IS_FIX_PR="true"
              echo "This is a Jules fix PR targeting $PR_BASE"
            else
              echo "PR targets $PR_BASE (not beta/main) and not a Jules author - skipping"
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          # Skip PRs targeting main
          if [[ "$PR_BASE" == "main" ]]; then
            echo "PR targets main - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "PR #$PR_NUMBER by $PR_AUTHOR"
          echo "Labels: $PR_LABELS"

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if Cursor has taken over
          if echo "$PR_LABELS" | grep -q "cursor-reviewing"; then
            echo "‚è≠Ô∏è Cursor is reviewing - Jules should not interfere"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Only fix Jules PRs
          if [[ "$PR_AUTHOR" != *"jules"* ]] && [[ "$PR_AUTHOR" != *"google-labs"* ]]; then
            echo "Not a Jules PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip if this is a Cursor PR (cursor-review/* branch)
          if [[ "$HEAD_BRANCH" == cursor-review/* ]]; then
            echo "This is a Cursor PR - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "branch=$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
          echo "base_branch=$PR_BASE" >> "$GITHUB_OUTPUT"
          echo "is_fix_pr=$IS_FIX_PR" >> "$GITHUB_OUTPUT"

          # Count fix attempts - for fix PRs, also count attempts on original PR
          FIX_ATTEMPTS=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json comments \
            --jq '[.comments[] | select(.body | contains("Jules Fix Attempt") or contains("CI Fix"))] | length')
          echo "fix_attempts=$FIX_ATTEMPTS" >> "$GITHUB_OUTPUT"

          # Extract issue number from branch or PR body
          PR_BODY=$(echo "$PR_JSON" | jq -r '.[0].body // empty')
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oiE '(closes|fixes|resolves) #[0-9]+' | grep -oE '[0-9]+' | head -1)
          if [[ -z "$ISSUE_NUM" ]]; then
            ISSUE_NUM=$(echo "$HEAD_BRANCH" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          fi
          if [[ -z "$ISSUE_NUM" ]] && [[ "$IS_FIX_PR" == "true" ]]; then
            # For fix PRs, try to get issue from the base branch name
            ISSUE_NUM=$(echo "$PR_BASE" | grep -oE '[-/][0-9]+[-/]' | grep -oE '[0-9]+' | head -1)
          fi
          echo "issue_number=$ISSUE_NUM" >> "$GITHUB_OUTPUT"

      - name: Check escalation threshold
        id: escalate
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FIX_ATTEMPTS="${{ steps.check.outputs.fix_attempts }}"
          IS_FIX_PR="${{ steps.check.outputs.is_fix_pr }}"
          BASE_BRANCH="${{ steps.check.outputs.base_branch }}"

          # For fix PRs, also count attempts from the original PR
          TOTAL_ATTEMPTS="$FIX_ATTEMPTS"
          if [[ "$IS_FIX_PR" == "true" ]]; then
            # Find the original PR (targeting beta from BASE_BRANCH)
            ORIGINAL_PR=$(gh pr list \
              --repo "${{ github.repository }}" \
              --head "$BASE_BRANCH" \
              --state open \
              --json number \
              --jq '.[0].number // empty')

            if [[ -n "$ORIGINAL_PR" ]]; then
              ORIGINAL_ATTEMPTS=$(gh pr view "$ORIGINAL_PR" --repo "${{ github.repository }}" --json comments \
                --jq '[.comments[] | select(.body | contains("Jules Fix Attempt") or contains("CI Fix"))] | length')
              TOTAL_ATTEMPTS=$((FIX_ATTEMPTS + ORIGINAL_ATTEMPTS))
              echo "Original PR #$ORIGINAL_PR has $ORIGINAL_ATTEMPTS attempts, total=$TOTAL_ATTEMPTS"
              echo "original_pr=$ORIGINAL_PR" >> "$GITHUB_OUTPUT"
            fi
          fi

          # Jules only tries 3 times total, then hands off to Cursor
          # After handoff, the cursor-reviewing label prevents Jules from running again
          if [[ "$TOTAL_ATTEMPTS" -ge 3 ]]; then
            echo "should_escalate=false" >> "$GITHUB_OUTPUT"
            echo "handoff_to_cursor=true" >> "$GITHUB_OUTPUT"
            echo "üîÑ 3+ total Jules attempts - handing off to Cursor"
          else
            echo "should_escalate=false" >> "$GITHUB_OUTPUT"
            echo "handoff_to_cursor=false" >> "$GITHUB_OUTPUT"
          fi
          echo "total_attempts=$TOTAL_ATTEMPTS" >> "$GITHUB_OUTPUT"

      - name: Hand off to Cursor
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          BRANCH="${{ steps.check.outputs.branch }}"
          BASE_BRANCH="${{ steps.check.outputs.base_branch }}"
          IS_FIX_PR="${{ steps.check.outputs.is_fix_pr }}"
          ORIGINAL_PR="${{ steps.escalate.outputs.original_pr }}"
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"

          echo "üîÑ Jules couldn't fix after 3 attempts - handing off to Cursor"

          # For fix PRs, we need to:
          # 1. Close the fix PR (not needed anymore)
          # 2. Hand off the ORIGINAL PR to Cursor
          # 3. Cursor works on the original branch
          if [[ "$IS_FIX_PR" == "true" ]] && [[ -n "$ORIGINAL_PR" ]]; then
            TARGET_PR="$ORIGINAL_PR"
            TARGET_BRANCH="$BASE_BRANCH"

            # Close the fix PR with a comment
            gh pr comment "$PR_NUM" \
              --repo "${{ github.repository }}" \
              --body "## üîÑ Closing - Handoff to Cursor

            Jules fix attempts exhausted. Handing off original PR to Cursor.
            This fix PR is no longer needed.

            ---
            *Automated handoff*"

            gh pr close "$PR_NUM" --repo "${{ github.repository }}" --delete-branch 2>/dev/null || true
          else
            TARGET_PR="$PR_NUM"
            TARGET_BRANCH="$BRANCH"
          fi

          # Comment on the target PR
          gh pr comment "$TARGET_PR" \
            --repo "${{ github.repository }}" \
            --body "## üîÑ Handoff to Cursor

          Jules attempted 3 fixes but CI still fails.
          Handing off to Cursor for a fresh perspective.

          ---
          *Automated handoff*"

          # Add cursor-reviewing label to prevent Jules from trying again
          gh pr edit "$TARGET_PR" \
            --repo "${{ github.repository }}" \
            --add-label "cursor-reviewing" 2>/dev/null || true

          # Launch Cursor agent on the TARGET branch
          PROMPT="## Handoff from Jules - Branch: $TARGET_BRANCH
          Issue: #$ISSUE_NUM | Jules tried 3x, now your turn.

          ---
          1. Read AGENTS.md, issue #$ISSUE_NUM comments
          2. Run ./run_checks.sh
          3. Fix with fresh perspective
          4. Update issue: \`gh issue comment $ISSUE_NUM --body '## ü§ù Fixed: <what/why>'\`
          5. Commit: fix(cursor): resolve CI errors after Jules handoff"

          # Call Cursor API
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          RESPONSE=$(curl -sS -X POST "https://api.cursor.com/v0/agents" \
            -u "${CURSOR_API_KEY}:" \
            -H "Content-Type: application/json" \
            -d "{
              \"source\": {
                \"repository\": \"https://github.com/${{ github.repository }}\",
                \"ref\": \"$TARGET_BRANCH\"
              },
              \"prompt\": {
                \"text\": ${ESCAPED_PROMPT}
              },
              \"target\": {
                \"branchName\": \"$TARGET_BRANCH\",
                \"autoCreatePr\": false
              }
            }")

          echo "Cursor API Response: $RESPONSE"

          AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [[ -n "$ISSUE_NUM" ]]; then
            gh issue comment "$ISSUE_NUM" \
              --repo "${{ github.repository }}" \
              --body "## üîÑ Handoff: Jules ‚Üí Cursor

            Jules exhausted 3 fix attempts. Cursor is taking over.

            | PR | Branch | Agent |
            |----|--------|-------|
            | #$TARGET_PR | \`$TARGET_BRANCH\` | [${AGENT_ID:-...}](https://cursor.com/agents?id=$AGENT_ID) |

            Cursor will provide detailed updates."
          fi

      # Note: Human escalation is handled by cursor-fix.yaml after Cursor attempts fail

      # Extract what the AI changed in the last commit (for human context)
      - name: Get previous AI changes
        id: ai_changes
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"

          # Get the last commit on this PR
          LAST_COMMIT=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json commits \
            --jq '.commits[-1] | {sha: .oid[0:7], message: .messageHeadline, author: .authors[0].login}')

          COMMIT_SHA=$(echo "$LAST_COMMIT" | jq -r '.sha // empty')
          COMMIT_MSG=$(echo "$LAST_COMMIT" | jq -r '.message // empty')
          COMMIT_AUTHOR=$(echo "$LAST_COMMIT" | jq -r '.author // empty')

          # Get files changed in the last commit
          if [[ -n "$COMMIT_SHA" ]]; then
            FILES_CHANGED=$(gh api "repos/${{ github.repository }}/commits/${COMMIT_SHA}" \
              --jq '[.files[].filename] | join(", ")' 2>/dev/null || echo "Unable to fetch files")
          else
            FILES_CHANGED="No commits found"
          fi

          echo "commit_sha=$COMMIT_SHA" >> "$GITHUB_OUTPUT"
          echo "commit_msg=$COMMIT_MSG" >> "$GITHUB_OUTPUT"
          echo "commit_author=$COMMIT_AUTHOR" >> "$GITHUB_OUTPUT"
          {
            echo "files_changed<<EOF"
            echo "$FILES_CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Get CI failure details
        id: ci_failure
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"
          REPO="${{ github.repository }}"

          # Get failed job names
          FAILED_JOBS=$(gh run view "$RUN_ID" --repo "$REPO" --json jobs \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")')
          echo "failed_jobs=$FAILED_JOBS" >> "$GITHUB_OUTPUT"

          # Download detailed error logs
          mkdir -p /tmp/logs
          gh run view "$RUN_ID" --repo "$REPO" --log-failed 2>/dev/null | tail -300 > /tmp/logs/ci_errors.txt || true

          # Save for the invoke step
          echo "CI Errors captured: $(wc -l < /tmp/logs/ci_errors.txt) lines"

      - name: Read CI error logs
        id: errors
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        run: |
          CI_ERRORS=""
          if [[ -f /tmp/logs/ci_errors.txt ]]; then
            # Get first 100 lines of errors to keep comment manageable
            CI_ERRORS=$(cat /tmp/logs/ci_errors.txt | head -100)
          fi
          # Save to output (delimiter approach for multiline)
          {
            echo "ci_errors<<ERRORS_EOF"
            echo "$CI_ERRORS"
            echo "ERRORS_EOF"
          } >> "$GITHUB_OUTPUT"

      # For fix PRs that fail: merge partial fixes back into original branch first
      # This ensures each fix attempt builds on previous work
      - name: Merge failed fix PR into original branch
        id: merge_fix
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true' && steps.check.outputs.is_fix_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          BASE_BRANCH="${{ steps.check.outputs.base_branch }}"

          echo "üì¶ Merging failed fix PR #$PR_NUM into $BASE_BRANCH (preserving partial fixes)"

          # Mark as ready if draft
          gh pr ready "$PR_NUM" --repo "${{ github.repository }}" 2>/dev/null || true

          # Comment on fix PR
          gh pr comment "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --body "## üì¶ Merging Partial Fixes

          CI failed, but merging partial fixes into \`$BASE_BRANCH\` so next attempt can build on this progress.

          ---
          *Automated by Jules CI Self-Heal*"

          # Squash merge (preserves changes, clean history)
          # Note: This bypasses branch protection - requires admin token or relaxed settings
          gh pr merge "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --squash \
            --delete-branch \
            --admin 2>/dev/null || {
              # If admin merge fails, try regular merge
              gh pr merge "$PR_NUM" \
                --repo "${{ github.repository }}" \
                --squash \
                --delete-branch 2>/dev/null || {
                  echo "‚ö†Ô∏è Could not merge fix PR - branch protection may be blocking"
                  echo "merge_failed=true" >> "$GITHUB_OUTPUT"
                }
            }

          echo "‚úÖ Merged fix PR #$PR_NUM into $BASE_BRANCH"
          echo "target_branch=$BASE_BRANCH" >> "$GITHUB_OUTPUT"

      # Determine which branch Jules should start from
      # - For fix PRs: start from original branch (now has partial fixes merged)
      # - For original PRs: start from current branch
      - name: Invoke Jules to fix CI
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        env:
          STARTING_BRANCH: ${{ steps.check.outputs.is_fix_pr == 'true' && steps.check.outputs.base_branch || steps.check.outputs.branch }}
        uses: google-labs-code/jules-action@v1.0.0
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: ${{ env.STARTING_BRANCH }}
          # MINIMAL PROMPT - Only CI errors, no issue/commit/comment context
          # Jules can run git commands if it needs more info
          prompt: |
            ## üîß CI Fix #$(( ${{ steps.escalate.outputs.total_attempts }} + 1 ))

            ### Failed: ${{ steps.ci_failure.outputs.failed_jobs }}

            ```
            ${{ steps.errors.outputs.ci_errors }}
            ```

            ## üìù CRITICAL: Update Issue #${{ steps.check.outputs.issue_number }}
            Future AI agents will read your comments. After fixing, run:
            ```bash
            gh issue comment ${{ steps.check.outputs.issue_number }} --body "## ü§ñ Jules CI Fix

            ### What Failed
            <Job name and error>

            ### What I Fixed
            <Files changed and why>

            ### Root Cause
            <Why this error occurred>

            ---
            *Fix attempt #$(( ${{ steps.escalate.outputs.total_attempts }} + 1 ))*"
            ```

            ## Quick Fixes
            - `MagicMock/AsyncMock/patch undefined` ‚Üí `from unittest.mock import MagicMock, AsyncMock, patch`
            - `ModuleNotFoundError: homeassistant` ‚Üí Use fixtures from `tests/conftest.py`
            - `F821 Undefined name` ‚Üí Add missing import

            ## Do This
            1. `./run_checks.sh` to verify errors
            2. Fix ONLY errors above
            3. Update issue with what you changed and why
            4. Commit: `fix(jules): resolve CI errors`
            5. PR target: `${{ steps.check.outputs.base_branch || 'beta' }}`

            ## ‚ö†Ô∏è NEVER STOP - Ask Cursor for Help
            If you cannot fix these errors after 1-2 attempts:
            1. Add label `jules-needs-help` to the PR
            2. Comment: "üÜò Jules Needs Cursor Help" + what you tried
            NEVER wait for a human. Cursor will take over immediately.

      - name: Comment on PR about fix attempt
        if: steps.check.outputs.skip != 'true' && steps.escalate.outputs.handoff_to_cursor != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TOTAL_ATTEMPTS="${{ steps.escalate.outputs.total_attempts }}"
          FIX_NUM=$((TOTAL_ATTEMPTS + 1))
          PR_NUM="${{ steps.check.outputs.pr_number }}"
          FAILED_JOBS="${{ steps.ci_failure.outputs.failed_jobs }}"
          IS_FIX_PR="${{ steps.check.outputs.is_fix_pr }}"
          ORIGINAL_PR="${{ steps.escalate.outputs.original_pr }}"

          # Comment on the current PR
          gh pr comment "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --body "## üîß Jules CI Fix #$FIX_NUM

          CI failed. Jules invoked to fix.

          **Failed:** $FAILED_JOBS

          ---
          *[CI Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})*"

          # For fix PRs, also comment on the original PR to track total attempts
          if [[ "$IS_FIX_PR" == "true" ]] && [[ -n "$ORIGINAL_PR" ]]; then
            gh pr comment "$ORIGINAL_PR" \
              --repo "${{ github.repository }}" \
              --body "## üîß Jules CI Fix #$FIX_NUM (via Fix PR #$PR_NUM)

            Fix PR #$PR_NUM failed CI. Jules invoked again.

            **Failed:** $FAILED_JOBS

            ---
            *[CI Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})*"
          fi

      # Note: Detailed issue updates are now done by Jules directly during its run
      # The workflow only provides brief status markers
