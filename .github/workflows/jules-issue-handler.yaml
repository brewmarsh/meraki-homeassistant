name: Jules Issue Handler

run-name: 'Jules: ${{ github.event.issue.title }} (#${{ github.event.issue.number }})'

# Invokes Jules to work on issues labeled with 'jules-issue'

on:
  issues:
    types:
      - labeled
      - opened

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: jules-issue-${{ github.event.issue.number }}
  cancel-in-progress: true # Cancel duplicate runs

jobs:
  handle-issue:
    # For 'labeled' event: only trigger when 'jules-issue' label is added (not other labels)
    # For 'opened' event: check if issue has the label
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'jules-issue') ||
      (github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'jules-issue'))
    runs-on: ubuntu-latest
    steps:
      - name: Check authorization
        run: |
          SENDER="${{ github.event.sender.login }}"
          if [[ "$SENDER" == "liptonj" ]] || [[ "$SENDER" == *"[bot]" ]]; then
            echo "âœ… Authorized: $SENDER"
          else
            echo "::error::User $SENDER not authorized"
            exit 1
          fi

      - name: Check for existing PR
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Search for PRs that reference this issue
          EXISTING_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --search "in:body Closes #$ISSUE_NUM OR in:body Fixes #$ISSUE_NUM OR in:body Resolves #$ISSUE_NUM" \
            --json number,headRefName \
            --jq '.[0].number // empty' 2>/dev/null || echo "")

          if [[ -n "$EXISTING_PR" ]]; then
            echo "â­ï¸ PR #$EXISTING_PR already exists for issue #$ISSUE_NUM - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "No existing PR found - proceeding"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Start issue
        if: steps.existing.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ğŸ¤– Jules Started

          Working on this task. Updates will follow.

          ---
          *@${{ github.event.sender.login }}*"

          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --add-label "in-progress"

      - name: Checkout
        if: steps.existing.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: beta
          fetch-depth: 1

      - name: Invoke Jules
        if: steps.existing.outputs.skip != 'true'
        uses: google-labs-code/jules-action@v1.0.0
        with:
          starting_branch: beta
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          # Disable commit context to keep prompt focused
          include_last_commit: false
          include_commit_log: false
          prompt: |
            You are a coding agent for a Home Assistant integration (Cisco Meraki).

            Your plan is auto-approved - proceed immediately without waiting for human interaction.

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            TASK: ${{ github.event.issue.title }}
            ISSUE: #${{ github.event.issue.number }}
            REPO: ${{ github.repository }}
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            REQUIREMENTS:
            ${{ github.event.issue.body }}

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            MANDATORY STEPS (Complete ALL before finishing):
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            â–¡ STEP 1: UNDERSTAND THE CODEBASE
              - Read AGENTS.md for project patterns and conventions
              - Read issue #${{ github.event.issue.number }} comments for any prior context
              - Identify relevant files to modify

            â–¡ STEP 2: IMPLEMENT THE SOLUTION
              - Follow existing code patterns exactly
              - Use the correct logger: MerakiLoggers (see AGENTS.md section 3.2)
              - Add type hints to all functions
              - Use async/await for I/O operations
              - Do NOT add unrelated changes or refactoring

            â–¡ STEP 3: ADD/UPDATE TESTS
              - Add unit tests for any new functionality
              - Ensure bug fixes have regression tests
              - Tests go in tests/ directory mirroring source structure

            â–¡ STEP 4: VERIFY QUALITY (REQUIRED)
              Run: ./run_checks.sh
              This MUST pass with no errors. If it fails:
              - Fix the errors
              - Run again until it passes
              - Do NOT proceed until all checks pass

            â–¡ STEP 5: UPDATE THE ISSUE
              Run this command to report what you did:
              gh issue comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body "## âœ… Jules Implementation Complete

              ### Changes Made
              <list each file changed and what you did>

              ### Tests Added/Updated
              <list test files>

              ### Verification
              - [x] ./run_checks.sh passes
              - [x] All existing tests still pass
              - [x] New tests cover the changes

              ---
              *PR ready for review*"

            â–¡ STEP 6: CREATE THE PULL REQUEST
              - PR title should be descriptive (e.g., 'feat(sensor): add temperature sensor')
              - PR body MUST include: Closes #${{ github.event.issue.number }}
              - Target branch: beta

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            CRITICAL CONSTRAINTS:
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            âŒ DO NOT:
              - Skip running ./run_checks.sh
              - Create PRs with failing tests
              - Add features not requested in the issue
              - Refactor unrelated code
              - Use requirements.txt (use pyproject.toml)
              - Use logging.getLogger(__name__) (use MerakiLoggers)

            âœ… DO:
              - Complete ALL 6 steps above
              - Update the issue with your progress
              - Create a PR that closes the issue

            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            ESCAPE HATCH - If stuck after 2 fix attempts:
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            If ./run_checks.sh fails with the SAME error after 2 fix attempts:
            1. STOP trying to fix it yourself
            2. Commit your current progress (even if broken)
            3. Create a PR with your progress (note the PR number)
            4. Update issue with handoff context:
               gh issue comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body "## ğŸ†˜ Jules Handoff to Cursor

               ### âœ… What I Completed
               <list files changed and what you implemented>

               ### âŒ What I'm Stuck On
               <the exact error message>

               ### ğŸ”§ What I Tried
               <your fix attempts that didn't work>

               ### ğŸ“ Suggested Next Steps
               <what Cursor should try>

               ---
               *Handing off to Cursor*"
            5. Add label AND trigger handoff workflow (BOTH commands required):
               gh pr edit <PR#> --add-label "jules-needs-help" --repo ${{ github.repository }}
               gh api repos/${{ github.repository }}/dispatches --method POST -f event_type='jules-needs-help' -f client_payload[pr_number]='<PR#>' -f client_payload[branch]='<branch_name>' -f client_payload[issue_number]='${{ github.event.issue.number }}'
            6. EXIT immediately - Cursor will take over

            DO NOT keep running ./run_checks.sh hoping for different results.
