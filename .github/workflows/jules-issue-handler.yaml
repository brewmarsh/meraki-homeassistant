name: Jules Issue Handler

run-name: 'Jules: ${{ github.event.issue.title }} (#${{ github.event.issue.number }})'

# Invokes Jules to work on issues labeled with 'jules-issue'

on:
  issues:
    types:
      - labeled
      - opened

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: jules-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  handle-issue:
    if: contains(github.event.issue.labels.*.name, 'jules-issue')
    runs-on: ubuntu-latest
    steps:
      - name: Check authorization
        run: |
          SENDER="${{ github.event.sender.login }}"
          if [[ "$SENDER" == "liptonj" ]] || [[ "$SENDER" == *"[bot]" ]]; then
            echo "âœ… Authorized: $SENDER"
          else
            echo "::error::User $SENDER not authorized"
            exit 1
          fi

      - name: Start issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ðŸ¤– Jules Started

          Working on this task. Updates will follow.

          ---
          *@${{ github.event.sender.login }}*"

          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --add-label "in-progress"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: beta
          fetch-depth: 1

      - name: Invoke Jules
        uses: google-labs-code/jules-action@v1.0.0
        with:
          starting_branch: beta
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          # CRITICAL: Disable commit context to prevent bloat
          include_last_commit: false
          include_commit_log: false
          prompt: |
            You are a coding agent for a Home Assistant integration. Implement this task:

            Task: ${{ github.event.issue.title }}
            Issue: #${{ github.event.issue.number }}

            ${{ github.event.issue.body }}

            Steps:
            1. Read `AGENTS.md` for project patterns and conventions
            2. Implement the task following existing code patterns
            3. Run `./run_checks.sh` - must pass with no errors
            4. Update issue: `gh issue comment ${{ github.event.issue.number }} --body "Done: <what> | Files: <list>"`
            5. Create PR with `Closes #${{ github.event.issue.number }}` in body

            Constraints:
            - All tests must pass before creating PR
            - Follow existing code style and patterns
            - Don't add unrelated changes

            If stuck: add label `jules-needs-help` to PR and comment what you tried.
            Cursor will take over.
