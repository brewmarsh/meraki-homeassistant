name: Jules Issue Handler

run-name: 'Jules: ${{ github.event.issue.title }} (#${{ github.event.issue.number }})'

# Invokes Jules to work on issues labeled with 'jules-issue'

on:
  issues:
    types:
      - labeled
      - opened

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: jules-issue-${{ github.event.issue.number }}
  cancel-in-progress: true # Cancel duplicate runs

jobs:
  handle-issue:
    # For 'labeled' event: only trigger when 'jules-issue' label is added (not other labels)
    # For 'opened' event: check if issue has the label
    if: |
      (github.event.action == 'labeled' && github.event.label.name == 'jules-issue') ||
      (github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'jules-issue'))
    runs-on: ubuntu-latest
    steps:
      - name: Check authorization
        run: |
          SENDER="${{ github.event.sender.login }}"
          if [[ "$SENDER" == "liptonj" ]] || [[ "$SENDER" == *"[bot]" ]]; then
            echo "‚úÖ Authorized: $SENDER"
          else
            echo "::error::User $SENDER not authorized"
            exit 1
          fi

      - name: Check for existing PR
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Search for PRs that reference this issue
          EXISTING_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --search "in:body Closes #$ISSUE_NUM OR in:body Fixes #$ISSUE_NUM OR in:body Resolves #$ISSUE_NUM" \
            --json number,headRefName \
            --jq '.[0].number // empty' 2>/dev/null || echo "")

          if [[ -n "$EXISTING_PR" ]]; then
            echo "‚è≠Ô∏è PR #$EXISTING_PR already exists for issue #$ISSUE_NUM - skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "No existing PR found - proceeding"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Start issue
        if: steps.existing.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ü§ñ Jules Started

          Working on this task. Updates will follow.

          ---
          *@${{ github.event.sender.login }}*"

          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --add-label "in-progress"

      - name: Checkout
        if: steps.existing.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: beta
          fetch-depth: 1

      - name: Invoke Jules
        if: steps.existing.outputs.skip != 'true'
        uses: google-labs-code/jules-action@v1.0.0
        with:
          starting_branch: beta
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          # Disable commit context to keep prompt focused
          include_last_commit: false
          include_commit_log: false
          prompt: |
            You are a coding agent for a Home Assistant integration.

            Your plan is auto-approved - proceed immediately without waiting for human interaction.

            Task: ${{ github.event.issue.title }}
            Issue: #${{ github.event.issue.number }}

            ${{ github.event.issue.body }}

            Steps:
            1. Read issue #${{ github.event.issue.number }} comments for any prior context
            2. Read `AGENTS.md` for project patterns and conventions
            3. Implement the task following existing code patterns
            4. Run `./run_checks.sh` - must pass with no errors
            5. Update issue: `gh issue comment ${{ github.event.issue.number }} --body "Done: <what> | Files: <list>"`
            6. Create PR with `Closes #${{ github.event.issue.number }}` in body

            Constraints:
            - All tests must pass before creating PR
            - Follow existing code style and patterns
            - Don't add unrelated changes

            CRITICAL - NEVER LOOP ENDLESSLY:
            If ./run_checks.sh fails with the SAME error after 2 fix attempts:
            1. STOP trying to fix it yourself
            2. Commit your current progress (even if broken)
            3. Create a PR with your progress
            4. Update issue with handoff context:
               gh issue comment ${{ github.event.issue.number }} --body "## üÜò Jules Handoff to Cursor

               ### ‚úÖ What I Completed
               <list files changed and what you implemented>

               ### ‚ùå What I'm Stuck On
               <the exact error message>

               ### üîß What I Tried
               <your fix attempts that didn't work>

               ### üìù Suggested Next Steps
               <what Cursor should try>

               ---
               *Handing off to Cursor*"
            5. Run: gh pr edit <PR#> --add-label "jules-needs-help"
            6. EXIT immediately - Cursor will read the issue and take over

            DO NOT keep running ./run_checks.sh hoping for different results.
