name: Jules Issue Handler

run-name: 'Jules: ${{ github.event.issue.title }} (#${{ github.event.issue.number }})'

# This workflow invokes Jules to work on issues when labeled
# Based on: https://github.com/google-labs-code/jules-action

on:
  issues:
    types:
      - labeled
      - opened # For jules_task template which auto-applies labels

jobs:
  handle-jules-task:
    # Trigger when issue is created with 'jules-issue' label (from Jules task template)
    # or when 'jules-issue' label is added
    if: |
      contains(github.event.issue.labels.*.name, 'jules-issue')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      # Security: Only allow liptonj or bot accounts to trigger Jules
      - name: Check user authorization
        run: |
          SENDER="${{ github.event.sender.login }}"

          # Allow liptonj
          if [[ "$SENDER" == "liptonj" ]]; then
            echo "‚úÖ Authorized: $SENDER"
            exit 0
          fi

          # Allow bot accounts (ending in [bot])
          if [[ "$SENDER" == *"[bot]" ]]; then
            echo "‚úÖ Authorized bot: $SENDER"
            exit 0
          fi

          # Reject all others
          echo "::error::User $SENDER is not authorized to trigger Jules"
          echo "Only liptonj or bot accounts can trigger Jules."
          exit 1

      - name: Comment on issue - Jules started
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ü§ñ Jules AI Agent Assigned

          I'm starting work on this task now.

          **What's happening:**
          1. üìñ Reading project standards from \`AGENTS.md\`
          2. üîç Analyzing the requirements
          3. üíª Implementing the solution
          4. ‚úÖ Running quality checks
          5. üìù Creating a PR

          I'll update this issue when the PR is ready.

          ---
          *Triggered by @${{ github.event.sender.login }}*"

      - name: Add 'in-progress' label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --add-label "in-progress"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: beta

      - name: Invoke Jules for structured task
        id: jules
        uses: google-labs-code/jules-action@v1.0.0
        with:
          starting_branch: beta
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            You are the primary coding agent for the meraki-homeassistant project.

            ## Task Assignment
            **Title**: ${{ github.event.issue.title }}
            **Issue Number**: #${{ github.event.issue.number }}
            **URL**: ${{ github.event.issue.html_url }}

            **Task Details**:
            ${{ github.event.issue.body }}

            ## Project Context
            1. Read the `AGENTS.md` file first - it contains all project standards and conventions.
            2. Read the `ROADMAP.md` file to understand the project roadmap and requirements.
            3. This is a Home Assistant custom integration for Cisco Meraki networks.

            ## Technology Stack
            - Backend: Python 3.13, Home Assistant Core, meraki SDK, aiohttp
            - Frontend: React, TypeScript, Vite
            - Package manager: uv with pyproject.toml (never requirements.txt)
            - Tests: pytest, pytest-asyncio
            - Linting: Ruff, mypy, bandit

            ## Key Directories
            - Integration code: `custom_components/meraki_ha/`
            - Tests: `tests/`
            - Frontend: `custom_components/meraki_ha/www/`

            ## Your Task

            1. **Parse the task requirements** from the issue body:
               - Identify the milestone and specific requirements
               - Note any constraints specified
               - Understand what needs to be built or refactored

            2. **Plan your implementation**:
               - Review existing code patterns in the codebase
               - Identify files to modify or create
               - Consider edge cases and error handling

            3. **Implement the task** following project standards:
               - Use type hints for all function signatures
               - Use async/await for all I/O operations
               - Follow PEP 8 and Ruff linting rules
               - Use NumPy-style docstrings
               - Follow Home Assistant Sentence Case standards for entity names
               - Add constants to `const.py`
               - Use early returns for error conditions

            4. **Write comprehensive tests**:
               - Unit tests for all new functions
               - Place tests in `tests/` mirroring the source structure
               - Use pytest-asyncio for async tests
               - Mock external API calls (never call real Meraki API)

            5. **Verify all checks pass**:
               - `ruff check --fix . && ruff format .`
               - `mypy custom_components/meraki_ha/ tests/`
               - `pytest`
               - If frontend changes: `cd custom_components/meraki_ha/www && npm run build`

            6. **Create a PR** with:
               - Title following Conventional Commits: `feat(<scope>): <description>` or `fix(<scope>): <description>`
               - Detailed description of what was implemented
               - **IMPORTANT**: The PR body MUST contain this exact line on its own: `Closes #${{ github.event.issue.number }}`
               - Target branch: beta

            ## Constraints
            - Ignore all errors not related to the meraki_ha integration
            - Follow Home Assistant Sentence Case standards
            - All existing tests must pass
            - Maintain 95%+ test coverage
            - Keep implementation focused - don't over-engineer
            - Target branch must be `beta`

      - name: Find and link the PR to issue
        id: find_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait a moment for the PR to be created
          sleep 10

          # Find PRs that reference this issue
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --search "Closes #${{ github.event.issue.number }} in:body" \
            --json number,title,url,headRefName \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_URL=$(echo "$PR_JSON" | jq -r '.[0].url // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.[0].title // empty')
          PR_BRANCH=$(echo "$PR_JSON" | jq -r '.[0].headRefName // empty')

          if [[ -n "$PR_NUMBER" ]]; then
            echo "Found PR #$PR_NUMBER: $PR_TITLE"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
            echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
            echo "pr_branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"
            echo "pr_found=true" >> "$GITHUB_OUTPUT"
          else
            echo "No PR found yet"
            echo "pr_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on issue - PR created
        if: steps.find_pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚úÖ Jules Created a Pull Request

          **PR**: [${{ steps.find_pr.outputs.pr_title }}](${{ steps.find_pr.outputs.pr_url }})
          **Branch**: \`${{ steps.find_pr.outputs.pr_branch }}\`

          **Next Steps:**
          1. ‚è≥ CI is running quality checks
          2. ü§ñ Cursor will review the code after CI passes
          3. üìã Human review after Cursor approval

          ---
          *PR will automatically close this issue when merged*"

      - name: Update issue labels
        if: steps.find_pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --remove-label "in-progress" \
            --add-label "pr-pending"

      - name: Comment on issue - No PR found
        if: steps.find_pr.outputs.pr_found != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚ö†Ô∏è Jules Completed But No PR Found

          Jules finished working but I couldn't find a linked PR.

          **Possible reasons:**
          - Jules may still be creating the PR
          - Jules may have encountered an error
          - The PR might not have the correct issue reference

          **Next Steps:**
          - Check [open PRs](https://github.com/${{ github.repository }}/pulls) for recent activity
          - Check the [Actions log](https://github.com/${{ github.repository }}/actions) for details

          ---
          *This may resolve itself - check back in a few minutes*"

  handle-bug:
    # Trigger when 'jules' label is added to a bug
    if: |
      github.event.label.name == 'jules' &&
      contains(github.event.issue.labels.*.name, 'bug')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Check user authorization
        run: |
          SENDER="${{ github.event.sender.login }}"

          # Allow liptonj
          if [[ "$SENDER" == "liptonj" ]]; then
            echo "‚úÖ Authorized: $SENDER"
            exit 0
          fi

          # Allow bot accounts (ending in [bot])
          if [[ "$SENDER" == *"[bot]" ]]; then
            echo "‚úÖ Authorized bot: $SENDER"
            exit 0
          fi

          # Reject all others
          echo "::error::User $SENDER is not authorized to trigger Jules"
          echo "Only liptonj or bot accounts can trigger Jules."
          exit 1

      - name: Comment on issue - Jules started
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## üêõ Jules Bug Fix Agent Assigned

          I'm investigating this bug now.

          **What's happening:**
          1. üîç Analyzing the bug report
          2. üîé Locating the affected code
          3. üîß Implementing the fix
          4. ‚úÖ Adding regression tests
          5. üìù Creating a PR

          ---
          *Triggered by @${{ github.event.sender.login }}*"

      - name: Add 'in-progress' label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --add-label "in-progress"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: beta

      - name: Invoke Jules for bug fix
        uses: google-labs-code/jules-action@v1.0.0
        with:
          starting_branch: beta
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            You are a bug-fixing agent for the meraki-homeassistant project.

            ## Issue to Fix
            **Title**: ${{ github.event.issue.title }}
            **Number**: #${{ github.event.issue.number }}
            **URL**: ${{ github.event.issue.html_url }}

            **Description**:
            ${{ github.event.issue.body }}

            ## Project Context
            Read the AGENTS.md file first - it contains all project standards and conventions.

            This is a Home Assistant custom integration for Cisco Meraki networks.
            - Backend: Python 3.13, Home Assistant Core, meraki SDK
            - Frontend: React, TypeScript, Vite
            - Package manager: uv with pyproject.toml
            - Tests: pytest, pytest-asyncio

            ## Your Task

            1. **Understand the bug**: Parse the issue description to understand:
               - What component is affected
               - Steps to reproduce
               - Expected vs actual behavior

            2. **Locate the relevant code**: Use the affected component info to find:
               - Sensors: `custom_components/meraki_ha/sensor/`
               - Switches: `custom_components/meraki_ha/switch/`
               - Camera: `custom_components/meraki_ha/camera.py`
               - Frontend: `custom_components/meraki_ha/www/src/`
               - Config: `custom_components/meraki_ha/config_flow.py`, `options_flow.py`
               - API: `custom_components/meraki_ha/core/`
               - MQTT: `custom_components/meraki_ha/services/mqtt_service.py`

            3. **Fix the bug** following project standards:
               - Use type hints for all functions
               - Use async/await for I/O operations
               - Follow the "Optimistic UI with Cooldown" pattern for state changes
               - Use early returns for error conditions

            4. **Write a test** that proves the bug is fixed:
               - Place in `tests/` mirroring the source structure
               - Use pytest-asyncio for async tests
               - Mock external API calls

            5. **Verify all checks pass**:
               - `ruff check --fix . && ruff format .`
               - `mypy custom_components/meraki_ha/ tests/`
               - `pytest`

            6. **Create a PR** with:
               - Title: `fix(<scope>): <description>`
               - Description explaining the root cause and fix
               - **IMPORTANT**: The PR body MUST contain this exact line on its own: `Fixes #${{ github.event.issue.number }}`
               - Target branch: beta

            ## Constraints
            - Keep changes focused on the bug
            - All existing tests must pass
            - Maintain 95%+ test coverage
            - Follow Conventional Commits format

      - name: Find and link the PR to issue
        id: find_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 10
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --search "Fixes #${{ github.event.issue.number }} in:body" \
            --json number,title,url,headRefName \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_URL=$(echo "$PR_JSON" | jq -r '.[0].url // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.[0].title // empty')
          PR_BRANCH=$(echo "$PR_JSON" | jq -r '.[0].headRefName // empty')

          if [[ -n "$PR_NUMBER" ]]; then
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
            echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
            echo "pr_branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"
            echo "pr_found=true" >> "$GITHUB_OUTPUT"
          else
            echo "pr_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on issue - PR created
        if: steps.find_pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚úÖ Jules Created a Bug Fix PR

          **PR**: [${{ steps.find_pr.outputs.pr_title }}](${{ steps.find_pr.outputs.pr_url }})
          **Branch**: \`${{ steps.find_pr.outputs.pr_branch }}\`

          **Next Steps:**
          1. ‚è≥ CI is running quality checks
          2. ü§ñ Cursor will review the fix
          3. üìã Human verification before merge

          ---
          *PR will automatically close this issue when merged*"

      - name: Update issue labels
        if: steps.find_pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --remove-label "in-progress" \
            --add-label "pr-pending"

  handle-feature:
    # Trigger when 'jules' label is added to an enhancement
    if: |
      github.event.label.name == 'jules' &&
      contains(github.event.issue.labels.*.name, 'enhancement')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Check user authorization
        run: |
          SENDER="${{ github.event.sender.login }}"

          # Allow liptonj
          if [[ "$SENDER" == "liptonj" ]]; then
            echo "‚úÖ Authorized: $SENDER"
            exit 0
          fi

          # Allow bot accounts (ending in [bot])
          if [[ "$SENDER" == *"[bot]" ]]; then
            echo "‚úÖ Authorized bot: $SENDER"
            exit 0
          fi

          # Reject all others
          echo "::error::User $SENDER is not authorized to trigger Jules"
          echo "Only liptonj or bot accounts can trigger Jules."
          exit 1

      - name: Comment on issue - Jules started
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚ú® Jules Feature Agent Assigned

          I'm implementing this feature now.

          **What's happening:**
          1. üìñ Reading requirements
          2. üèóÔ∏è Planning implementation
          3. üíª Writing code
          4. ‚úÖ Adding tests
          5. üìù Creating a PR

          ---
          *Triggered by @${{ github.event.sender.login }}*"

      - name: Add 'in-progress' label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --add-label "in-progress"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: beta

      - name: Invoke Jules for feature implementation
        uses: google-labs-code/jules-action@v1.0.0
        with:
          starting_branch: beta
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            You are a feature implementation agent for the meraki-homeassistant project.

            ## Feature Request
            **Title**: ${{ github.event.issue.title }}
            **Number**: #${{ github.event.issue.number }}
            **URL**: ${{ github.event.issue.html_url }}

            **Description**:
            ${{ github.event.issue.body }}

            ## Project Context
            Read the AGENTS.md file first - it contains all project standards and conventions.

            This is a Home Assistant custom integration for Cisco Meraki networks.
            - Backend: Python 3.13, Home Assistant Core, meraki SDK
            - Frontend: React, TypeScript, Vite
            - Package manager: uv with pyproject.toml
            - Tests: pytest, pytest-asyncio

            ## Your Task

            1. **Understand the feature request**:
               - What problem does it solve?
               - What component is affected?
               - What's the proposed solution?

            2. **Plan the implementation**:
               - Identify files to modify or create
               - Consider edge cases
               - Check for similar existing patterns in the codebase

            3. **Implement the feature** following project standards:
               - Use type hints for all functions
               - Use async/await for I/O operations
               - Add constants to `const.py`
               - For entities: use `CoordinatorEntity`, `DeviceInfo`, proper naming
               - For frontend: React with TypeScript, CSS variables for themes

            4. **Write comprehensive tests**:
               - Unit tests for new functions
               - Integration tests if applicable
               - Mock external API calls

            5. **Verify all checks pass**:
               - `ruff check --fix . && ruff format .`
               - `mypy custom_components/meraki_ha/ tests/`
               - `pytest`
               - If frontend: `npm run build`

            6. **Create a PR** with:
               - Title: `feat(<scope>): <description>`
               - Detailed description of the implementation
               - **IMPORTANT**: The PR body MUST contain this exact line on its own: `Closes #${{ github.event.issue.number }}`
               - Target branch: beta

            ## Constraints
            - Keep implementation simple and focused
            - All existing tests must pass
            - Maintain 95%+ test coverage
            - Follow Conventional Commits format
            - Don't over-engineer - implement only what's requested

      - name: Find and link the PR to issue
        id: find_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 10
          PR_JSON=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --search "Closes #${{ github.event.issue.number }} in:body" \
            --json number,title,url,headRefName \
            --limit 1)

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number // empty')
          PR_URL=$(echo "$PR_JSON" | jq -r '.[0].url // empty')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.[0].title // empty')
          PR_BRANCH=$(echo "$PR_JSON" | jq -r '.[0].headRefName // empty')

          if [[ -n "$PR_NUMBER" ]]; then
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
            echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
            echo "pr_branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"
            echo "pr_found=true" >> "$GITHUB_OUTPUT"
          else
            echo "pr_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on issue - PR created
        if: steps.find_pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --body "## ‚úÖ Jules Created a Feature PR

          **PR**: [${{ steps.find_pr.outputs.pr_title }}](${{ steps.find_pr.outputs.pr_url }})
          **Branch**: \`${{ steps.find_pr.outputs.pr_branch }}\`

          **Next Steps:**
          1. ‚è≥ CI is running quality checks
          2. ü§ñ Cursor will review the implementation
          3. üìã Human review before merge

          ---
          *PR will automatically close this issue when merged*"

      - name: Update issue labels
        if: steps.find_pr.outputs.pr_found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --repo "${{ github.repository }}" \
            --remove-label "in-progress" \
            --add-label "pr-pending"
